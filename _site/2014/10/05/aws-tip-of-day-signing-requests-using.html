<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Tip of the day: Signing requests using IAM instance roles | Deplication</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="AWS Tip of the day: Signing requests using IAM instance roles" />
<meta name="author" content="Craig Watcham" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you are averse to having the AWS SDKs conveniently manage IAM instance role permissions and service requests (including Signature V4) then knowing that you need to include the IAM role token in the request header is quite important. This post describes the steps needed to sign an API request using an instance IAM role. It is assumed that you already have an instance launched with a role that has permission to perform the requested API action. For this example the role is going to be named ec2-ro and as the name implies it has read-only permissions on EC2 APIs. As a good starting point we will use the first GET example on this page as a working base and modify it to retrieve the instance role credentials and add the session token to the request as follows. Step 1: Retrieve the instance role credentials As per the AWS documentation, instance credentials can be retrieved from the instance metadata by performing a GET against the following URL, where &lt;role-name&gt; is the name of the instance role containing the relevant permissions: http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;role-name&gt; In our example with the role named ec2-ro the result of the request will be similar to the result below where the body of the token has been replaced with […] for brevity: $ curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro {   “Code” : “Success”,   “LastUpdated” : “2014-10-05T07:25:22Z”,   “Type” : “AWS-HMAC”,   “AccessKeyId” : “ASIXXXXXXXXXXXX”,   “SecretAccessKey” : “ABCDEFGHIJKLMNOPQRSTUVWXYZ1234”,   “Token” : “AXXXXXX//////////[…]==”,   “Expiration” : “2014-10-05T13:30:35Z” } Achieving the same in Python is pretty simple: creds = requests.get(‘http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro’) access_key = creds.json()[‘AccessKeyId’] secret_key = creds.json()[‘SecretAccessKey’] token = creds.json()[‘Token’] Which we can then use to replace access key code in the example: access_key = os.environ.get(‘AWS_ACCESS_KEY_ID’) secret_key = os.environ.get(‘AWS_SECRET_ACCESS_KEY’) Unfortunately we are not finished yet as running the new code now results in a 401 response with the following message: “AWS was not able to validate the provided access credentials” The reason for the error above is that the instance credentials require a session token to be considered valid, moving on to the next step. Step 2: Add the session token to the request headers Fixing the invalid credential error above is relatively trivial and simply involves adding the session token to the request headers with a header name of x-amz-security-token. So replacing this line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header} With the following line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header, ‘x-amz-security-token’:token} Allows the code to execute successfully. One thing to be aware of is that the instance credentials are rotated fairly frequently and the credentials will need to be refreshed after the date and time in the instance metadata Expiration field." />
<meta property="og:description" content="If you are averse to having the AWS SDKs conveniently manage IAM instance role permissions and service requests (including Signature V4) then knowing that you need to include the IAM role token in the request header is quite important. This post describes the steps needed to sign an API request using an instance IAM role. It is assumed that you already have an instance launched with a role that has permission to perform the requested API action. For this example the role is going to be named ec2-ro and as the name implies it has read-only permissions on EC2 APIs. As a good starting point we will use the first GET example on this page as a working base and modify it to retrieve the instance role credentials and add the session token to the request as follows. Step 1: Retrieve the instance role credentials As per the AWS documentation, instance credentials can be retrieved from the instance metadata by performing a GET against the following URL, where &lt;role-name&gt; is the name of the instance role containing the relevant permissions: http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;role-name&gt; In our example with the role named ec2-ro the result of the request will be similar to the result below where the body of the token has been replaced with […] for brevity: $ curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro {   “Code” : “Success”,   “LastUpdated” : “2014-10-05T07:25:22Z”,   “Type” : “AWS-HMAC”,   “AccessKeyId” : “ASIXXXXXXXXXXXX”,   “SecretAccessKey” : “ABCDEFGHIJKLMNOPQRSTUVWXYZ1234”,   “Token” : “AXXXXXX//////////[…]==”,   “Expiration” : “2014-10-05T13:30:35Z” } Achieving the same in Python is pretty simple: creds = requests.get(‘http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro’) access_key = creds.json()[‘AccessKeyId’] secret_key = creds.json()[‘SecretAccessKey’] token = creds.json()[‘Token’] Which we can then use to replace access key code in the example: access_key = os.environ.get(‘AWS_ACCESS_KEY_ID’) secret_key = os.environ.get(‘AWS_SECRET_ACCESS_KEY’) Unfortunately we are not finished yet as running the new code now results in a 401 response with the following message: “AWS was not able to validate the provided access credentials” The reason for the error above is that the instance credentials require a session token to be considered valid, moving on to the next step. Step 2: Add the session token to the request headers Fixing the invalid credential error above is relatively trivial and simply involves adding the session token to the request headers with a header name of x-amz-security-token. So replacing this line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header} With the following line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header, ‘x-amz-security-token’:token} Allows the code to execute successfully. One thing to be aware of is that the instance credentials are rotated fairly frequently and the credentials will need to be refreshed after the date and time in the instance metadata Expiration field." />
<link rel="canonical" href="http://localhost:4000/2014/10/05/aws-tip-of-day-signing-requests-using.html" />
<meta property="og:url" content="http://localhost:4000/2014/10/05/aws-tip-of-day-signing-requests-using.html" />
<meta property="og:site_name" content="Deplication" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-10-05T09:11:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS Tip of the day: Signing requests using IAM instance roles" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Craig Watcham"},"dateModified":"2014-10-05T09:11:00+01:00","datePublished":"2014-10-05T09:11:00+01:00","description":"If you are averse to having the AWS SDKs conveniently manage IAM instance role permissions and service requests (including Signature V4) then knowing that you need to include the IAM role token in the request header is quite important. This post describes the steps needed to sign an API request using an instance IAM role. It is assumed that you already have an instance launched with a role that has permission to perform the requested API action. For this example the role is going to be named ec2-ro and as the name implies it has read-only permissions on EC2 APIs. As a good starting point we will use the first GET example on this page as a working base and modify it to retrieve the instance role credentials and add the session token to the request as follows. Step 1: Retrieve the instance role credentials As per the AWS documentation, instance credentials can be retrieved from the instance metadata by performing a GET against the following URL, where &lt;role-name&gt; is the name of the instance role containing the relevant permissions: http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;role-name&gt; In our example with the role named ec2-ro the result of the request will be similar to the result below where the body of the token has been replaced with […] for brevity: $ curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro {   “Code” : “Success”,   “LastUpdated” : “2014-10-05T07:25:22Z”,   “Type” : “AWS-HMAC”,   “AccessKeyId” : “ASIXXXXXXXXXXXX”,   “SecretAccessKey” : “ABCDEFGHIJKLMNOPQRSTUVWXYZ1234”,   “Token” : “AXXXXXX//////////[…]==”,   “Expiration” : “2014-10-05T13:30:35Z” } Achieving the same in Python is pretty simple: creds = requests.get(‘http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro’) access_key = creds.json()[‘AccessKeyId’] secret_key = creds.json()[‘SecretAccessKey’] token = creds.json()[‘Token’] Which we can then use to replace access key code in the example: access_key = os.environ.get(‘AWS_ACCESS_KEY_ID’) secret_key = os.environ.get(‘AWS_SECRET_ACCESS_KEY’) Unfortunately we are not finished yet as running the new code now results in a 401 response with the following message: “AWS was not able to validate the provided access credentials” The reason for the error above is that the instance credentials require a session token to be considered valid, moving on to the next step. Step 2: Add the session token to the request headers Fixing the invalid credential error above is relatively trivial and simply involves adding the session token to the request headers with a header name of x-amz-security-token. So replacing this line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header} With the following line: headers = {‘x-amz-date’:amzdate, ‘Authorization’:authorization_header, ‘x-amz-security-token’:token} Allows the code to execute successfully. One thing to be aware of is that the instance credentials are rotated fairly frequently and the credentials will need to be refreshed after the date and time in the instance metadata Expiration field.","headline":"AWS Tip of the day: Signing requests using IAM instance roles","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2014/10/05/aws-tip-of-day-signing-requests-using.html"},"url":"http://localhost:4000/2014/10/05/aws-tip-of-day-signing-requests-using.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Deplication" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Deplication</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AWS Tip of the day: Signing requests using IAM instance roles</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-10-05T09:11:00+01:00" itemprop="datePublished">Oct 5, 2014
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Craig Watcham</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    If you are averse to having the AWS SDKs conveniently manage&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html" target="_blank">IAM instance role</a>&nbsp;permissions and service requests (including&nbsp;<a href="http://docs.aws.amazon.com/general/latest/gr/signature-version-4.html" target="_blank">Signature V4</a>) then knowing that you need to include the IAM role token in the request header is quite important. This post describes the steps needed to sign an API request using an instance IAM role. It is assumed that you already have an instance launched with a role that has permission to perform the requested API action. For this example the role is going to be named ec2-ro and as the name implies it has read-only permissions on EC2 APIs.<br />
<br />
As a good starting point we will use the first GET example on&nbsp;<a href="http://docs.aws.amazon.com/general/latest/gr/sigv4-signed-request-examples.html" target="_blank">this</a>&nbsp;page as a working base and modify it to retrieve the instance role credentials and add the session token to the request as follows.<br />
<br />
<h4>
Step 1: Retrieve the instance role credentials</h4>
As per the AWS&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials" target="_blank">documentation</a>,&nbsp;instance credentials can be retrieved from the instance metadata by performing a GET against the following URL, where &lt;role-name&gt; is the name of the instance role containing the relevant permissions:<br />
<br />
http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;role-name&gt;<br />
<br />
In our example with the role named ec2-ro the result of the request will be similar to the result below where the body of the token has been replaced with [...] for brevity:<br />
<br />
$ curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro<br />
{<br />
&nbsp; "Code" : "Success",<br />
&nbsp; "LastUpdated" : "2014-10-05T07:25:22Z",<br />
&nbsp; "Type" : "AWS-HMAC",<br />
&nbsp; "AccessKeyId" : "ASIXXXXXXXXXXXX",<br />
&nbsp; "SecretAccessKey" : "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234",<br />
&nbsp; "Token" : "AXXXXXX//////////[...]==",<br />
&nbsp; "Expiration" : "2014-10-05T13:30:35Z"<br />
}<br />
<br />
Achieving the same in Python is pretty simple:<br />
<br />
creds = requests.get('http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro')<br />
access_key = creds.json()['AccessKeyId']<br />
secret_key = creds.json()['SecretAccessKey']<br />
token = creds.json()['Token']<br />
<div>
<br /></div>
Which we can then use to replace access key code in the example:<br />
<br />
access_key = os.environ.get('AWS_ACCESS_KEY_ID')<br />
secret_key = os.environ.get('AWS_SECRET_ACCESS_KEY')<br />
<br />
Unfortunately we are not finished yet as running the new code now results in a 401 response with the following message:<br />
<br />
"AWS was not able to validate the provided access credentials"<br />
<br />
The reason for the error above is that the instance credentials require a session token to be considered valid, moving on to the next step.<br />
<br />
<h4>
Step 2: Add the session token to the request headers</h4>
Fixing the invalid credential error above is relatively trivial and simply involves adding the session token to the request headers with a header name of x-amz-security-token. So replacing this line:<br />
<br />
headers = {'x-amz-date':amzdate, 'Authorization':authorization_header}<br />
<br />
With the following line:<br />
<br />
<span id="caseCorrespondence_27425114255_text">headers = {'x-amz-date':amzdate, 'Authorization':authorization_header, 'x-amz-security-token':token}</span><br />
<span><br /></span>
<span>Allows the code to execute successfully.&nbsp;</span>One thing to be aware of is that the instance credentials are rotated fairly frequently and the credentials will need to be refreshed after the date and time in the instance metadata Expiration field.
  </div><a class="u-url" href="/2014/10/05/aws-tip-of-day-signing-requests-using.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Deplication</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Deplication</li><li><a class="u-email" href="mailto:craig@deplication.net">craig@deplication.net</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/watchamcb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">watchamcb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Simpler is better.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
