<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress | Deplication</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress" />
<meta name="author" content="Craig Watcham" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was recently working with a customer on an issue that highlighted a poorly explained side effect of the reversibility of lifecycle actions. The purpose of this post is to explain this behaviour with the hope that it will save S3 customers unexpected costs. TLDR: S3 CloudWatch metrics don&#39;t accurately display metrics about lifecycle actions that are still in progress." />
<meta property="og:description" content="I was recently working with a customer on an issue that highlighted a poorly explained side effect of the reversibility of lifecycle actions. The purpose of this post is to explain this behaviour with the hope that it will save S3 customers unexpected costs. TLDR: S3 CloudWatch metrics don&#39;t accurately display metrics about lifecycle actions that are still in progress." />
<link rel="canonical" href="http://localhost:4000/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html" />
<meta property="og:url" content="http://localhost:4000/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html" />
<meta property="og:site_name" content="Deplication" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-07T12:56:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Craig Watcham"},"dateModified":"2019-09-07T12:56:00+01:00","datePublished":"2019-09-07T12:56:00+01:00","description":"I was recently working with a customer on an issue that highlighted a poorly explained side effect of the reversibility of lifecycle actions. The purpose of this post is to explain this behaviour with the hope that it will save S3 customers unexpected costs. TLDR: S3 CloudWatch metrics don&#39;t accurately display metrics about lifecycle actions that are still in progress.","headline":"AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html"},"url":"http://localhost:4000/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Deplication" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Deplication</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress</h1>
    <p class="post-meta"><time class="dt-published" datetime="2019-09-07T12:56:00+01:00" itemprop="datePublished">
        Sep 7, 2019
      </time>â€¢ 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Craig Watcham</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I was recently working with a customer on an issue that highlighted a poorly explained side effect of the reversibility of lifecycle actions. The purpose of this post is to explain this behaviour with the hope that it will save S3 customers unexpected costs. TLDR: S3 CloudWatch metrics don't accurately display metrics about lifecycle actions that are still in progress.</p>

The customer use case was fairly simple, they had a bucket with a large amount of data that needed to be deleted. They added a <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/intro-lifecycle-rules.html#intro-lifecycle-rules-actions">lifecycle expiration action</a> to the bucket and the following day noticed that the CloudWatch bucket size metric showed the bucket size to have reduced by the expected amount. An example of how this looks in CloudWatch is below, this graph is a reproduction in my own account, the customer had a significantly larger amount of data to delete (petabytes rather than terabytes):<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk1PVB1gYCpJbcVqjEVr83jdZ_ILHPb5BeSvgjmoG6b6bs2EeqgLdwrkoqRYIjiLe-lVs9ffabtTWfpq26GKB_U0GTsprZBPI3Pd4XR2pykEr8KZl5_b9l-4dPXDr0H5zaUoYMxdjojSA/s1600/mistaken.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="495" data-original-width="493" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk1PVB1gYCpJbcVqjEVr83jdZ_ILHPb5BeSvgjmoG6b6bs2EeqgLdwrkoqRYIjiLe-lVs9ffabtTWfpq26GKB_U0GTsprZBPI3Pd4XR2pykEr8KZl5_b9l-4dPXDr0H5zaUoYMxdjojSA/s320/mistaken.png" width="318" /></a></div>
<br />
The customer assumed (logically) that the drop in the graph meant that the lifecycle action had completed and they removed the expiration lifecycle action. A couple of weeks later the customer's finance team noticed that their S3 storage costs had not reduced despite the engineering team telling them to expect a significant decrease. Looking at the relevant bucket the CloudWatch graph showed that the bucket size reduction had been reverted and most of the supposedly deleted data was still present. Example graph:<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbicCXItjfs768KBURlA5GYrfZIpJPZBBrlXazNezP6e9et0aj0P-fh1UhgYSFsIILna1z_JGC1KTdWy4vimQZn9YK6yVoCmIFzETu41Ae1ABrWhJ-ooVckgN7FHFlmRsX2d8SGX_6Y7I/s1600/bounce.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="487" data-original-width="462" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbicCXItjfs768KBURlA5GYrfZIpJPZBBrlXazNezP6e9et0aj0P-fh1UhgYSFsIILna1z_JGC1KTdWy4vimQZn9YK6yVoCmIFzETu41Ae1ABrWhJ-ooVckgN7FHFlmRsX2d8SGX_6Y7I/s320/bounce.png" width="303" /></a></div>
<div class="separator" style="clear: both; text-align: center;">
</div>
<br />
After investigating with the customer it became clear that this was an unintended consequence of the way S3 lifecycle actions are <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/how-to-set-lifecycle-configuration-intro.html">implemented</a>, specifically that:<br />
<br />
"When you disable or delete a lifecycle rule, after a small delay Amazon S3 stops scheduling new objects for deletion or transition. Any objects that were already scheduled will be unscheduled and they won't be deleted or transitioned."<br />
<br />
The documentation unfortunately neglects to mention that the CloudWatch bucket metrics will update immediately even when the lifecycle action has not actually completed processing. There is currently no way to view progress on the lifecycle action and in this case it took the better part of 2 weeks for the action to complete. This was a fairly expensive lesson for the customer as S3 was 'operating as designed' and the customer was charged for the data storage costs from the time they removed the lifecycle action until they added it back when they noticed the issue.<br />
<br />
Takeaways to help avoid this problem:<br />
1. Lifecycle actions can take a long time to complete, potentially weeks for large (petabyte) volumes of data.<br />
2. Don't used CloudWatch bucket metrics as an indicator of lifecycle action progress or completion.<br />
3. After removing or disabling a lifecycle action make sure you check the CloudWatch metrics the next day or two to confirm there is no unexpected reversion of the action.<br />
4. You will be charged for data costs if the removal of the lifecycle action results in the action being reverted for some objects.
  </div><a class="u-url" href="/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
                11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
                13.806c0-1.21.983-2.195 2.194-2.195zM10.606
                16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
              />
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Simpler is better.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
