<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deplication | Simpler is better.</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Deplication" />
<meta name="author" content="GitHub User" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Simpler is better." />
<meta property="og:description" content="Simpler is better." />
<link rel="canonical" href="http://localhost:4000/" />
<meta property="og:url" content="http://localhost:4000/" />
<meta property="og:site_name" content="Deplication" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deplication" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","author":{"@type":"Person","name":"GitHub User"},"description":"Simpler is better.","headline":"Deplication","name":"Deplication","url":"http://localhost:4000/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Deplication" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Deplication</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home"><p>In progress migration from Blogger, please excuse the chaos.</p>



  <ul class="post-list"><li>
        <span class="post-meta">Aug 8, 2021</span>
        <h3>
          <a class="post-link" href="/2021/08/08/reducing-vpc-interface-endpoint-costs.html">
            Reducing VPC interface endpoint costs in dev/test environments
          </a>
        </h3><p>Two quick tips for potentially reducing VPC interface endpoint costs.</p>
</li><li>
        <span class="post-meta">Jul 1, 2021</span>
        <h3>
          <a class="post-link" href="/2021/07/01/checking-regional-service-availability.html">
            Checking regional service availability with the AWS CLI
          </a>
        </h3><p>Using <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-public-parameters-global-infrastructure.html">System Manager public parameters</a> a quick CLI one liner for checking if an AWS service is available in a region:</p>

</li><li>
        <span class="post-meta">Sep 7, 2019</span>
        <h3>
          <a class="post-link" href="/2019/09/07/aws-in-weeds-s3-cloudwatch-metrics-and.html">
            AWS in the weeds - S3 CloudWatch metrics and lifecycle actions that are in progress
          </a>
        </h3><p>I was recently working with a customer on an issue that highlighted a poorly explained side effect of the reversibility of lifecycle actions. The purpose of this post is to explain this behaviour with the hope that it will save S3 customers unexpected costs. TLDR: S3 CloudWatch metrics don't accurately display metrics about lifecycle actions that are still in progress.</p></li><li>
        <span class="post-meta">Feb 16, 2019</span>
        <h3>
          <a class="post-link" href="/2019/02/16/aws-tip-wildcard-characters-in-s3.html">
            AWS tip: Wildcard characters in S3 lifecycle policy prefixes
          </a>
        </h3>A quick word of warning regarding S3's treatment of asterisks (*) in object&nbsp;<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/object-lifecycle-mgmt.html">lifecycle policies</a>. In S3 asterisks are valid <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html#object-keys">'special' characters</a>&nbsp;and can be used in object key names, this can lead to a lifecycle action not being applied as expected when the prefix contains an asterisk.<br />
<br />
Historically an asterisk is treated as a wildcard to pattern match 'any', so you would be able to conveniently match all files for a certain pattern: 'rm *' as an example, would delete all files. This is NOT how an asterisk behaves in S3 lifecycle prefixes. If you specify a prefix of '*' or '/*' it will only be applied to objects that start with an asterisk and not all objects. The '*' prefix rule would be applied to these objects:<br />
example-bucket/*/key<br />
example-bucket/*yek<br />
<br />
But would not be applied to:<br />
example-bucket/object<br />
example-bucket/directory/key<br />
example-bucket/tcejbo*<br />
<br />
It is not an error to specify an asterisk and it will merely result in the policy not being applied so you may not even know this as an issue. Fortunately it is fairly easy to check for this configuration with the CLI, the following bash one liner will iterate through all buckets owned by the caller and check if the bucket has any policies with an asterisk in their name. It will print out the bucket name and policy if affected or a '.' (to show progress) if not.<br />
<br />
<script src="https://gist.github.com/watchamcb/bc99754981bc68b5c398829ca51b72be.js"></script></li><li>
        <span class="post-meta">Oct 14, 2018</span>
        <h3>
          <a class="post-link" href="/2018/10/14/finding-s3-api-requests-from-previous.html">
            Finding S3 API requests from previous versions of the AWS CLI and SDKs
          </a>
        </h3><div class="separator" style="clear: both; text-align: center;">
</div>
<h3>
Introduction</h3>
Earlier this year the S3 team <span class="MsoHyperlink"><a href="https://forums.aws.amazon.com/ann.jspa?annID=5816">announced</a></span>
that S3 will stop accepting API requests <span class="MsoHyperlink"><a href="https://docs.aws.amazon.com/general/latest/gr/signing_aws_api_requests.html">signed</a></span>
using AWS Signature Version 2 after June 24th, 2019. Customers will need to
update their SDKs, CLIs, and custom implementations to make use of <span class="MsoHyperlink"><a href="https://docs.aws.amazon.com/general/latest/gr/sigv4_changes.html">AWS
Signature Version 4</a></span> to avoid impact after this date. It might be
difficult to find older applications or instances using outdated versions of
the AWS CLI or SDKs that need to be updated, the purpose of this post is to
explain how AWS CloudTrail <span class="MsoHyperlink"><a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-management-and-data-events-with-cloudtrail.html#logging-data-events">data
events</a></span> and Amazon Athena can be used to help identify applications
that may need to be updated. We will cover the setup of the CloudTrail data
events, the Athena table creation, and some Athena queries to filter and refine
the results to help with this process.<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
</div>
<h3>
Update (January/February 2019)</h3>
<div>
S3 <a href="https://forums.aws.amazon.com/ann.jspa?annID=6551">recently added</a> a&nbsp;SignatureVersion item to the AdditionalEventData field in the S3 data events, this significantly simplifies the process of finding clients using SigV2. The SQL queries below have been updated to exclude events with a SigV4 signature (additionaleventdata NOT LIKE '%SigV4%'). You can equally search for only '%SigV2%' and skip the CLI version string munging entirely.</div>
<div>
<br /></div>
<div class="MsoNormal">
<o:p></o:p></div>
<h3>
Setting up CloudTrail data events in the AWS console</h3>
<h1>
<o:p></o:p></h1>
<div class="MsoNormal">
The first step is to create a trail to capture S3 data
events. This should be done in the region you plan on running your Athena
queries in order to avoid unnecessary data transfer charges. In the CloudTrail console
for the region, create a new trail specifying the trail name. The ‘Apply trail
to all regions’ option should be left as ‘Yes’ unless you plan on running
separate analyses for each region. Given that we are creating a data events
trail, select ‘None’ under the Management Events section and check the “Select
all S3 buckets in your account” checkbox. Finally select the S3 location where
the CloudTrail data will be written, we will create new bucket for simplicity:<o:p></o:p><br />
<br /></div>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicqyJR3bVMAK9WZJje_DhhmUibchHe63cewImTcKtavLOQW9aEkJN460Xch5-hsycJJ6aHf00MwxKFwa0muLfbn5F5ElogevzGe_D_V6T0hxaSIDyhlxnoveNfaybNKLi3bD9MbNiToOU/s1600/create_trail.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="873" data-original-width="1128" height="494" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicqyJR3bVMAK9WZJje_DhhmUibchHe63cewImTcKtavLOQW9aEkJN460Xch5-hsycJJ6aHf00MwxKFwa0muLfbn5F5ElogevzGe_D_V6T0hxaSIDyhlxnoveNfaybNKLi3bD9MbNiToOU/s640/create_trail.png" width="640" /></a></div>
<br />
<div class="MsoNormal">
<br /></div>
<h3>
Setting up CloudTrail data events using the AWS CLI</h3>
<h1>
<o:p></o:p></h1>
<div class="MsoNormal">
If you prefer to create the trail using the AWS CLI then you
can use the <span class="MsoHyperlink"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudtrail/create-subscription.html">create-subscription</a></span>
command to create the S3 bucket and trail with the correct permissions,
updating it to be a global trail and then adding the S3 data event
configuration:<o:p></o:p></div>
<script src="https://gist.github.com/watchamcb/6afc2efe1e6b287d4007c17e696cfc1c.js"></script></li><li>
        <span class="post-meta">Aug 25, 2018</span>
        <h3>
          <a class="post-link" href="/2018/08/25/aws-s3-event-aggregation-with-lambda.html">
            AWS S3 event aggregation with Lambda and DynamoDB
          </a>
        </h3><h4>
Introduction</h4>
S3 has had <a href="https://aws.amazon.com/blogs/aws/s3-event-notification/">event notifications</a> since 2014 and for <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-s3.html">individual object notifications</a>&nbsp;these events work well with Lambda, allowing you to perform an action on every object event in a bucket. It is harder to use this approach when you want to perform an action a limited number of times or at an aggregated bucket level. An example use case would be refreshing a dependency (like <a href="https://docs.aws.amazon.com/storagegateway/latest/userguide/managing-gateway-file.html#refresh-cache">Storage Gateway RefreshCache</a>) when you are expecting a large number of objects events in a bucket. Performing a relatively expensive action for every event is not practical or efficient in this case. This post provides a solution for aggregating these events using Lambda, DynamoDB, and SQS.<div><br /><h4 style="text-align: left;">Update (June/July 2020)</h4><div>Cache refresh can now be <a href="https://aws.amazon.com/blogs/storage/automating-cache-refresh-process-for-file-gateway-on-aws-storage-gateway/">automated</a>. The event aggregation approach below may still be useful depending on your requirements.</div><h4><br /></h4><h4>
The problem</h4>
<div>
We want to call RefreshCache on our Storage Gateway (SGW) whenever the contents of the S3 bucket it exposes are updated by an external process. If the external process is updating a large number of (small) S3 objects then a large number of S3 events will be triggered. We don't want to overload our SGW with refresh requests so we need a way to aggregate these events to only send occasional refresh requests.</div>
<div>
<br /></div>
<h4>
The solution</h4>
The solution is fairly simple and uses DynamoDB's <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.ConditionalUpdate">Conditional Writes</a>&nbsp;for synchronisation and SQS <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-message-timers.html">Message Timers</a>&nbsp;to enable aggregation. When the Lambda function processes a new object event it first checks to see if the event falls within the window of the currently active refresh request. If the event is within the window it will automatically be included when the refresh executes and the event can be ignored. If the event occurred after the last refresh then a new refresh request is sent to an SQS queue with a message timer equal to the refresh window period. This allows for all messages received within a refresh window to be included in a single refresh operation.<br />
<br />
<h4>
Implementation</h4>
<div>
At a high level we need to create resources (SQS queue, DynamoDB table, Lambda functions), set up permissions (create and assign IAM roles), and apply some configuration (linking Lambda to S3 event notification and SQS queues). This implementation really belongs in a CloudFormation template (and I may actually create one) but I was interested to try and do this entirely via the AWS CLI, masochistic as that may be. If you are not interested in the gory implementation details then skip ahead to 'Creation and deletion script' section<br />
<br />
<script src="https://github.com/watchamcb/s3-event-aggregator/blob/f324ca33e18d0dcc7dd45e1294d0b2aeadb03b7b/iam/dynamo-writer.json#L1"> </script></li><li>
        <span class="post-meta">May 18, 2018</span>
        <h3>
          <a class="post-link" href="/2018/05/18/working-with-20-node-elasticache.html">
            Working with 20+ node ElastiCache Memcached clusters
          </a>
        </h3>ElastiCache Memcached <a href="https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html#limits_elasticache">limits</a> the number of nodes in a cluster to 20 by default. This limit can be <a href="https://aws.amazon.com/contact-us/elasticache-node-limit-request/">increased</a>&nbsp;with ElastiCache recommending against clusters larger than 50 nodes.<br />
<br />
The increased cluster node limits don't reflect in the console so even after the limit has been increased the maximum number of nodes you can select when creating a new cluster is 20. Fortunately the CLI allows you to work around this and you can tweak the examples in the ElastiCache cluster creation documentation to achieve your desired outcome. Creating a cluster with more than 20 nodes using the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/Clusters.Create.CLI.html">CLI</a>:<br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span>
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">$ aws elasticache create-cache-cluster --cache-cluster-id my-super-cluster --cache-node-type cache.t2.micro --engine memcached --engine-version 1.4.34 --cache-parameter-group default.memcached1.4 --num-cache-nodes 30</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">{</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "CacheCluster": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterId": "my-super-cluster",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "ClientDownloadLandingPage": "https://console.aws.amazon.com/elasticache/home#client-download:",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeType": "cache.t2.micro",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "Engine": "memcached",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "EngineVersion": "1.4.34",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterStatus": "creating",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "NumCacheNodes": 30,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PreferredMaintenanceWindow": "mon:02:30-mon:03:30",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PendingModifiedValues": {},</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSecurityGroups": [],</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroup": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroupName": "default.memcached1.4",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ParameterApplyStatus": "in-sync",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeIdsToReboot": []</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSubnetGroupName": "default",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AutoMinorVersionUpgrade": true,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "TransitEncryptionEnabled": false,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AtRestEncryptionEnabled": false</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">}</span><br />
<div>
<br /></div>
<div>
Adding nodes can be done via the console as it allows you to specify the number of nodes rather than selecting from a drop down. For completeness this can also be done via the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/Clusters.AddNode.html#Clusters.AddNode.CLI">CLI</a>:</div>
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">$ aws elasticache modify-cache-cluster --cache-cluster-id test-limits --num-cache-nodes 26 --apply-immediately</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">{</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "CacheCluster": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterId": "test-limits",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "ConfigurationEndpoint": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Address": "test-limits.rftr8g.cfg.euw1.cache.amazonaws.com",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Port": 11211</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "ClientDownloadLandingPage": "https://console.aws.amazon.com/elasticache/home#client-download:",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeType": "cache.t2.micro",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "Engine": "memcached",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "EngineVersion": "1.4.34",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterStatus": "modifying",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "NumCacheNodes": 6,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PreferredAvailabilityZone": "Multiple",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterCreateTime": "2018-05-18T07:10:22.530Z",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PreferredMaintenanceWindow": "sat:23:30-sun:00:30",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PendingModifiedValues": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "NumCacheNodes": 26</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSecurityGroups": [],</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroup": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroupName": "default.memcached1.4",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ParameterApplyStatus": "in-sync",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeIdsToReboot": []</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSubnetGroupName": "default",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AutoMinorVersionUpgrade": true,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "SecurityGroups": [</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SecurityGroupId": "sg-5814fd37",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Status": "active"</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; ],</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "TransitEncryptionEnabled": false,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AtRestEncryptionEnabled": false</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">}</span><br />
<div>
<br /></div>
<br />
And finally <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/Clusters.DeleteNode.html#Clusters.DeleteNode.CLI">removing nodes</a>&nbsp;via the CLI (note the spaces rather than commas between the node IDs):<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">$ aws elasticache modify-cache-cluster --cache-cluster-id test-limits --num-cache-nodes 6 --cache-node-ids-to-remove 0007 0008 0009 0010 0011 0012 0013 0014 0015 0016 0017 0018 0019 0020 0021 0022 0023 0024 0025 0026 --apply-immediately &nbsp;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">{</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "CacheCluster": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterId": "test-limits",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "ConfigurationEndpoint": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Address": "test-limits.rftr8g.cfg.euw1.cache.amazonaws.com",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Port": 11211</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "ClientDownloadLandingPage": "https://console.aws.amazon.com/elasticache/home#client-download:",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeType": "cache.t2.micro",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "Engine": "memcached",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "EngineVersion": "1.4.34",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterStatus": "modifying",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "NumCacheNodes": 26,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PreferredAvailabilityZone": "Multiple",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheClusterCreateTime": "2018-05-18T07:10:22.530Z",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PreferredMaintenanceWindow": "sat:23:30-sun:00:30",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "PendingModifiedValues": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "NumCacheNodes": 6,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeIdsToRemove": [</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0007",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0008",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0009",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0010",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0011",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0012",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0013",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0014",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0015",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0016",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0017",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0018",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0019",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0020",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0021",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0022",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0023",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0024",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0025",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "0026"</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSecurityGroups": [],</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroup": {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheParameterGroupName": "default.memcached1.4",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ParameterApplyStatus": "in-sync",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CacheNodeIdsToReboot": []</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "CacheSubnetGroupName": "default",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AutoMinorVersionUpgrade": true,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "SecurityGroups": [</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SecurityGroupId": "sg-5814fd37",</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Status": "active"</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; ],</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "TransitEncryptionEnabled": false,</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; "AtRestEncryptionEnabled": false</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">}</span><br />
<div>
<br /></div>
</li><li>
        <span class="post-meta">Nov 16, 2017</span>
        <h3>
          <a class="post-link" href="/2017/11/16/extracting-s3-bucket-sizes-using-aws-cli.html">
            Extracting S3 bucket sizes using the AWS CLI
          </a>
        </h3>A quick one liner for printing out the size (in bytes) of S3 StandardStorage buckets in your account (using bash):<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: xx-small;"><br /></span>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">for name in $(aws s3api list-buckets --query 'Buckets[*].Name' --output text); do size=$(aws cloudwatch get-metric-statistics --namespace AWS/S3 --metric-name BucketSizeBytes --start-time $(date --date="yesterday" +%Y-%m-%d) --end-time $(date +%Y-%m-%d) --period 86400 --statistics Maximum --dimensions Name=BucketName,Value=$name Name=StorageType,Value=StandardStorage --query 'Datapoints[0].Maximum' | sed 's/null/0.0/' | cut -d. -f1); echo "$name,$size"; done</span><br />
<div>
<br /></div>
<div>
<br /></div>
<div>
Some of the individual components may be independently useful, starting off with listing buckets:</div>
<div>
<br /></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">aws s3api list-buckets --query 'Buckets[*].Name' --output text</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span></div>
<span style="font-family: inherit;">Pretty straight forward, uses the <a href="http://docs.aws.amazon.com/cli/latest/reference/s3api/index.html">s3api</a>&nbsp;in the CLI to list buckets returning only their names in text format.</span><br />
<span style="font-family: inherit;"><br /></span>
<br />
To get the bucket sizes we are actually querying CloudWatch (using <a href="http://docs.aws.amazon.com/cli/latest/reference/cloudwatch/get-metric-statistics.html">get-metric-statistics</a>) which provides bucket size and object count <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/s3-metricscollected.html">metrics for S3</a>:<br />
<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">aws cloudwatch get-metric-statistics --namespace AWS/S3 --metric-name BucketSizeBytes --start-time $(date --date="yesterday" +%Y-%m-%d) --end-time $(date +%Y-%m-%d) --period 86400 --statistics Maximum --dimensions Name=BucketName,Value=$name Name=StorageType,Value=StandardStorage --query 'Datapoints[0].Maximum' | sed 's/null/0.0/' | cut -d. -f1</span><br />
<br />
Most of this is fairly straight forward some of the parameters worth explaining further:<br />
--start-time: we are setting the start date to yesterday and formatting it in yyyy-mm-dd format, this ensures we get at least one data point containing the bucket size<br />
--period: 86400 = 1 day as the bucket size metric is only published once a day (at 00:00:00)<br />
--query: we are only interested in the the actual value for one of the metric datapoints<br />
<br />
The sed and cut commands are just to clean up formatting, if the bucket is empty the CloudWatch metric request will return null so we replace null with 0.0. The bucket size metric value will always end in .0 so we truncate it using cut (yes there are other ways of doing this).<br />
<br />
If you are only wanting to check the size of a single bucket or the bucket size on a specific date you can use a simpler version:<br />
<br class="Apple-interchange-newline" />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">aws cloudwatch get-metric-statistics --namespace AWS/S3 --metric-name BucketSizeBytes --start-time 2017-11-15 --end-time 2017-11-16 --period 86400 --statistics Maximum --dimensions Name=BucketName,Value=MY_BUCKET_NAME Name=StorageType,Value=StandardStorage --query 'Datapoints[0].Maximum'</span></li><li>
        <span class="post-meta">Aug 20, 2017</span>
        <h3>
          <a class="post-link" href="/2017/08/20/understanding-ec2-up-to-10-gigabit.html">
            Understanding EC2 &quot;Up to 10 Gigabit&quot; network performance for R4 instances
          </a>
        </h3><span style="background-color: white; font-size: 16px;">This post investigates the network performance of AWS R4 instances with a focus on the "Up to 10 Gigabit" networking expected from smaller (r4.large - r4.4xlarge) instance types.&nbsp;Before starting it should be noted that this post is based on observation and as such is prone to imprecision and variance, it is intended as a guide for what can be expected and not a comprehensive or scientific review.<br />
</span><br />
<span style="background-color: white; font-size: 16px;"><br /></span><span style="background-color: white; font-size: 16px;">
The R4 instance&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/memory-optimized-instances.html#memory-instances-hardware">documentation</a>&nbsp;states "The smaller R4 instance sizes offer peak throughput of 10 Gbps. These instances use a network I/O credit mechanism to allocate network bandwidth to instances based on average bandwidth utilization. These instances accrue credits when their network throughput is below their baseline limits, and can use these credits when they perform network data transfers." This is not particularly helpful in understanding the lower bounds on network performance and gives no indication of the baseline limits with AWS recommending customers&nbsp;<a href="https://aws.amazon.com/premiumsupport/knowledge-center/network-throughput-benchmark-linux-ec2/">benchmark</a>&nbsp;the networking performance of various instances to evaluate whether the instance type and size will meet the application network performance requirements.</span><span style="background-color: white; font-size: 16px;"><br /></span><span style="background-color: white; font-size: 16px;">
Logically we would expect the r4.large to have a fraction of the total 20 Gbps available on an r4.16xlarge. From the instance size normalisation table under the&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ri-modifying.html#ri-modification-instancemove">reserved instance modification documentation</a>&nbsp;a *.large instance (factor of 4) should expect 1/32 of the resources available on a *.16xlarge instance (factor of 128) which works out at 0.625 Gbps (20 Gbps / 32) or 625 Mbps.</span><br />
<br />
<h4>
<br class="Apple-interchange-newline" /><span style="background-color: white; font-size: 16px;">Testing r4.large baseline network performance</span></h4>
<div>
<span style="background-color: white; font-size: 16px;">
Using iperf3 between two newly launched Amazon Linux r4.large instances in the same availability zone in eu-west-1, we run into the first interesting anomaly with the network stream maxing out at 5 Gbps rather than the expected 10 Gbps:<br />
</span>
<br />
<span style="background-color: white; font-size: 16px;"><br /></span></div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$ iperf3 -p 5201 -c 172.31.7.67 -i 1 -t 3600 -f m -V&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">iperf 3-CURRENT</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Linux ip-172-31-10-235 4.9.32-15.41.amzn1.x86_64 #1 SMP Thu Jun 22 06:20:54 UTC 2017 x86_64</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Control connection MSS 8949</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Time: Sun, 20 Aug 2017 07:35:48 GMT</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Connecting to host 172.31.7.67, port 5201</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; Cookie: p2v6ry2kzjo2udittrzgmxotz7we3in5etmv</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; TCP MSS: 8949 (default)</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] local 172.31.10.235 port 41270 connected to 172.31.7.67 port 5201</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Starting Test: protocol: TCP, 1 streams, 131072 byte blocks, omitting 0 seconds, 3600 second test, tos 0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ ID] Interval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bitrate &nbsp; &nbsp; &nbsp; &nbsp; Retr &nbsp;Cwnd</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 0.00-1.00 &nbsp; sec &nbsp; 598 MBytes &nbsp;5015 Mbits/sec &nbsp; &nbsp;9 &nbsp; &nbsp;664 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 1.00-2.00 &nbsp; sec &nbsp; 596 MBytes &nbsp;4999 Mbits/sec &nbsp; &nbsp;3 &nbsp; &nbsp;559 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 2.00-3.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4992 Mbits/sec &nbsp; &nbsp;9 &nbsp; &nbsp;586 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 3.00-4.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4989 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 4.00-5.00 &nbsp; sec &nbsp; 596 MBytes &nbsp;5000 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 5.00-6.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4989 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 6.00-7.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4990 Mbits/sec &nbsp; &nbsp;6 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 7.00-8.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4990 Mbits/sec &nbsp; &nbsp;3 &nbsp; &nbsp;524 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 8.00-9.00 &nbsp; sec &nbsp; 596 MBytes &nbsp;4997 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;586 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 9.00-10.00 &nbsp;sec &nbsp; 596 MBytes &nbsp;4997 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;603 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp;10.00-11.00 &nbsp;sec &nbsp; 595 MBytes &nbsp;4990 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span><br />
<div>
<br /></div>
<div>
Interestingly, using 2 parallel streams results in us (mostly) reaching the advertised 10 Gbps:</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$ iperf3 -p 5201 -c 172.31.7.67 -i 1 -t 3600 -f m -V -P 2</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">iperf 3-CURRENT</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Linux ip-172-31-10-235 4.9.32-15.41.amzn1.x86_64 #1 SMP Thu Jun 22 06:20:54 UTC 2017 x86_64</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Control connection MSS 8949</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Time: Sun, 20 Aug 2017 07:37:38 GMT</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Connecting to host 172.31.7.67, port 5201</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; Cookie: q343avscwpva5uyg2ayeinboxi5pllvw5l7r</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; TCP MSS: 8949 (default)</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] local 172.31.10.235 port 41274 connected to 172.31.7.67 port 5201</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] local 172.31.10.235 port 41276 connected to 172.31.7.67 port 5201</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">Starting Test: protocol: TCP, 2 streams, 131072 byte blocks, omitting 0 seconds, 3600 second test, tos 0</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ ID] Interval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bitrate &nbsp; &nbsp; &nbsp; &nbsp; Retr &nbsp;Cwnd</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 0.00-1.00 &nbsp; sec &nbsp; 597 MBytes &nbsp;5010 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;690 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 0.00-1.00 &nbsp; sec &nbsp; 592 MBytes &nbsp;4968 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;717 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 0.00-1.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9979 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 1.00-2.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4994 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;690 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 1.00-2.00 &nbsp; sec &nbsp; 592 MBytes &nbsp;4962 Mbits/sec &nbsp; 18 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 1.00-2.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9956 Mbits/sec &nbsp; 18 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 2.00-3.00 &nbsp; sec &nbsp; 591 MBytes &nbsp;4957 Mbits/sec &nbsp;137 &nbsp; &nbsp;463 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 2.00-3.00 &nbsp; sec &nbsp; 587 MBytes &nbsp;4924 Mbits/sec &nbsp; 41 &nbsp; &nbsp;725 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 2.00-3.00 &nbsp; sec &nbsp;1.15 GBytes &nbsp;9881 Mbits/sec &nbsp;178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 3.00-4.00 &nbsp; sec &nbsp; 593 MBytes &nbsp;4973 Mbits/sec &nbsp; 46 &nbsp; &nbsp;367 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 3.00-4.00 &nbsp; sec &nbsp; 591 MBytes &nbsp;4956 Mbits/sec &nbsp; 40 &nbsp; &nbsp;419 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 3.00-4.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9929 Mbits/sec &nbsp; 86 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 4.00-5.00 &nbsp; sec &nbsp; 592 MBytes &nbsp;4968 Mbits/sec &nbsp;141 &nbsp; &nbsp;542 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 4.00-5.00 &nbsp; sec &nbsp; 591 MBytes &nbsp;4960 Mbits/sec &nbsp; 36 &nbsp; &nbsp;559 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 4.00-5.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9928 Mbits/sec &nbsp;177 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 5.00-6.00 &nbsp; sec &nbsp; 595 MBytes &nbsp;4995 Mbits/sec &nbsp; 30 &nbsp; &nbsp;664 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 5.00-6.00 &nbsp; sec &nbsp; 588 MBytes &nbsp;4934 Mbits/sec &nbsp; &nbsp;8 &nbsp; &nbsp;568 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 5.00-6.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9929 Mbits/sec &nbsp; 38 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 6.00-7.00 &nbsp; sec &nbsp; 596 MBytes &nbsp;5000 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;664 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 6.00-7.00 &nbsp; sec &nbsp; 589 MBytes &nbsp;4945 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;629 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 6.00-7.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9945 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 7.00-8.00 &nbsp; sec &nbsp; 588 MBytes &nbsp;4935 Mbits/sec &nbsp; &nbsp;7 &nbsp; &nbsp;655 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 7.00-8.00 &nbsp; sec &nbsp; 594 MBytes &nbsp;4982 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;682 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 7.00-8.00 &nbsp; sec &nbsp;1.15 GBytes &nbsp;9917 Mbits/sec &nbsp; &nbsp;7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 8.00-9.00 &nbsp; sec &nbsp; 593 MBytes &nbsp;4974 Mbits/sec &nbsp; &nbsp;8 &nbsp; &nbsp;620 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 8.00-9.00 &nbsp; sec &nbsp; 593 MBytes &nbsp;4978 Mbits/sec &nbsp; 12 &nbsp; &nbsp;717 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 8.00-9.00 &nbsp; sec &nbsp;1.16 GBytes &nbsp;9952 Mbits/sec &nbsp; 20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;5] &nbsp; 9.00-10.00 &nbsp;sec &nbsp; 596 MBytes &nbsp;4999 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;638 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;7] &nbsp; 9.00-10.00 &nbsp;sec &nbsp; 590 MBytes &nbsp;4951 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;717 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 9.00-10.00 &nbsp;sec &nbsp;1.16 GBytes &nbsp;9950 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div>
</div>
<div>
<span style="font-family: inherit;"><br /></span></div>
<div>
<br />
<span style="font-family: inherit;">This behaviour is not consistent, stopping and restarting the instances often resulted in the full 10 Gbps on a single stream suggesting the issue relates to instance placement, something that appears to be supported by the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/placement-groups.html#concepts-placement-groups">placement group documentation</a> which states: "Network traffic to and from resources outside the placement group is limited to 5 Gbps." It is also possible that the streams are incorrectly being treated as placement group or public internet flows with different limits. For consistency I have used two parallel streams to avoid this issue in the rest of the article.</span><br />
<span style="font-family: inherit;"><br /></span>
<span style="font-family: inherit;">The CloudWatch graphs shows us reaching a steady baseline after around eight minutes of starting iperf3:</span><br />
<div>
<br /></div>
<br /></div>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZ4vNHMtQp9j2PJbEl2ZmZAtx0HheYSQJDvNv0uuxTlTEQKsL9yUmMLcCZFXmBy5Znkw4I1YchF0tqEEyFzM4jSIsW8Y5ut0za4iu26OH7TqnaBa2SVw1WwmOs4uU1QDl3bzQZoHi35sA/s1600/r4base.png" imageanchor="1"><img border="0" data-original-height="419" data-original-width="885" height="300" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZ4vNHMtQp9j2PJbEl2ZmZAtx0HheYSQJDvNv0uuxTlTEQKsL9yUmMLcCZFXmBy5Znkw4I1YchF0tqEEyFzM4jSIsW8Y5ut0za4iu26OH7TqnaBa2SVw1WwmOs4uU1QDl3bzQZoHi35sA/s640/r4base.png" width="640" /></a></div>
<div>
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;"><br /></span></div>
<div>
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;"><br /></span></div>
<div>
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;">A quick word on the graph above, firstly it is in bytes and, having</span><span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;">&nbsp;enabled detailed monitoring,</span><span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;">&nbsp;one minute granularity. For conversion purpose this means we need to divide the value of the metric by 60 to get bytes per second and then multiple by 8 to get bits per seconds. Looking at the actual data from the graph above:</span><br />
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;"><br /></span>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$ aws cloudwatch get-metric-statistics --metric-name NetworkOut --start-time 2017-08-20T08:23:00 --end-time 2017-08-20T08:35:00 --period 60 --namespace AWS/EC2 --statistics Average --dimensions Name=InstanceId,Value=i-0a7e009e7c0bf8fa8 &nbsp;--query 'Datapoints[*].[Timestamp,Average]' --output=text | sort</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:23:00Z 486.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:24:00Z 5726.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:25:00Z 22711496136.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:26:00Z 76376122845.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:27:00Z 76403033046.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:28:00Z 76357957564.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:29:00Z 76304994405.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:30:00Z 48667898310.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:31:00Z 5776989873.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:32:00Z 5816890095.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:33:00Z 5692555065.0</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">2017-08-20T08:34:00Z 5692014471.0</span><br />
<span style="font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;;"><br /></span>
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;"><br /></span>
<span style="background-color: white; font-family: &quot;open sans&quot; , &quot;lucida grande&quot; , &quot;helvetica neue&quot; , &quot;arial&quot;; font-size: 16px;">The maximum average throughput (between 08:26 and 08:29) is around 76 GByte/minute which works out at around 1.2 GByte/second or approximately 10.1 Gbit/second. Similarly the baseline (from 08:31 onwards) is in the region of 5.7 GByte/minute which translates to around 94 MByte/second or around 750 Mbit/second. These numbers are naturally averages but are fairly close to the actual iperf3 results, with the peak throughput of just over 10Gbit/second:</span></div>
<div>
<span style="background-color: white;">
</span>
<br />
<div style="font-family: &quot;Open Sans&quot;, &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial; font-size: 16px;">
<span style="background-color: white;"><br /></span></div>
<span style="background-color: white;">
</span>
<div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ ID] Interval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bitrate &nbsp; &nbsp; &nbsp; &nbsp; Retr &nbsp;Cwnd</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 0.00-1.00 &nbsp; sec &nbsp; 604 MBytes &nbsp;5065 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;551 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 0.00-1.00 &nbsp; sec &nbsp; 604 MBytes &nbsp;5062 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;524 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 0.00-1.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10127 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 1.00-2.00 &nbsp; sec &nbsp; 601 MBytes &nbsp;5046 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;551 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 1.00-2.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5048 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;551 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 1.00-2.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10094 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 2.00-3.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5046 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 2.00-3.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5047 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 2.00-3.00 &nbsp; sec &nbsp;1.17 GBytes &nbsp;10093 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 3.00-4.00 &nbsp; sec &nbsp; 601 MBytes &nbsp;5045 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 3.00-4.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5049 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 3.00-4.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10095 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 4.00-5.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5049 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 4.00-5.00 &nbsp; sec &nbsp; 601 MBytes &nbsp;5045 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 4.00-5.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10094 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 5.00-6.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5049 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 5.00-6.00 &nbsp; sec &nbsp; 601 MBytes &nbsp;5042 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 5.00-6.00 &nbsp; sec &nbsp;1.17 GBytes &nbsp;10092 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 6.00-7.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5046 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 6.00-7.00 &nbsp; sec &nbsp; 602 MBytes &nbsp;5049 Mbits/sec &nbsp; &nbsp;0 &nbsp; &nbsp;577 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 6.00-7.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10095 Mbits/sec &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] &nbsp; 7.00-8.00 &nbsp; sec &nbsp; 603 MBytes &nbsp;5063 Mbits/sec &nbsp; &nbsp;0 &nbsp; 1.44 MBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] &nbsp; 7.00-8.00 &nbsp; sec &nbsp; 601 MBytes &nbsp;5041 Mbits/sec &nbsp; 66 &nbsp; &nbsp;524 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] &nbsp; 7.00-8.00 &nbsp; sec &nbsp;1.18 GBytes &nbsp;10104 Mbits/sec &nbsp;66 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div style="font-family: &quot;Open Sans&quot;, &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial; font-size: 16px;">
<span style="background-color: white;"><br /></span></div>
<div style="font-family: &quot;Open Sans&quot;, &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial; font-size: 16px;">
<span style="background-color: white;">And the baseline of around 750Mbit/second:</span></div>
<div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ ID] Interval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bitrate &nbsp; &nbsp; &nbsp; &nbsp; Retr &nbsp;Cwnd</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 376.00-377.00 sec &nbsp;43.8 MBytes &nbsp; 367 Mbits/sec &nbsp;157 &nbsp; &nbsp;114 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 376.00-377.00 sec &nbsp;43.8 MBytes &nbsp; 367 Mbits/sec &nbsp;157 &nbsp; 78.7 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 376.00-377.00 sec &nbsp;87.5 MBytes &nbsp; 734 Mbits/sec &nbsp;314 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 377.00-378.00 sec &nbsp;45.0 MBytes &nbsp; 377 Mbits/sec &nbsp;161 &nbsp; 69.9 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 377.00-378.00 sec &nbsp;45.0 MBytes &nbsp; 377 Mbits/sec &nbsp;167 &nbsp; 78.7 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 377.00-378.00 sec &nbsp;90.0 MBytes &nbsp; 755 Mbits/sec &nbsp;328 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 378.00-379.00 sec &nbsp;43.8 MBytes &nbsp; 367 Mbits/sec &nbsp;182 &nbsp; 69.9 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 378.00-379.00 sec &nbsp;45.0 MBytes &nbsp; 377 Mbits/sec &nbsp;168 &nbsp; &nbsp;105 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 378.00-379.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;350 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 379.00-380.00 sec &nbsp;42.5 MBytes &nbsp; 357 Mbits/sec &nbsp;150 &nbsp; 61.2 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 379.00-380.00 sec &nbsp;46.2 MBytes &nbsp; 388 Mbits/sec &nbsp;165 &nbsp; 96.1 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 379.00-380.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;315 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 380.00-381.00 sec &nbsp;36.2 MBytes &nbsp; 304 Mbits/sec &nbsp;129 &nbsp; 78.7 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 380.00-381.00 sec &nbsp;52.5 MBytes &nbsp; 440 Mbits/sec &nbsp;203 &nbsp; &nbsp;105 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 380.00-381.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;332 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 381.00-382.00 sec &nbsp;36.2 MBytes &nbsp; 304 Mbits/sec &nbsp;147 &nbsp; 96.1 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 381.00-382.00 sec &nbsp;52.5 MBytes &nbsp; 440 Mbits/sec &nbsp;220 &nbsp; 87.4 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 381.00-382.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;367 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 382.00-383.00 sec &nbsp;46.2 MBytes &nbsp; 388 Mbits/sec &nbsp;175 &nbsp; 52.4 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 382.00-383.00 sec &nbsp;42.5 MBytes &nbsp; 357 Mbits/sec &nbsp;167 &nbsp; &nbsp;114 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 382.00-383.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;342 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 383.00-384.00 sec &nbsp;41.2 MBytes &nbsp; 346 Mbits/sec &nbsp;165 &nbsp; 61.2 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 383.00-384.00 sec &nbsp;47.5 MBytes &nbsp; 398 Mbits/sec &nbsp;170 &nbsp; 96.1 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 383.00-384.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;335 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;6] 384.00-385.00 sec &nbsp;50.0 MBytes &nbsp; 419 Mbits/sec &nbsp;195 &nbsp; 87.4 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[ &nbsp;8] 384.00-385.00 sec &nbsp;38.8 MBytes &nbsp; 325 Mbits/sec &nbsp;157 &nbsp; 52.4 KBytes &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">[SUM] 384.00-385.00 sec &nbsp;88.8 MBytes &nbsp; 744 Mbits/sec &nbsp;352 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></div>
<div style="font-size: 16px;">
<div style="font-family: &quot;Times New Roman&quot;; font-size: medium;">
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">- - - - - - - - - - - - - - - - - - - - - - - - -</span></span></div>
<h4>
<span style="background-color: white;">
</span></h4>
<h4>
<span style="background-color: white;">
Calculating network credit rates</span></h4>
<div>
<span style="background-color: white;">Using the baseline for network performance we can draw some inferences about the rate at which network credits are accrued. For simplicity I am going to define a network credit as having a value of 1 Gbps, so an instance with 10 network credits could transmit at 10 Gbps for 1 second, naturally if the instance network limit is 10 Gbps the maximum rate can't be exceeded even if the instance credit balance is sufficient (20 credits allows 2 seconds at 10 Gbps rather than 1 second at 20 Gbps) . Given the base network performance in the previous section, we can assume that an r4.large has a network credit rate of around 0.75 credits per second. We can also assume a starting balance of around 2700 as we were able to maintain 10 Gbps for around 295 seconds ((10 - 0.75) * 295) at the start of the iperf3 run. Finally it appears the maximum credit balance on the r4.large is the same as the initial balance. Leaving the instances idle for 3 hours should have resulted in a credit balance of around 8100 (0.75 rate * 3600 seconds in an hour * 3 hours) which should have theoretically allowed 810 seconds at 10 Gbps but instead provided only around 295 seconds.</span></div>
<div>
<span style="background-color: white;"><br /></span></div>
<h4>
<span style="background-color: white;">
</span></h4>
<h4>
<span style="background-color: white;">
R4 network performance table</span></h4>
<div>
<span style="background-color: white;">Below is a table of the expected performance for R4 instance sizes.</span><br />
<span style="background-color: white;"><br /></span></div>
<table border="2" cellpadding="1" cellspacing="1" style="width: 100%px;">
<tbody>
<tr>
<th>Instance</th>
<th>Baseline Gbps (approximate)</th>
<th>Initial/Max Credit (approximate)</th>
<th>Maximum time<br />
at 10Gbps <br />
(approximate seconds)</th>
</tr>
<tr>
<td nowrap="">r4.large</td>
<td>0.75</td>
<td>2700</td>
<td>295</td>
</tr>
<tr>
<td nowrap="">r4.xlarge</td>
<td>1.25</td>
<td>5145</td>
<td>589</td>
</tr>
<tr>
<td nowrap="">r4.2xlarge</td>
<td>2.5</td>
<td>8925</td>
<td>1191</td>
</tr>
<tr>
<td nowrap="">r4.4xlarge</td>
<td>5</td>
<td>11950</td>
<td>2390</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<span style="background-color: white;">
<div style="font-size: 16px;">
<br />
To calculate whether or not an instance will match your network throughput requirements take the difference from the baseline rate and your application base network utilisation and divide by the required burst rate.</div>
<div style="font-size: 16px;">
<br /></div>
<div style="font-size: 16px;">
For example, if your application requires a baseline of 0.6 Gbps, you would accrue credits at around 0.15 per second allowing you to burst for 10 Gbps for approximately one second every 66 seconds (10 / 0.15) or for 10 seconds every 660 seconds.</div>
</span></div>
</li><li>
        <span class="post-meta">Oct 21, 2016</span>
        <h3>
          <a class="post-link" href="/2016/10/21/aws-cli-switching-to-and-from-regional.html">
            AWS CLI - Switching to and from regional EC2 reserved instances
          </a>
        </h3>AWS recently announced the availability of <a href="https://aws.amazon.com/blogs/aws/ec2-reserved-instance-update-convertible-ris-and-regional-benefit/">regional reserved</a> instances, this post explains how to switch a reservation from AZ specific to regional (and back) using the AWS CLI.<br />
<br />
<h4>
Step 1, find the reservation to modify</h4>
<span style="font-size: x-small;"><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">$ aws ec2 describe-reserved-instances --filters Name=state,Values=active</span></span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstances": [</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; {</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "c416aeaf-fb64-4218-970f-7426f6f32377",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingType": "No Upfront",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "AvailabilityZone": "eu-west-1c",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "End": "2017-10-21T08:45:55.000Z",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ProductDescription": "Linux/UNIX",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Scope": "Availability Zone",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UsagePrice": 0.0,&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "RecurringCharges": [</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Amount": 0.01,&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Frequency": "Hourly"</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingClass": "standard",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Start": "2016-10-21T08:45:56.708Z",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "State": "active",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FixedPrice": 0.0,&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CurrencyCode": "USD",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Duration": 31536000,&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceTenancy": "default",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceType": "t2.micro",&nbsp;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; ]</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span>
The "Scope" field in the response shows that this reservation is currently specific to an Availability Zone, eu-west-1c in this case.<br />
<div>
<br /></div>
<h4>
Step 2, request the modification</h4>
<div>
<span style="font-size: x-small;"><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">$ aws ec2 modify-reserved-instances --reserved-instances-ids c416aeaf-fb64-4218-970f-7426f6f32377 --target-configurations Scope=Region,InstanceCount=1</span></span></div>
<div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstancesModificationId": "rimod-aaada6ed-fec9-47c7-92e2-6edf7e61f2ce"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
<div>
<br /></div>
<div>
The Scope=Region indicates that this reservation should be converted to a regional reservation, InstanceCount is a required parameter to indicate the number of reservations the modification should be applied to.</div>
<div>
<br /></div>
<h4>
Step 3, monitor progress</h4>
<div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">$ aws ec2 describe-reserved-instances-modifications</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstancesModifications": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Status": "processing",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ModificationResults": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "35f9b908-ae36-41ca-ac0b-4c67c887135b",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "TargetConfiguration": {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "EffectiveDate": "2016-10-21T08:45:57.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CreateDate": "2016-10-21T08:50:28.585Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UpdateDate": "2016-10-21T08:50:31.098Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesModificationId": "rimod-aaada6ed-fec9-47c7-92e2-6edf7e61f2ce",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesIds": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "c416aeaf-fb64-4218-970f-7426f6f32377"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
<div>
<br /></div>
<div>
The "Status" in the response will show "processing" until the modification has completed successfully, at which time it will change to "fulfilled":</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">$ aws ec2 describe-reserved-instances-modifications</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstancesModifications": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Status": "fulfilled",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ModificationResults": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "35f9b908-ae36-41ca-ac0b-4c67c887135b",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "TargetConfiguration": {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "EffectiveDate": "2016-10-21T08:45:57.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CreateDate": "2016-10-21T08:50:28.585Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UpdateDate": "2016-10-21T09:11:33.454Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesModificationId": "rimod-aaada6ed-fec9-47c7-92e2-6edf7e61f2ce",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesIds": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "c416aeaf-fb64-4218-970f-7426f6f32377"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
<div>
<br /></div>
<h4>
Step 4, success!</h4>
<div>
The new reservation is now regional (Scope=Region):</div>
<div>
<br /></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">$ aws ec2 describe-reserved-instances --filters Name=state,Values=active</span><br />
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstances": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "35f9b908-ae36-41ca-ac0b-4c67c887135b",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingType": "No Upfront",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FixedPrice": 0.0,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "End": "2017-10-21T08:45:55.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ProductDescription": "Linux/UNIX",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Scope": "Region",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UsagePrice": 0.0,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "RecurringCharges": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Amount": 0.01,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Frequency": "Hourly"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingClass": "standard",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Start": "2016-10-21T08:45:57.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "State": "active",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CurrencyCode": "USD",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Duration": 31536000,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceTenancy": "default",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceType": "t2.micro"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
<div>
<br /></div>
<h4>
Switching back</h4>
<div>
Follows the same process with the added requirement of specifying which AZ the reservation should be linked to:</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">$ aws ec2 modify-reserved-instances --reserved-instances-ids 35f9b908-ae36-41ca-ac0b-4c67c887135b --target-configurations Scope="Availability Zone",InstanceCount=1,AvailabilityZone=eu-west-1b</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstancesModificationId": "rimod-9e490be9-55a3-48cf-81e9-2662b13db2f8"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
<div>
<div>
<br /></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">$ aws ec2 describe-reserved-instances --filters Name=state,Values=active</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">{</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; "ReservedInstances": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "df70d097-2f33-4962-bca6-37af15ca819e",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingType": "No Upfront",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "AvailabilityZone": "eu-west-1b",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "End": "2017-10-21T08:45:55.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ProductDescription": "Linux/UNIX",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Scope": "Availability Zone",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UsagePrice": 0.0,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "RecurringCharges": [</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Amount": 0.01,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Frequency": "Hourly"</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingClass": "standard",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Start": "2016-10-21T08:45:58.000Z",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "State": "active",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FixedPrice": 0.0,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CurrencyCode": "USD",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Duration": 31536000,&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceTenancy": "default",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceType": "t2.micro",&nbsp;</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; ]</span></div>
<div>
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">}</span></div>
</div>
</li><li>
        <span class="post-meta">Aug 31, 2016</span>
        <h3>
          <a class="post-link" href="/2016/08/31/aws-troubleshooting-lamba-deployment.html">
            AWS troubleshooting - Lamba deployment package file permissions
          </a>
        </h3>When creating your own <a href="http://docs.aws.amazon.com/lambda/latest/dg/deployment-package-v2.html">Lambda deployment packages</a> be aware of the permissions on the files before zipping them. Lambda requires the files to have read access for all users, particularly "other", if this is missing you will receive a non-obvious error when trying to call the function. The fix is simple enough, perform a 'chmod a+r *' before creating your zip file. If the code is visible in the inline editor adding an empty line and saving will also fix the problem, presumably by overwriting the file with the correct permissions.<br />
<div>
<br /></div>
<div>
Below are some examples of errors you will see in the various languages if read permissions are missing. Hopefully this post will have saved you some time debugging.</div>
<div>
<br /></div>
<div>
<b>Java CloudWatch logs:</b></div>
<div>
--</div>
<div>
<div>
Class not found: example.Hello: class java.lang.ClassNotFoundException</div>
<div>
java.lang.ClassNotFoundException: example.Hello</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader$1.run(URLClassLoader.java:370)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader$1.run(URLClassLoader.java:362)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.security.AccessController.doPrivileged(Native Method)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader.findClass(URLClassLoader.java:361)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.lang.ClassLoader.loadClass(ClassLoader.java:424)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.lang.ClassLoader.loadClass(ClassLoader.java:357)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.lang.Class.forName0(Native Method)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.lang.Class.forName(Class.java:348)</div>
<div>
Caused by: java.io.FileNotFoundException: /var/task/example/Hello.class (Permission denied)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.io.FileInputStream.open0(Native Method)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.io.FileInputStream.open(FileInputStream.java:195)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:138)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at sun.misc.URLClassPath$FileLoader$1.getInputStream(URLClassPath.java:1251)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at sun.misc.Resource.cachedInputStream(Resource.java:77)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at sun.misc.Resource.getByteBuffer(Resource.java:160)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader.defineClass(URLClassLoader.java:454)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader.access$100(URLClassLoader.java:73)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>at java.net.URLClassLoader$1.run(URLClassLoader.java:368)</div>
<div>
<span class="Apple-tab-span" style="white-space: pre;"> </span>... 7 more</div>
</div>
<div>
--</div>
<div>
<br /></div>
<div>
<b>Java execution result (testing from console):</b></div>
<div>
<div>
{</div>
<div>
&nbsp; "errorMessage": "Class not found: example.Hello",</div>
<div>
&nbsp; "errorType": "class java.lang.ClassNotFoundException"</div>
<div>
}</div>
</div>
<div>
<br /></div>
<div>
<b>Python CloudWatch logs:</b></div>
<div>
--</div>
<div>
<div>
Unable to import module 'python-hi': No module named python-hi</div>
</div>
<div>
--</div>
<div>
<br /></div>
<div>
<b>Python execution result (testing from console):</b></div>
<div>
<div>
{</div>
<div>
&nbsp; "errorMessage": "Unable to import module 'python-hi'"</div>
<div>
}</div>
</div>
<div>
<br /></div>
<div>
<b>Node CloudWatch logs:</b></div>
<div>
--</div>
<div>
<div>
module initialization error: Error</div>
<div>
&nbsp; &nbsp; at Error (native)</div>
<div>
&nbsp; &nbsp; at Object.fs.openSync (fs.js:549:18)</div>
<div>
&nbsp; &nbsp; at Object.fs.readFileSync (fs.js:397:15)</div>
<div>
&nbsp; &nbsp; at Object.Module._extensions..js (module.js:415:20)</div>
<div>
&nbsp; &nbsp; at Module.load (module.js:343:32)</div>
<div>
&nbsp; &nbsp; at Function.Module._load (module.js:300:12)</div>
<div>
&nbsp; &nbsp; at Module.require (module.js:353:17)</div>
<div>
&nbsp; &nbsp; at require (internal/module.js:12:17)</div>
</div>
<div>
--</div>
<div>
<br /></div>
<div>
<b>Node execution result (testing from console):</b></div>
<div>
<div>
{</div>
<div>
&nbsp; "errorMessage": "EACCES: permission denied, open '/var/task/node-hi.js'",</div>
<div>
&nbsp; "errorType": "Error",</div>
<div>
&nbsp; "stackTrace": [</div>
<div>
&nbsp; &nbsp; "Object.fs.openSync (fs.js:549:18)",</div>
<div>
&nbsp; &nbsp; "Object.fs.readFileSync (fs.js:397:15)",</div>
<div>
&nbsp; &nbsp; "Object.Module._extensions..js (module.js:415:20)",</div>
<div>
&nbsp; &nbsp; "Module.load (module.js:343:32)",</div>
<div>
&nbsp; &nbsp; "Function.Module._load (module.js:300:12)",</div>
<div>
&nbsp; &nbsp; "Module.require (module.js:353:17)",</div>
<div>
&nbsp; &nbsp; "require (internal/module.js:12:17)"</div>
<div>
&nbsp; ]</div>
<div>
}</div>
</div>
</li><li>
        <span class="post-meta">Aug 12, 2016</span>
        <h3>
          <a class="post-link" href="/2016/08/12/aws-tip-of-day-tagging-ec2-reserved.html">
            AWS Tip of the day: Tagging EC2 reserved instances
          </a>
        </h3>A quick post pointing out that EC2 reserved instances actually support tagging. This functionality is only available on the command line of via the API and not via the console but it still allows to you tag your reservations making it easier to keep track of why a reserved instance was purchased and what component it was intended for. Of course the reservation itself is not actually tied to a running instance in any way, it is merely a billing construct that is applied to any matching instances running in your account but if you are making architectural changes or considering different instance types for specific workloads or components the tags allow you (and your team) to see why the reservation was originally purchased. So for example if you are scaling up the instance sizes of a specific component, lets say from m4.large to m4.xlarge, you can check your reserved instance tags and modify the reservations associated with the component to ensure you continue to benefit from the purchase.<br />
<br />
The tagging of reserved instances works the same as tagging other <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html">EC2 resources</a>&nbsp;through the AWS CLI's ec2 <a href="http://docs.aws.amazon.com/cli/latest/reference/ec2/create-tags.html">create-tags</a> command and specifying the reserved instances ID as the resource ID. You can find the reserved instance ID using the CLI's ec2 <a href="http://docs.aws.amazon.com/cli/latest/reference/ec2/describe-reserved-instances.html">describe-reserved-instances</a> command. Using an actual example, lets start off finding a reservation:<br />
<br />
<span style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">$ aws ec2 describe-reserved-instances</span><br />
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
{</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; "ReservedInstances": [</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; {</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "3d092b71-5243-4e5e-b409-<wbr></wbr>86df342282ab",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingType": "No Upfront",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "AvailabilityZone": "eu-west-1c",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "End": "2017-08-12T04:48:58.000Z",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ProductDescription": "Linux/UNIX",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UsagePrice": 0.0,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "RecurringCharges": [</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Amount": 0.01,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Frequency": "Hourly"</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Start": "2016-08-12T04:48:59.763Z",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "State": "active",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FixedPrice": 0.0,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CurrencyCode": "USD",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Duration": 31536000,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceTenancy": "default",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceType": "t2.micro",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; ]</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
}</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<br /></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<span style="color: black; font-family: &quot;Times New Roman&quot;; font-size: small;">Next, lets add a tag indicating that this reservation is intended for the "production" stack.:</span></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
$ aws ec2 create-tags --resources 3d092b71-5243-4e5e-b409-<wbr></wbr>86df342282ab --tags Key=Stack,Value=production</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<br /></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<br /></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<span style="color: black; font-family: &quot;Times New Roman&quot;; font-size: small;">Checking the result:</span></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
$ aws ec2 describe-reserved-instances</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
{</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; "ReservedInstances": [</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; {</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ReservedInstancesId": "3d092b71-5243-4e5e-b409-<wbr></wbr>86df342282ab",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "OfferingType": "No Upfront",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "AvailabilityZone": "eu-west-1c",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "End": "2017-08-12T04:48:58.000Z",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ProductDescription": "Linux/UNIX",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Tags": [</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Value": "production",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Key": "Stack"</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UsagePrice": 0.0,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "RecurringCharges": [</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Amount": 0.01,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Frequency": "Hourly"</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Start": "2016-08-12T04:48:59.763Z",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "State": "active",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FixedPrice": 0.0,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "CurrencyCode": "USD",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Duration": 31536000,&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceTenancy": "default",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceType": "t2.micro",&nbsp;</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "InstanceCount": 1</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
&nbsp; &nbsp; ]</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
}</div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<br /></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<span style="color: black; font-family: &quot;Times New Roman&quot;; font-size: small;">Great we have a tag but what if we have hundreds of reservations, a long list of reservations is not particularly useful for quickly identifying the reservations related to a component or stack. The CLI's <a href="http://docs.aws.amazon.com/cli/latest/userguide/controlling-output.html">query and output</a> functionality can help here:</span></div>
<div style="background-color: white; color: #222222; font-family: arial, sans-serif; font-size: 12.8px;">
<span style="color: black; font-family: &quot;Times New Roman&quot;; font-size: small;"><br /></span></div>
<div style="background-color: white; color: #222222;">
<span style="font-family: arial, sans-serif; font-size: 13.3333px;">$ aws ec2 describe-reserved-instances --query 'ReservedInstances[*].{AZ:</span><wbr style="font-size: 13.3333px;"></wbr><span style="font-family: arial, sans-serif; font-size: 13.3333px;">AvailabilityZone,Type:</span><wbr style="font-size: 13.3333px;"></wbr><span style="font-family: arial, sans-serif; font-size: 13.3333px;">InstanceType,Expiry:End,stack:</span><wbr style="font-size: 13.3333px;"></wbr><span style="font-family: arial, sans-serif; font-size: 13.3333px;">Tags[?Key==`Stack`][?Value==`</span><wbr style="font-size: 13.3333px;"></wbr><span style="font-family: arial, sans-serif; font-size: 13.3333px;">production`]}' --output=table</span><br style="font-size: 13.3333px;" /><span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">------------------------------<wbr></wbr>--------------------------<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DescribeReservedInstances&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr></wbr>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+---------------<wbr></wbr>-------------+-----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; AZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Expiry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp; |<br />+-------------+---------------<wbr></wbr>-------------+-----------+<br />|&nbsp; eu-west-1c |&nbsp; 2017-08-12T04:48:58.000Z&nbsp; |&nbsp; t2.micro |<br />+-------------+---------------<wbr></wbr>-------------+-----------+</span><br style="font-size: 13.3333px;" /><span style="color: black;">Not quite the console view but easy enough to see that we have one reservation for the "production" Stack.</span></div>
</li><li>
        <span class="post-meta">Jun 7, 2016</span>
        <h3>
          <a class="post-link" href="/2016/06/07/aws-tip-save-s3-costs-with-abort.html">
            AWS Tip: Save S3 costs with abort multipart lifecycle policy
          </a>
        </h3><h3>
Introduction</h3>
<div>
S3 multipart uploads provide a number of <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/uploadobjusingmpu.html">benefits</a>&nbsp;--&nbsp;better throughput, recovery from network errors -- and a number of tools will automatically use multipart uploads for larger uploads. The AWS CLI cp, mv, and sync commands all make use of multipart uploads and make a&nbsp;<a href="http://docs.aws.amazon.com/cli/latest/userguide/using-s3-commands.html#using-s3-commands-managing-objects">note</a>&nbsp;that "If the process is interrupted by a kill command or system failure, the in-progress multipart upload remains in Amazon S3 and must be cleaned up manually..."</div>
<div>
<br /></div>
<div>
The reason you would want to clean up these failed multipart uploads is because you will be charged for the storage they use while waiting for the upload to be completed (or aborted). This post provides some detail on how to find the incomplete uploads and options for removing them to save storage costs.</div>
<div>
<br /></div>
<h3>
Finding incomplete multipart uploads</h3>
<div>
If you have relatively few buckets or only want to check your biggest buckets (<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/cloudwatch-monitoring.html">CloudWatch S3 metrics</a> are useful for finding these) the AWS CLI s3api <a href="http://docs.aws.amazon.com/cli/latest/reference/s3api/list-multipart-uploads.html">list-multipart-uploads</a>&nbsp;command is a simple check:</div>
<blockquote class="tr_bq">
<span style="font-family: &quot;georgia&quot; , &quot;times new roman&quot; , serif;">aws s3api list-multipart-uploads --bucket [bucket-name]</span></blockquote>
No output indicates that the bucket does not contain any incomplete uploads, see the list-multipart-uploads documentation linked above for an example of the output on a bucket that does contain an incomplete upload. A simple bash script to check all your buckets:<br />
<br />
<script src="https://gist.github.com/watchamcb/c412482f1767cf3c3daf08996271a81c.js"></script></li><li>
        <span class="post-meta">May 5, 2016</span>
        <h3>
          <a class="post-link" href="/2016/05/05/enabling-longer-aws-ids-in-region-using.html">
            Enabling longer AWS IDs in a region using an IAM role
          </a>
        </h3>AWS is moving towards longer EC2 and EBS IDs and you can enable them for an IAM user or at an account level using the root credentials. You can avoid using the root credentials by using an IAM role instead. This is a quick post to explain the steps needed to use an IAM role on an instance to enable the longer IDs at an account level.<br />
<br />
<b>Update: </b>You can now use the --principal-arn argument to to make this change to the root account, see the AWS support post <a href="https://aws.amazon.com/premiumsupport/knowledge-center/enable-long-id/">here</a>.<br />
<br />
<b>Update 2:</b>&nbsp;Another alternative, using this <a href="https://github.com/awslabs/ec2-migrate-longer-id/blob/master/migratelongerids.py">script</a>.<br />
<br />
<b>1. Create a policy allowing modify and describe of ID format</b> (IAM console -&gt; Policies -&gt; Create Policy -&gt; Create Your Own Policy). The following policy document (originally from here with the Deny changed to Allow) provides the necessary permissions,<br />
<br />
{<br />
&nbsp; "Version": "2012-10-17",<br />
&nbsp; "Statement": [<br />
&nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; "Effect": "Allow",<br />
&nbsp; &nbsp; &nbsp; "Action": [<br />
&nbsp; &nbsp; &nbsp; &nbsp; "ec2:ModifyIdFormat", "ec2:DescribeIdFormat"<br />
&nbsp; &nbsp; &nbsp; ],<br />
&nbsp; &nbsp; &nbsp; "Resource": "*"<br />
&nbsp; &nbsp; }<br />
&nbsp; ]<br />
}<br />
<br />
<b>2. Create an EC2 role</b> (IAM console -&gt; Roles -&gt; Create New Role -&gt; [Pick a name] -&gt; Amazon EC2). Select the policy name you created in step 1 and attach it to the role.<br />
<br />
<b>3. Launch an instance with the role</b>. It is probably easiest to use an Amazon Linux AMI as the AWS CLI is installed by default. Instance size and region don't really matter.<br />
<br />
<b>4. SSH to the instance and use the CLI to enable the longer IDs</b> in the region that you would like to test against:<br />
$ aws --region eu-west-1 ec2 modify-id-format --resource instance --use-long-ids<br />
<br />
If you don't specify a region the CLI will prompt you to run 'aws configure' to set a default. To check the status of the ID format you can use describe-id-format:<br />
$ aws --region eu-west-1 ec2 describe-id-format<br />
<br />
{<br />
&nbsp; &nbsp; "Statuses": [<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UseLongIds": false,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Resource": "reservation"<br />
&nbsp; &nbsp; &nbsp; &nbsp; },<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UseLongIds": true,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Resource": "instance"<br />
&nbsp; &nbsp; &nbsp; &nbsp; },<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UseLongIds": false,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Resource": "volume"<br />
&nbsp; &nbsp; &nbsp; &nbsp; },<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "UseLongIds": false,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Resource": "snapshot"<br />
&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; ]<br />
}<br />
<br />
<b>5. Longer IDs are now enabled for the account. </b>Resources created by the root account (such as Auto Scaled instances) will be launched with longer IDs.</li><li>
        <span class="post-meta">May 4, 2016</span>
        <h3>
          <a class="post-link" href="/2016/05/04/connection-to-s3amazonawscom-timed-out.html">
            &#39;Connection to s3.amazonaws.com timed out&#39; using VPC S3 Endpoint
          </a>
        </h3>A quick post to point you in the right direction if you are getting connection time out errors using the AWS CLI or Boto with <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html">AWS S3 VPC Endpoints</a> in a private subnet. The two most likely causes of this are:<br />
<br />
1. Your bucket name contains dots.<br />
To work around this you can specify the region of the bucket, for example:<br />
aws --region eu-west-1 s3 ls s3://bucket.with.dots/<br />
<br />
2. You are trying to access a bucket in a different region.<br />
This is not supported by VPC Endpoints, see the restrictions <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html#vpc-endpoints-limitations">here</a>.</li><li>
        <span class="post-meta">Feb 18, 2016</span>
        <h3>
          <a class="post-link" href="/2016/02/18/memcached-item-memory-usage.html">
            Memcached item memory usage
          </a>
        </h3><h4>
Introduction</h4>
I was recently involved with an investigation into a Memcached cluster running on AWS ElastiCache and discovered a few interesting details about Memcached. This post looks at the memory overhead of storing items in Memcached and demonstrates the impact of disabling CAS (check and set) on memory utilisation.<br />
<ol>
</ol>
<h4>
Background - Memcached item overhead</h4>
<div>
Before getting into the details some background might be useful. Starting with the basics, how much memory does Memcached actually need to store an item? Lets spin up a cluster to check, for simplicity I am using a single m3.large ElastiCache node (running memcached 1.4.24) which according to the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/ParameterGroups.Memcached.html#ParameterGroups.Memcached.NodeSpecific">AWS docs</a>&nbsp;provides around 6.2GB of memory for cache items.</div>
<div>
<br /></div>
<div>
The easiest way to look at our new cache is by telnetting to the cluster (from within the VPC) and running commands directly. To start, what does the slab allocation look like:</div>
<div>
<br /></div>
<div>
&gt; stats slabs</div>
<div>
<div>
&lt; STAT active_slabs 0</div>
<div>
&lt;&nbsp;STAT total_malloced 0</div>
<div>
&lt;&nbsp;END</div>
</div>
<div>
<br /></div>
<div>
As expected, our empty cache has 0 active slabs and no memory allocated. Lets add a value and see how this changes things:</div>
<div>
<br /></div>
<div>
<div>
&gt; set k 0 500 1</div>
<div>
&gt; v</div>
<div>
&lt; STORED</div>
</div>
<div>
<br /></div>
<div>
Above, we have set an item with a key of 'k', no flags, a 500 second expiry time and a 1 byte value of 'v'. Looking at the slab stats we now see:</div>
<div>
<br /></div>
<div>
<div>
&gt; stats slabs</div>
<div>
&lt;&nbsp;STAT 1:chunk_size 96</div>
<div>
&lt;&nbsp;STAT 1:chunks_per_page 10922</div>
<div>
&lt;&nbsp;STAT 1:total_pages 1</div>
<div>
&lt;&nbsp;STAT 1:total_chunks 10922</div>
<div>
&lt;&nbsp;STAT 1:used_chunks 1</div>
<div>
&lt;&nbsp;STAT 1:free_chunks 10921</div>
<div>
&lt;&nbsp;STAT 1:free_chunks_end 0</div>
<div>
&lt;&nbsp;STAT 1:mem_requested 67</div>
<div>
&lt;&nbsp;STAT 1:get_hits 0</div>
<div>
&lt;&nbsp;STAT 1:cmd_set 1</div>
<div>
&lt;&nbsp;STAT 1:delete_hits 0</div>
<div>
&lt;&nbsp;STAT 1:incr_hits 0</div>
<div>
&lt;&nbsp;STAT 1:decr_hits 0</div>
<div>
&lt;&nbsp;STAT 1:cas_hits 0</div>
<div>
&lt;&nbsp;STAT 1:cas_badval 0</div>
<div>
&lt;&nbsp;STAT 1:touch_hits 0</div>
<div>
&lt;&nbsp;STAT active_slabs 1</div>
<div>
&lt;&nbsp;STAT total_malloced 1048512</div>
<div>
&lt;&nbsp;END</div>
</div>
<div>
<br /></div>
<div>
Lots of information here but lets focus on the chunks and memory stats for the moment. We now have 1 active slab with a chunk size of 96 bytes and &nbsp;one of these chunks (used_chunks) has been used to store our item, all expected except the relatively large size of the chunk used. We can see the actual memory requested was 67 bytes which means that 65 bytes of overhead are required to store the 2 byte item. Looking into the memcached code we can see that the item struct defined in <a href="https://github.com/memcached/memcached/blob/1.4.24/memcached.h">memcached.h</a>&nbsp;requires 48 bytes plus another 8 bytes for CAS. The remaining 11 bytes consist of:</div>
<div>
<ul>
<li>The null terminated key (2 bytes, 1 byte of overhead, "k\0"&nbsp;in our example)</li>
<li>The CRLF terminated data (3&nbsp;bytes, 2 bytes of overhead, "v\r\n" in our example)</li>
<li>The item header which is a formatted string containing the flags, data length and terminated with CRLF (6 bytes, the minimum, in our example "_0_1\r\n" with underscores to make the spaces more visible)</li>
</ul>
<div>
The header is created in the item_make_header function in <a href="https://github.com/memcached/memcached/blob/1.4.24/items.c">items.c</a>, the relevant part being:</div>
</div>
<div>
<br /></div>
<div>
<div>
&nbsp; &nbsp; *nsuffix = (uint8_t) snprintf(suffix, 40, " %d %d\r\n", flags, nbytes - 2);</div>
<div>
<br /></div>
</div>
<div>
The header formats the flags and data length as integers in a string so this overhead will increase as the data size and flag values increase. For example, setting the flag to 10 will require an extra byte of to store the extra digit in the header:</div>
<div>
<br /></div>
<div>
<div>
&gt; set k 10 500 1</div>
<div>
&gt; v</div>
<div>
&lt; STORED</div>
<div>
&gt; stats slabs</div>
<div>
&lt;&nbsp;STAT 1:chunk_size 96</div>
<div>
&lt;&nbsp;STAT 1:used_chunks 1</div>
<div>
&lt;&nbsp;STAT 1:free_chunks 10921</div>
<div>
&lt;&nbsp;STAT 1:mem_requested 68</div>
<div>
...</div>
<div>
&lt;&nbsp;STAT active_slabs 1</div>
<div>
&lt;&nbsp;STAT total_malloced 1048512</div>
<div>
&lt; END</div>
</div>
<div>
<br /></div>
<div>
So you can expect at least 65 bytes of overhead per item.</div>
<div>
<br /></div>
<h4>
Disable CAS if you don't need it</h4>
<div>
CAS stands for 'Check And Set' which the Memcached <a href="https://github.com/memcached/memcached/blob/1.4.24/doc/protocol.txt">protocol docs</a> describe as: "store this data but only if no one else has updated since I last fetched it."</div>
<div>
<br /></div>
<div>
For a fair number of Memcached use cases CAS will not be used and as a result can be disabled with no impact. You can check your cluster using the stats command and looking at the cas_* values:</div>
<div>
<br /></div>
<div>
&gt; stats</div>
<div>
...</div>
<div>
<div>
&lt; STAT cas_misses 0</div>
<div>
&lt;&nbsp;STAT cas_hits 0</div>
<div>
&lt;&nbsp;STAT cas_badval 0</div>
</div>
<div>
...</div>
<div>
<br /></div>
<div>
Sounds simple enough, lets test it out. After setting cas_disabled to 1 on our cluster and rebooting for the change to take effect, we set our key again:</div>
<div>
<br /></div>
<div>
<div>
&gt; set k 0 500 1</div>
<div>
&gt; v</div>
<div>
&lt; STORED</div>
</div>
<div>
<div>
&gt; stats slabs</div>
<div>
&lt;&nbsp;STAT 1:chunk_size 96</div>
<div>
&lt;&nbsp;STAT 1:used_chunks 1</div>
<div>
&lt;&nbsp;STAT 1:free_chunks 10921</div>
</div>
<div>
<div>
&lt; STAT 1:mem_requested 59</div>
<div>
...</div>
<div>
&lt; STAT active_slabs 1</div>
<div>
&lt; STAT total_malloced 1048512</div>
<div>
&lt; END</div>
</div>
<div>
<br /></div>
<div>
Not much difference except for the requested memory reducing by 8 bytes. Disabling CAS will NOT reduce the wasted memory on its own but it will allow an item to contain an extra 8 bytes of data where previously it would have needed to use a larger chunk which might be wasting significantly more memory. Lets look at an example.</div>
<div>
<br /></div>
<div>
Assume that you are wanting to cache an item of 32 bytes, a 16 byte key and a 16 byte value. From the background section above we know that this will take 66 bytes of overhead pushing the total item size to 98 bytes, 2 bytes more than the chunk size of the first slab (using Memcached defaults), on a CAS enabled node this shows:</div>
<div>
<br /></div>
<div>
<div>
&gt; set 0123456789ABCDEF 0 500 16</div>
<div>
&gt; 0123456789ABCDEF</div>
<div>
&lt;&nbsp;STORED</div>
<div>
&gt; stats slabs</div>
<div>
&lt;&nbsp;STAT 2:chunk_size 120</div>
<div>
&lt;&nbsp;STAT 2:used_chunks 1</div>
<div>
&lt;&nbsp;STAT 2:free_chunks 8737</div>
<div>
&lt;&nbsp;STAT 2:mem_requested 98</div>
<div>
...</div>
<div>
&lt; STAT active_slabs 1</div>
<div>
&lt;&nbsp;STAT total_malloced 1048560</div>
<div>
&lt;&nbsp;END</div>
</div>
<div>
<br /></div>
<div>
Whereas with CAS disabled the overhead is reduced to 58 bytes, allowing the item to fit into the original slab:</div>
<div>
<br /></div>
<div>
<div>
&gt; set 0123456789ABCDEF 0 500 16</div>
<div>
&gt; 0123456789ABCDEF</div>
<div>
&lt; STORED</div>
<div>
&gt; stats slabs</div>
<div>
&gt; STAT 1:chunk_size 96</div>
<div>
&gt;&nbsp;STAT 1:used_chunks 1</div>
<div>
&gt;&nbsp;STAT 1:free_chunks 10921</div>
<div>
&gt;&nbsp;STAT 1:mem_requested 90</div>
<div>
...</div>
<div>
&gt;&nbsp;STAT active_slabs 1</div>
<div>
&gt;&nbsp;STAT total_malloced 1048512</div>
<div>
&gt;&nbsp;END</div>
</div>
<div>
<br /></div>
<div>
This means that with CAS enabled we are wasting 18% of the memory in each chunk of this slab (22 out of 120 bytes lost per item) compared to just 6% (6 out of 96 bytes) lost with CAS disabled. If the entire cache consisted of items this size, it would result in more than 1 GB of wasted memory compared to 372 MB wasted with CAS disabled. To put this differently, disabling CAS would allow you to store approximately 7 million additional 90 byte items resulting in better cache hit rates and lower eviction rates. This is of course an artificial example so lets look at a more realistic example where the cache item sizes are not quite so uniform.<br />
<br />
The following stats are based on a production CAS enabled node's stats adjusted by a factor of ten to fit on an m3.large (the production node had around 59 million items in slab 11 this was scaled to 5.9 million for testing). The test code used to generate this data is relatively simple and distributes the items in a slab fairly evenly across the item sizes of a slab, each item's size is slightly weighted to try and match the average item size in production.<br />
<br />
<table border="1" cellpadding="0" cellspacing="0" dir="ltr" style="border-collapse: collapse; border: 1px solid #ccc; font-family: Calibri; font-size: 13px; table-layout: fixed;"><colgroup><col width="31"></col><col width="57"></col><col width="68"></col><col width="96"></col><col width="97"></col><col width="63"></col><col width="96"></col></colgroup><tbody>
<tr style="height: 20px;"><td data-sheets-value="[null,2,&quot;Slab&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Slab</td><td data-sheets-value="[null,2,&quot;Chunk Size&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Chunk Size</td><td data-sheets-value="[null,2,&quot;Chunks Used&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Chunks Used</td><td data-sheets-value="[null,2,&quot;Memory Allocated&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Allocated</td><td data-sheets-value="[null,2,&quot;Memory Requested&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Requested</td><td data-sheets-value="[null,2,&quot;Average Item Size&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Average Item Size</td><td data-sheets-value="[null,2,&quot;Memory Wasted&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Wasted</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,4]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4</td><td data-sheets-value="[null,3,null,192]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">192</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,139810]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">139,810</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26843520]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26,843,520</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,25706546]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">25,706,546</td><td data-sheets-value="[null,3,null,184]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">184</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1136974]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,136,974</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,5]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5</td><td data-sheets-value="[null,3,null,240]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">240</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,55924]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">55,924</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13421760]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13,421,760</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11399776]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,399,776</td><td data-sheets-value="[null,3,null,204]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">204</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2021984]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,021,984</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,10]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">10</td><td data-sheets-value="[null,3,null,752]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">752</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,232025]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">232,025</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,174482800]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">174,482,800</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,162673515]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">162,673,515</td><td data-sheets-value="[null,3,null,701]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">701</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11809285]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,809,285</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,11]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11</td><td data-sheets-value="[null,3,null,944]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">944</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5985735]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,985,735</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5650533840]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,650,533,840</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4643546639]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4,643,546,639</td><td data-sheets-value="[null,3,null,776]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">776</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1006987201]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,006,987,201</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,12]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">12</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1184]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,184</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10951]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">10,951</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12965984]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">12,965,984</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11429965]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,429,965</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1044]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,044</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1536019]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,536,019</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,13]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1480]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,480</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7177]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7,177</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10621960]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">10,621,960</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,9421613]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">9,421,613</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1313]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,313</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1200347]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,200,347</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,14]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">14</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1856]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,856</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6071]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">6,071</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11267776]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,267,776</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10148664]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">10,148,664</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1672]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,672</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1119112]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,119,112</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,15]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">15</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2320]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,320</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5325]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,325</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12354000]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">12,354,000</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11094291]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,094,291</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2083]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,083</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1259709]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,259,709</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,16]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">16</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2904]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,904</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4621]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4,621</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13419384]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13,419,384</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11947574]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,947,574</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2585]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,585</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1471810]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,471,810</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,17]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3632]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,632</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3695]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,695</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13420240]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13,420,240</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11906634]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,906,634</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3222]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,222</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1513606]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,513,606</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,18]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">18</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4544]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4,544</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5201]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,201</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23633344]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,633,344</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,21025609]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21,025,609</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4043]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4,043</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2607735]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,607,735</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,19]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">19</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5680]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,680</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4523]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4,523</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,25690640]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">25,690,640</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23038012]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,038,012</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5094]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,094</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2652628]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,652,628</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,20]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">20</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7104]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7,104</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3778]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,778</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26838912]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26,838,912</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23778017]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,778,017</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6294]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">6,294</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3060895]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,060,895</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,21]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,8880]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">8,880</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3022]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,022</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26835360]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26,835,360</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23630979]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,630,979</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7820]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7,820</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3204381]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,204,381</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,22]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">22</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11104]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,104</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2417]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2,417</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26838368]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26,838,368</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23754944]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,754,944</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,9828]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">9,828</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3083424]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,083,424</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,23]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13880]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13,880</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1933]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,933</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26830040]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26,830,040</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23092970]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23,092,970</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11947]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11,947</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3737070]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,737,070</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,24]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">24</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,17352]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17,352</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1107]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,107</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,19208664]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">19,208,664</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,15554075]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">15,554,075</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,14051]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">14,051</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3654589]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3,654,589</td></tr>
<tr style="height: 20px;"><td style="padding: 0px 3px 0px 3px; vertical-align: bottom;"></td><td style="padding: 0px 3px 0px 3px; vertical-align: bottom;"></td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6473315]" style="font-weight: bold; padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">6,473,315</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6115206592]" style="font-weight: bold; padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">6,115,206,592</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5063149823]" style="font-weight: bold; padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5,063,149,823</td><td style="padding: 0px 3px 0px 3px; vertical-align: bottom;"></td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1052056769]" style="font-weight: bold; padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1,052,056,769</td></tr>
</tbody></table>
</div>
<div>
<br />
The table shows that we are caching around 6.4 million items with the majority of them falling in slabs 4, 10, and 11 and that around 1 GB of memory is being wasted. Average item size is computed from (memory requested / chunks used, rounded to the nearest byte) and is an indicator of the actual item sizes (including overhead) within each slab. An interesting point relevant to the CAS discussion is that the average item size for slab 11 is 776 bytes which is only marginally bigger than the chunk size for slab 10.<br />
<br />
Running the test code against a node with CAS disabled yields the following results:<br />
<br />
<table border="1" cellpadding="0" cellspacing="0" dir="ltr" style="border-collapse: collapse; border: 1px solid rgb(204, 204, 204); font-family: Calibri; font-size: 13px; table-layout: fixed;"><colgroup><col width="31"></col><col width="54"></col><col width="71"></col><col width="93"></col><col width="92"></col><col width="64"></col><col width="82"></col></colgroup><tbody>
<tr style="height: 20px;"><td data-sheets-value="[null,2,&quot;Slab&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Slab</td><td data-sheets-value="[null,2,&quot;Chunk Size&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Chunk Size</td><td data-sheets-value="[null,2,&quot;Chunks Used&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Chunks Used</td><td data-sheets-value="[null,2,&quot;Memory Allocated&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Allocated</td><td data-sheets-value="[null,2,&quot;Memory Requested&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Requested</td><td data-sheets-value="[null,2,&quot;Average Item Size&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Average Item Size</td><td data-sheets-value="[null,2,&quot;Memory Wasted&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom; word-wrap: break-word;">Memory Wasted</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,4]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">4</td><td data-sheets-value="[null,3,null,192]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">192</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,165990]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">165,990</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,31870080]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">31,870,080</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,29471729]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">29,471,729</td><td data-sheets-value="[null,3,null,178]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">178</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2398351]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,398,351</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,5]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">5</td><td data-sheets-value="[null,3,null,240]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">240</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,29744]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">29,744</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7138560]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">7,138,560</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6068721]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">6,068,721</td><td data-sheets-value="[null,3,null,204]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">204</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1069839]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,069,839</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,10]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">10</td><td data-sheets-value="[null,3,null,752]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">752</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3365926]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,365,926</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2531176352]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,531,176,352</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2496542132]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,496,542,132</td><td data-sheets-value="[null,3,null,742]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">742</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,34634220]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">34,634,220</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,11]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">11</td><td data-sheets-value="[null,3,null,944]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">944</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2853079]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,853,079</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2693306576]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,693,306,576</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2261103795]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,261,103,795</td><td data-sheets-value="[null,3,null,793]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">793</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,432202781]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">432,202,781</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,12]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">12</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1184]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,184</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10331]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">10,331</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12231904]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">12,231,904</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10910829]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">10,910,829</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1056]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,056</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1321075]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,321,075</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,13]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">13</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1480]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,480</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6603]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">6,603</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,9772440]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">9,772,440</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,8703301]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">8,703,301</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1318]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,318</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1069139]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,069,139</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,14]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">14</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1856]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,856</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6116]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">6,116</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11351296]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">11,351,296</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10202507]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">10,202,507</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1668]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,668</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1148789]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,148,789</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,15]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">15</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2320]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,320</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5469]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">5,469</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12688080]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">12,688,080</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11429195]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">11,429,195</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2090]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,090</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1258885]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,258,885</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,16]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">16</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2904]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,904</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4651]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">4,651</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13506504]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">13,506,504</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12137620]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">12,137,620</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2610]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,610</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1368884]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,368,884</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,17]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">17</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3632]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,632</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3629]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,629</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13180528]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">13,180,528</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11834384]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">11,834,384</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3261]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,261</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1346144]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,346,144</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,18]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">18</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4544]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">4,544</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5089]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">5,089</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23124416]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">23,124,416</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,20661849]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">20,661,849</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4060]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">4,060</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2462567]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,462,567</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,19]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">19</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5680]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">5,680</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,4557]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">4,557</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,25883760]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">25,883,760</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23299194]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">23,299,194</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5113]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">5,113</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2584566]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,584,566</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,20]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">20</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7104]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">7,104</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3786]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,786</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26895744]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">26,895,744</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23983965]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">23,983,965</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6335]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">6,335</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2911779]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,911,779</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,21]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">21</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,8880]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">8,880</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3056]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,056</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,27137280]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">27,137,280</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,24146469]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">24,146,469</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,7901]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">7,901</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2990811]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,990,811</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,22]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">22</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,11104]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">11,104</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2376]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,376</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,26383104]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">26,383,104</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,23654235]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">23,654,235</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,9955]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">9,955</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2728869]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,728,869</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,23]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">23</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,13880]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">13,880</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,2297]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">2,297</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,31882360]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">31,882,360</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,28479830]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">28,479,830</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,12399]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">12,399</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,3402530]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">3,402,530</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,24]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">24</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,17352]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">17,352</td><td data-sheets-value="[null,3,null,616]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">616</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,10688832]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">10,688,832</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,8733548]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">8,733,548</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,14178]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">14,178</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,1955284]" style="padding: 0px 3px; text-align: right; vertical-align: bottom;">1,955,284</td></tr>
<tr style="height: 20px;"><td style="padding: 0px 3px; vertical-align: bottom;"></td><td style="padding: 0px 3px; vertical-align: bottom;"></td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,6473315]" style="font-weight: bold; padding: 0px 3px; text-align: right; vertical-align: bottom;">6,473,315</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5508217816]" style="font-weight: bold; padding: 0px 3px; text-align: right; vertical-align: bottom;">5,508,217,816</td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,5011363303]" style="font-weight: bold; padding: 0px 3px; text-align: right; vertical-align: bottom;">5,011,363,303</td><td style="padding: 0px 3px; vertical-align: bottom;"></td><td data-sheets-numberformat="[null,2,&quot;#,##0&quot;,1]" data-sheets-value="[null,3,null,496854513]" style="font-weight: bold; padding: 0px 3px; text-align: right; vertical-align: bottom;">496,854,513</td></tr>
</tbody></table>
<br />
As expected, the extra 8 bytes per slab has allowed a large number of items to be moved to slabs having smaller chunk sizes with more than half of the items in slab 11 now fitting into slab 10 and saving almost 600 MB of memory. The average item size being closer to the slab chunk size is another indicator that we are making more efficient use of the memory in each slab.<br />
<br />
For reference, the size of the items each slab can contain are below. The chunk sizes are displayed when running 'memcached -vv', reformatting this into a table and calculating the maximum item size gives:<br />
<br />
<table border="1" cellpadding="0" cellspacing="0" dir="ltr" style="border-collapse: collapse; border: 1px solid #ccc; font-family: Calibri; font-size: 13px; table-layout: fixed;"><colgroup><col width="31"></col><col width="69"></col><col width="62"></col><col width="61"></col></colgroup><tbody>
<tr style="height: 20px;"><td data-sheets-value="[null,2,&quot;Slab&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom;">Slab</td><td data-sheets-value="[null,2,&quot;Chunk size&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom;">Chunk size</td><td data-sheets-value="[null,2,&quot;Max data&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom;">Max data</td><td data-sheets-value="[null,2,&quot;Min Data&quot;]" style="font-weight: bold; padding: 0px 3px; vertical-align: bottom;">Min data</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,1]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1</td><td data-sheets-value="[null,3,null,96]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">96</td><td data-sheets-value="[null,3,null,30]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">30</td><td data-sheets-value="[null,3,null,1]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,2]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2</td><td data-sheets-value="[null,3,null,120]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">120</td><td data-sheets-value="[null,3,null,54]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">54</td><td data-sheets-value="[null,3,null,31]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">31</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,3]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3</td><td data-sheets-value="[null,3,null,152]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">152</td><td data-sheets-value="[null,3,null,86]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">86</td><td data-sheets-value="[null,3,null,55]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">55</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,4]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4</td><td data-sheets-value="[null,3,null,192]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">192</td><td data-sheets-value="[null,3,null,125]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">125</td><td data-sheets-value="[null,3,null,87]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">87</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,5]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5</td><td data-sheets-value="[null,3,null,240]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">240</td><td data-sheets-value="[null,3,null,173]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">173</td><td data-sheets-value="[null,3,null,126]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">126</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,6]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">6</td><td data-sheets-value="[null,3,null,304]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">304</td><td data-sheets-value="[null,3,null,237]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">237</td><td data-sheets-value="[null,3,null,174]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">174</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,7]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7</td><td data-sheets-value="[null,3,null,384]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">384</td><td data-sheets-value="[null,3,null,317]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">317</td><td data-sheets-value="[null,3,null,238]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">238</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,8]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">8</td><td data-sheets-value="[null,3,null,480]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">480</td><td data-sheets-value="[null,3,null,413]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">413</td><td data-sheets-value="[null,3,null,318]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">318</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,9]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">9</td><td data-sheets-value="[null,3,null,600]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">600</td><td data-sheets-value="[null,3,null,533]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">533</td><td data-sheets-value="[null,3,null,414]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">414</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,10]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">10</td><td data-sheets-value="[null,3,null,752]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">752</td><td data-sheets-value="[null,3,null,685]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">685</td><td data-sheets-value="[null,3,null,534]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">534</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,11]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11</td><td data-sheets-value="[null,3,null,944]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">944</td><td data-sheets-value="[null,3,null,877]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">877</td><td data-sheets-value="[null,3,null,686]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">686</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,12]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">12</td><td data-sheets-value="[null,3,null,1184]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1184</td><td data-sheets-value="[null,3,null,1116]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1116</td><td data-sheets-value="[null,3,null,878]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">878</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,13]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13</td><td data-sheets-value="[null,3,null,1480]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1480</td><td data-sheets-value="[null,3,null,1412]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1412</td><td data-sheets-value="[null,3,null,1117]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1117</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,14]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">14</td><td data-sheets-value="[null,3,null,1856]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1856</td><td data-sheets-value="[null,3,null,1788]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1788</td><td data-sheets-value="[null,3,null,1413]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1413</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,15]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">15</td><td data-sheets-value="[null,3,null,2320]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2320</td><td data-sheets-value="[null,3,null,2252]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2252</td><td data-sheets-value="[null,3,null,1789]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1789</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,16]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">16</td><td data-sheets-value="[null,3,null,2904]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2904</td><td data-sheets-value="[null,3,null,2836]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2836</td><td data-sheets-value="[null,3,null,2253]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2253</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,17]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17</td><td data-sheets-value="[null,3,null,3632]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3632</td><td data-sheets-value="[null,3,null,3564]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3564</td><td data-sheets-value="[null,3,null,2837]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">2837</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,18]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">18</td><td data-sheets-value="[null,3,null,4544]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4544</td><td data-sheets-value="[null,3,null,4476]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4476</td><td data-sheets-value="[null,3,null,3565]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">3565</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,19]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">19</td><td data-sheets-value="[null,3,null,5680]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5680</td><td data-sheets-value="[null,3,null,5612]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5612</td><td data-sheets-value="[null,3,null,4477]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">4477</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,20]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">20</td><td data-sheets-value="[null,3,null,7104]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7104</td><td data-sheets-value="[null,3,null,7036]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7036</td><td data-sheets-value="[null,3,null,5613]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">5613</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,21]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21</td><td data-sheets-value="[null,3,null,8880]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">8880</td><td data-sheets-value="[null,3,null,8812]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">8812</td><td data-sheets-value="[null,3,null,7037]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">7037</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,22]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">22</td><td data-sheets-value="[null,3,null,11104]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11104</td><td data-sheets-value="[null,3,null,11035]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11035</td><td data-sheets-value="[null,3,null,8813]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">8813</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,23]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">23</td><td data-sheets-value="[null,3,null,13880]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13880</td><td data-sheets-value="[null,3,null,13811]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13811</td><td data-sheets-value="[null,3,null,11036]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">11036</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,24]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">24</td><td data-sheets-value="[null,3,null,17352]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17352</td><td data-sheets-value="[null,3,null,17283]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17283</td><td data-sheets-value="[null,3,null,13812]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">13812</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,25]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">25</td><td data-sheets-value="[null,3,null,21696]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21696</td><td data-sheets-value="[null,3,null,21627]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21627</td><td data-sheets-value="[null,3,null,17284]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">17284</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,26]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">26</td><td data-sheets-value="[null,3,null,27120]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">27120</td><td data-sheets-value="[null,3,null,27051]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">27051</td><td data-sheets-value="[null,3,null,21628]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">21628</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,27]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">27</td><td data-sheets-value="[null,3,null,33904]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">33904</td><td data-sheets-value="[null,3,null,33835]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">33835</td><td data-sheets-value="[null,3,null,27052]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">27052</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,28]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">28</td><td data-sheets-value="[null,3,null,42384]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">42384</td><td data-sheets-value="[null,3,null,42315]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">42315</td><td data-sheets-value="[null,3,null,33836]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">33836</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,29]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">29</td><td data-sheets-value="[null,3,null,52984]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">52984</td><td data-sheets-value="[null,3,null,52915]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">52915</td><td data-sheets-value="[null,3,null,42316]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">42316</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,30]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">30</td><td data-sheets-value="[null,3,null,66232]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">66232</td><td data-sheets-value="[null,3,null,66163]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">66163</td><td data-sheets-value="[null,3,null,52916]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">52916</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,31]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">31</td><td data-sheets-value="[null,3,null,82792]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">82792</td><td data-sheets-value="[null,3,null,82723]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">82723</td><td data-sheets-value="[null,3,null,66164]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">66164</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,32]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">32</td><td data-sheets-value="[null,3,null,103496]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">103496</td><td data-sheets-value="[null,3,null,103426]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">103426</td><td data-sheets-value="[null,3,null,82724]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">82724</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,33]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">33</td><td data-sheets-value="[null,3,null,129376]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">129376</td><td data-sheets-value="[null,3,null,129306]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">129306</td><td data-sheets-value="[null,3,null,103427]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">103427</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,34]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">34</td><td data-sheets-value="[null,3,null,161720]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">161720</td><td data-sheets-value="[null,3,null,161650]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">161650</td><td data-sheets-value="[null,3,null,129307]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">129307</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,35]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">35</td><td data-sheets-value="[null,3,null,202152]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">202152</td><td data-sheets-value="[null,3,null,202082]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">202082</td><td data-sheets-value="[null,3,null,161651]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">161651</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,36]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">36</td><td data-sheets-value="[null,3,null,252696]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">252696</td><td data-sheets-value="[null,3,null,252626]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">252626</td><td data-sheets-value="[null,3,null,202083]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">202083</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,37]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">37</td><td data-sheets-value="[null,3,null,315872]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">315872</td><td data-sheets-value="[null,3,null,315802]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">315802</td><td data-sheets-value="[null,3,null,252627]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">252627</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,38]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">38</td><td data-sheets-value="[null,3,null,394840]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">394840</td><td data-sheets-value="[null,3,null,394770]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">394770</td><td data-sheets-value="[null,3,null,315803]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">315803</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,39]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">39</td><td data-sheets-value="[null,3,null,493552]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">493552</td><td data-sheets-value="[null,3,null,493482]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">493482</td><td data-sheets-value="[null,3,null,394771]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">394771</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,40]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">40</td><td data-sheets-value="[null,3,null,616944]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">616944</td><td data-sheets-value="[null,3,null,616874]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">616874</td><td data-sheets-value="[null,3,null,493483]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">493483</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,41]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">41</td><td data-sheets-value="[null,3,null,771184]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">771184</td><td data-sheets-value="[null,3,null,771114]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">771114</td><td data-sheets-value="[null,3,null,616875]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">616875</td></tr>
<tr style="height: 20px;"><td data-sheets-value="[null,3,null,42]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">42</td><td data-sheets-value="[null,3,null,1048576]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1048576</td><td data-sheets-value="[null,3,null,1048505]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">1048505</td><td data-sheets-value="[null,3,null,771115]" style="padding: 0px 3px 0px 3px; text-align: right; vertical-align: bottom;">771115</td></tr>
</tbody></table>
<br />
This table is using the default Memcached config settings (48 min item, 1.25 growth factor, cas enabled). The "Max data" column is the maximum number of bytes that can be used to store both the key and the value for an item in this slab. The "Min data" column is the minimum data size required for an item to be put in a slab and is simply the maximum data size from the previous slab&nbsp;+ 1. With CAS disabled the max and min data values would be increased by 8 bytes for all items with the exception of the minimum data for slab 1 remaining at 1 byte. The following Python function can be used for calculating the maximum item size (key + value)&nbsp;per slab:<br />
<br />
<br /></div>
<script src="https://gist.github.com/watchamcb/8625618560c94eafb3e7.js"></script></li><li>
        <span class="post-meta">Jul 13, 2015</span>
        <h3>
          <a class="post-link" href="/2015/07/13/c-states-and-p-states-with-ubuntu-1404.html">
            C-states and P-states with Ubuntu 14.04 on Amazon EC2
          </a>
        </h3><h3>
Introduction</h3>
The largest new generation EC2 instance types now expose <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/processor_state_control.html">C-state and P-state</a> control to the operating system, unfortunately additional complexity is introduced with the added control and this post will discuss some of the issues related to this on&nbsp;Ubuntu 14.04.<br />
<br />
For comparison I am going to be using a relatively vanilla Ubuntu 14.04.02 (3.13.0-57-generic) AMI running memcached on both a c3.8xl and a c4.8xl. As a memcached workload is generally dependant on memory and network, I have enabled Receive Packet Steering (RPS) as described by <a href="http://engineering.pinterest.com/post/53467339970/building-pinterest-in-the-cloud">this</a> Pinterest article and ensuring it persists across reboots by adding it in /etc/rc.local.<br />
<br />
<h3>
More haste, less speed (TL;DR)</h3>
<div>
For those without the time or patience to read the full post, intel_pstate is disabled by default in Ubuntu 14.04 and the ondemand rc.d script will prevent optimal performance of a latency sensitive application on C-state/P-state enabled instances. Make these changes to improve latency and reduce variability:</div>
<div>
<br /></div>
<div>
1. Disable ondemand (dynamic) CPU frequency scaling</div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">$ sudo update-rc.d ondemand disable</span></div>
<div>
<div>
<div>
<br /></div>
<div>
2.&nbsp;Edit /etc/default/grub.d/50-cloudimg-settings.cfg and update the Grub command line to be:</div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;"># Set the default commandline</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_CMDLINE_LINUX_DEFAULT="console=tty1 console=ttyS0 intel_idle.max_cstate=1 intel_pstate=enable"</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
3. Install the new version of grub</div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">$ sudo update-grub</span></div>
</div>
<div>
<br /></div>
<div>
4. Reboot</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo reboot</span></div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<h3>
Not so idle (for those with time)</h3>
The first notable thing is that the idle state on the c4.8xl differs from the c3.8xl according to CloudWatch:<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgUcb0oZb0rXglsBSfx9jsmuAUrHelnRb0jyzD07kNitMQgjSvFgBNSQ-gwvwJXtwF6WeOCBwXolcAEjuS70pZgO7Jq-8w0SCo4C8Ca66UtbP7qxqrGIb0MokxHkiSFM88LPDGKf6g_3ec/s1600/idle.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="400" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgUcb0oZb0rXglsBSfx9jsmuAUrHelnRb0jyzD07kNitMQgjSvFgBNSQ-gwvwJXtwF6WeOCBwXolcAEjuS70pZgO7Jq-8w0SCo4C8Ca66UtbP7qxqrGIb0MokxHkiSFM88LPDGKf6g_3ec/s640/idle.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Idle instances c3.8xl (i-2cb4bd86) vs. c4.8xl (i-0e737ba4)</td></tr>
</tbody></table>
<br />
According to sar the c3 is marginally more idle:<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sar 1 10</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Linux 3.13.0-57-generic (ip-172-31-40-39) <span class="Apple-tab-span" style="white-space: pre;"> </span>07/12/2015 <span class="Apple-tab-span" style="white-space: pre;"> </span>_x86_64_<span class="Apple-tab-span" style="white-space: pre;"> </span>(32 CPU)</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:51 PM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:52 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:53 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:54 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:55 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:56 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:57 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:58 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:59 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:12:00 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:12:01 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<div>
<br /></div>
<br />
While the c4 is doing some system related work:<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sar 1 10</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Linux 3.13.0-57-generic (ip-172-31-34-50) <span class="Apple-tab-span" style="white-space: pre;"> </span>07/12/2015 <span class="Apple-tab-span" style="white-space: pre;"> </span>_x86_64_<span class="Apple-tab-span" style="white-space: pre;"> </span>(36 CPU)</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:46 PM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:47 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 99.97</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:48 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:49 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 99.97</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:50 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:51 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:52 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 99.94</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:53 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:54 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 99.97</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:55 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">05:11:56 PM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;100.00</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.01 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 99.99</span><br />
<div>
<br /></div>
Although this does not account for the ~0.5% CPU being reported by CloudWatch, presumably due to some overhead for C-state management. On the c3 we don't seem to have a cpuidle driver:<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /sys/devices/system/cpu/cpuidle/current_driver</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">none</span><br />
<br />
Whereas on the c4 we have:<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /sys/devices/system/cpu/cpuidle/current_driver</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">intel_idle</span><br />
<div>
<br /></div>
<h3>
Disabling C-states (intel_idle driver)</h3>
<div>
Out of interest lets see what the impact of disabling the driver is. In order to do this we need to set some kernel parameters in Grub which live in&nbsp;/etc/default/grub.d/50-cloudimg-settings.cfg on Ubuntu instances running on EC2, the updated file should look like this:</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /etc/default/grub.d/50-cloudimg-settings.cfg</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Cloud Image specific Grub settings for Generic Cloud Images</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># CLOUD_IMG: This file was created/modified by the Cloud Image build process</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the recordfail timeout</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_RECORDFAIL_TIMEOUT=0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Do not wait on grub prompt</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_TIMEOUT=0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the default commandline</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">GRUB_CMDLINE_LINUX_DEFAULT="console=tty1 console=ttyS0 intel_idle.max_cstate=0 processor.max_cstate=0"</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the grub console type</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_TERMINAL=console</span></div>
</div>
<div>
<br /></div>
<div>
And can be installed with:</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo update-grub</span></div>
<div>
<br /></div>
<div>
A relatively good explanation of the <a href="https://www.kernel.org/doc/Documentation/kernel-parameters.txt">kernel options</a> can be found on <a href="http://stackoverflow.com/questions/12111954/context-switches-much-slower-in-new-linux-kernels">stackoverflow</a>, note that the idle=poll option will cause CloudWatch to report 100% CPU and is not advised. After a reboot for the changes to take effect the following CloudWatch graph (including a default c4.8xl for comparison) shows the difference in idle CPU.</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjimmWhtbKwD1_XTqC6mGFcSGXgObrSXspb6L5hsyCnkkx4zK9J0GFBsSiRmY6YXB55B5lelDE1HsJltfKcgcc1i72mLA8-kDHw-pal5trPWZvIB5qBPMTXhUoBQrIGQoAV93Daw31qcAM/s1600/idle-no-cstate.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="400" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjimmWhtbKwD1_XTqC6mGFcSGXgObrSXspb6L5hsyCnkkx4zK9J0GFBsSiRmY6YXB55B5lelDE1HsJltfKcgcc1i72mLA8-kDHw-pal5trPWZvIB5qBPMTXhUoBQrIGQoAV93Daw31qcAM/s640/idle-no-cstate.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8000001907349px;">Idle instances c3.8xl (i-2cb4bd86) vs. c4.8xl with C-state disabled (i-0e737ba4)</span></td></tr>
</tbody></table>
<div>
<br /></div>
<div>
A notable improvement but still not identical, lets take a look at performance next.</div>
<div>
<br /></div>
<h3>
The need for speed</h3>
<div>
As the c3.8xl does not support P-states we would not expect to see a frequency scaling policy or any difference between the core CPU frequencies and this can be confirmed with the cpupower utility:</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo cpupower frequency-info</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">analyzing CPU 0:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; no or unknown cpufreq driver is active on this CPU</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; boost state support:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Supported: no</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Active: no</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; 25500 MHz max turbo 4 active cores</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; 25500 MHz max turbo 3 active cores</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; 25500 MHz max turbo 2 active cores</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; 25500 MHz max turbo 1 active cores</span></div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"></span><br />
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">
</span>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /proc/cpuinfo | grep MHz</span></div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">
<div>
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
[...]<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044<br />
cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2800.044</div>
<div>
<br /></div>
</span></div>
<div>
<br /></div>
<div>
Nothing terribly surprising here, no cpufreq driver and all the cores running at the default frequency. Looking at the c4.8xl however, we see a few noteworthy items:</div>
<div>
<br /></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo cpupower frequency-info</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">analyzing CPU 0:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; driver: acpi-cpufreq</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; CPUs which run at the same hardware frequency: 0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; CPUs which need to have their frequency coordinated by software: 0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; maximum transition latency: 10.0 us.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; hardware limits: 1.20 GHz - 2.90 GHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; available frequency steps: 2.90 GHz, 2.90 GHz, 2.80 GHz, 2.70 GHz, 2.50 GHz, 2.40 GHz, 2.30 GHz, 2.20 GHz, 2.00 GHz, 1.90 GHz, 1.80 GHz, 1.70 GHz, 1.60 GHz, 1.40 GHz, 1.30 GHz, 1.20 GHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; available cpufreq governors: conservative, ondemand, userspace, powersave, performance</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; current policy: frequency should be within 1.20 GHz and 2.90 GHz.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The governor "ondemand" may decide which speed to use</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; within this range.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; current CPU frequency is 1.20 GHz (asserted by call to hardware).</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; cpufreq stats: 2.90 GHz:1.17%, 2.90 GHz:0.00%, 2.80 GHz:0.00%, 2.70 GHz:0.01%, 2.50 GHz:0.00%, 2.40 GHz:0.00%, 2.30 GHz:0.00%, 2.20 GHz:0.00%, 2.00 GHz:0.00%, 1.90 GHz:0.00%, 1.80 GHz:0.00%, 1.70 GHz:0.00%, 1.60 GHz:0.00%, 1.40 GHz:0.00%, 1.30 GHz:0.00%, 1.20 GHz:98.82% &nbsp;(15)</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; boost state support:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Supported: yes</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Active: yes</span></div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /proc/cpuinfo | grep MHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">[...]</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1600.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 1200.000</span></div>
</div>
<div>
<br /></div>
<div>
Firstly, it seems Ubuntu is using the acpi-cpufreq driver instead of the new and improved intel_pstate driver (more on this later). Secondly we are using the 'ondemand' governor which is great for power saving but not ideal for a high performance or low latency server. Finally, thanks to the ondemand governor all of &nbsp;the cores are running significantly slower than their advertised (3.2 GHz) maximum. Some digging finds that it is related to <a href="https://bugs.launchpad.net/ubuntu/+source/sysvinit/+bug/1314653">this</a> and is relatively easy to fix by disabling /etc/init.d/ondemand:</div>
<div>
<br /></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo update-rc.d ondemand disable</span></div>
<div>
<br /></div>
<div>
Which will prevent the 'performance' governor from being replaced with 'ondemand' at the next boot. To correct the frequency without a reboot we can update the governor with cpupower:</div>
<div>
<br /></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo cpupower frequency-set -g performance</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /proc/cpuinfo | grep MHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">[...]</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 2901.000</span></div>
</div>
<div>
<br /></div>
<div>
Still not hitting the maximum frequency but this shaves a few more fractions off the idle CPU usage reported by CloudWatch:</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhopr0pTfiUQPecGA0yCdllVx2c6lIXiXxvdX-FLklLnYNh8FiHzL6AD0AMTpDrlSF7CuDqFuCCb257HDe9LG3U6-7TiCVg_8uj3hxJrZnISEOT8QO2A6KrguhGqiuYrKWUXcps3XqZY7k/s1600/idle-fix.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="396" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhopr0pTfiUQPecGA0yCdllVx2c6lIXiXxvdX-FLklLnYNh8FiHzL6AD0AMTpDrlSF7CuDqFuCCb257HDe9LG3U6-7TiCVg_8uj3hxJrZnISEOT8QO2A6KrguhGqiuYrKWUXcps3XqZY7k/s640/idle-fix.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8000001907349px;">Idle instances c3.8xl (i-2cb4bd86) vs. c4.8xl with C-state disabled and performance frequency policy (i-0e737ba4)</span></td></tr>
</tbody></table>
<br />
<h3>
Adding some stress</h3>
<div>
Thus far we have been looking at the idle CPU utilisation and have got relatively close to the same baseline performance with our customised c4.8xl. Time now to look at how adding some load changes things, starting of with a relatively simple test using 'stress' to generate artificial load on CPU and memory.</div>
<div>
<br /></div>
<div>
Using 'stress -c 4 -m 2' the c3.8xl shows the following sar average after running for a few minutes:</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">06:58:11 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">06:58:40 AM &nbsp; &nbsp; all &nbsp; &nbsp; 12.65 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;6.12 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 81.23</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; 12.63 &nbsp; &nbsp; &nbsp;0.06 &nbsp; &nbsp; &nbsp;6.14 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 81.14</span></div>
</div>
<div>
<br /></div>
<div>
The default c4.8xl shows:</div>
<div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">06:58:11 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">06:58:41 AM &nbsp; &nbsp; all &nbsp; &nbsp; 11.22 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;5.50 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 83.28</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; 11.24 &nbsp; &nbsp; &nbsp;0.15 &nbsp; &nbsp; &nbsp;5.47 &nbsp; &nbsp; &nbsp;0.03 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 83.10</span></div>
</div>
<div>
<br /></div>
<div>
And the tweaked c4.8xl (with C-states disabled and performance policy) shows:</div>
<div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">06:58:11 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">06:58:43 AM &nbsp; &nbsp; all &nbsp; &nbsp; 11.27 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;5.44 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 83.29</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; 11.23 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;5.45 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 83.32</span></div>
</div>
<div>
<br /></div>
<div>
The CloudWatch graph shows the c3 (i-2cb4bd86) averaging around 18.8%, the default c4 (i-c2b4bd68) averaging around 17.1%, and the tweaked c4 (i-0e737ba4) averaging around 16.8%. All of which match the sar %idle relatively closely:</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEimqhI9GnXt8LS1x4-K4aAzWIFvtirLBeOMXbvfZdQvl8rgIu9Lvo7S0XhEj7Czg_hAmGpsPkHM4iDyaqEJRuZjX0ViHtNejHeveujL11Fe0rHDD9BRcGabROd-Hm-TNaOm1mqv4i_9D-g/s1600/stress.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="362" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEimqhI9GnXt8LS1x4-K4aAzWIFvtirLBeOMXbvfZdQvl8rgIu9Lvo7S0XhEj7Czg_hAmGpsPkHM4iDyaqEJRuZjX0ViHtNejHeveujL11Fe0rHDD9BRcGabROd-Hm-TNaOm1mqv4i_9D-g/s640/stress.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Instances under stress c3 (i-2cb4bd86), default c4 (i-c2b4bd68), tweaked c4 (i-0e737ba4)</td></tr>
</tbody></table>
<div>
<br /></div>
<div>
Testing memcached using a simple approach of an infinite loop calling memcslap shows slightly greater differences. Two loops are started in the background to simulate a reasonable load of around 200k packets per second (admittedly on the loopback interface but good enough for now):</div>
<div>
<br /></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ while true; do memcslap --servers=&lt;server_ip_here&gt;:11211 --concurrency=10 --execute-number=10000 --binary &gt; /dev/null; done &amp;</span></div>
<div>
<br /></div>
<div>
On the c3.8xl sar shows (approximately):</div>
<div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:35:51 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:38:34 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;5.48 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;8.61 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.60 &nbsp; &nbsp; 85.31</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;5.50 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;4.62 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.33 &nbsp; &nbsp; 89.54</span></div>
</div>
</div>
<div>
<br /></div>
<div>
<div>
The default c4 shows:</div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:35:51 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:36:20 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;5.01 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.84 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 94.15</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;5.14 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.99 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 91.87</span></div>
</div>
</div>
<div>
<br /></div>
<div>
While the tweaked c4 shows:</div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:35:51 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
</div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">08:36:26 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;5.53 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.12 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 92.35</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;5.26 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.71 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 92.03</span></div>
</div>
<div>
<br /></div>
<div>
Again not much between them according to sar but CloudWatch shows some larger discrepancies in this case with CPU above 20% for all instances and the default c4 showing between 25% - 30% vs the tweaked c4 (and c3) staying mostly between 20% and 25%.</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg28HdizaDN7b2CQZdNSUWnKMBhgO0DvBd76x24v4LeEqnJp755rj7gMuzvgUZToUWvwfjQ3D2tT5s2M9fNqpkeAK4jCwO5nOz-00rP8Pv_3oAQF9GHIfsbPeLlBbch_Loq5QcG9Ra8gaQ/s1600/memcslap.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="352" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg28HdizaDN7b2CQZdNSUWnKMBhgO0DvBd76x24v4LeEqnJp755rj7gMuzvgUZToUWvwfjQ3D2tT5s2M9fNqpkeAK4jCwO5nOz-00rP8Pv_3oAQF9GHIfsbPeLlBbch_Loq5QcG9Ra8gaQ/s640/memcslap.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8000001907349px;">Instances running memcslap c3 (i-</span>2cb4bd86<span style="font-size: 12.8000001907349px;">), default c4 (i-</span>c2b4bd68<span style="font-size: 12.8000001907349px;">), tweaked c4 (i-0e737ba4)</span></td></tr>
</tbody></table>
<div>
We are clearly missing something important here, time to look at that intel_pstate driver.</div>
<div>
<br /></div>
<div>
<h3>
All about the driver (enabling intel_pstate)</h3>
</div>
<div>
As noted earlier the default cpufreq driver on Ubuntu 14.04 appears to be the legacy acpi-cpufreq driver. There is some history around this which is not really relevant here but suffice it to say that you need to opt-in to enable the intel_pstate driver. Again it is a relatively simple matter of adding a kernel option to grub and given that the evidence above shows our default c4 installation is a loser, lets make some changes to make it faster. Firstly, disable the ondemand scaling policy as we did for the the tweaked c4 earlier, next we will enable the intel_pstate driver by adding 'intel_pstate=enable' to the Grub command line, we are also going to disable the deeper C states at the same time to limit latency of waking cores (with 'intel_idle.max_cstate=1') after which we will install the new Grub config and reboot:</div>
<div>
<br /></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">$ sudo update-rc.d ondemand disable</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">...</span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /etc/default/grub.d/50-cloudimg-settings.cfg&nbsp;</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Cloud Image specific Grub settings for Generic Cloud Images</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># CLOUD_IMG: This file was created/modified by the Cloud Image build process</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the recordfail timeout</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_RECORDFAIL_TIMEOUT=0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Do not wait on grub prompt</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_TIMEOUT=0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the default commandline</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_CMDLINE_LINUX_DEFAULT="console=tty1 console=ttyS0 intel_idle.max_cstate=1 intel_pstate=enable"</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"># Set the grub console type</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">GRUB_TERMINAL=console</span></div>
</div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo update-grub</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">...</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo reboot</span></div>
<div>
<br /></div>
<div>
After the reboot, cpupower confirms that we are now using the intel_pstate driver and that our server is now super-charged at 3.2 GHz:</div>
<div>
<br /></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ sudo cpupower frequency-info</span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">analyzing CPU 0:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; driver: intel_pstate</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; CPUs which run at the same hardware frequency: 0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; CPUs which need to have their frequency coordinated by software: 0</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; maximum transition latency: 0.97 ms.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; hardware limits: 1.20 GHz - 3.50 GHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; available cpufreq governors: performance, powersave</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; current policy: frequency should be within 1.20 GHz and 3.50 GHz.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The governor "performance" may decide which speed to use</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; within this range.</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; current CPU frequency is 3.20 GHz (asserted by call to hardware).</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; boost state support:</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Supported: yes</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">&nbsp; &nbsp; Active: yes</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;"><br /></span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">$ cat /proc/cpuinfo | grep MHz</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">[...]</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">cpu MHz</span><span class="Apple-tab-span" style="font-family: 'Courier New', Courier, monospace; font-size: xx-small; white-space: pre;">  </span><span style="font-family: 'Courier New', Courier, monospace; font-size: xx-small;">: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">cpu MHz<span class="Apple-tab-span" style="white-space: pre;">  </span>: 3200.875</span></div>
</div>
<div>
<br /></div>
<div>
Rerunning the earlier memcached test shows quite a significant improvement for the P-state instance. While the sar results are quite similar, the CloudWatch graph shows the P-state instance using around 16% CPU, beating both the c3 and tweaked c4. The sar approximate average for the P-state c4:</div>
<div>
<br /></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">09:09:52 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</span></div>
<div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">09:10:36 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;7.17 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;3.75 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 89.08</span></div>
<div>
<span style="font-family: Courier New, Courier, monospace; font-size: xx-small;">Average: &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp;6.15 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.43 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 91.42</span></div>
</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgeXhktaJDSJ66HOlaCvVgSnhLyrSIzebwzQWFLjw1_9HqWi0Kb9-I-gcdfskdSEANxUlMlm4lwlb-injQmfiPaqhwzgd4hcZcsVnNI-56YpjgGRjFPP9stM3tdtR8U2lJhlBjQIAEGaFY/s1600/p_state.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="352" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgeXhktaJDSJ66HOlaCvVgSnhLyrSIzebwzQWFLjw1_9HqWi0Kb9-I-gcdfskdSEANxUlMlm4lwlb-injQmfiPaqhwzgd4hcZcsVnNI-56YpjgGRjFPP9stM3tdtR8U2lJhlBjQIAEGaFY/s640/p_state.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Instance<span style="font-size: 12.8000001907349px;">s running memcslap c3 (i-</span>2cb4bd86<span style="font-size: 12.8000001907349px;">), intel_pstate c4 (i-c2b4bd68), tweaked c4 (i-0e737ba4)</span></td></tr>
</tbody></table>
<div>
<br /></div>
<div>
For comparison rerunning the stress test from earlier (stress -c 4 -m 2):</div>
<div>
<br /></div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipJ1dGHGxoWrLJwV6xjwRxVUQGMKUzMM-P95Z4MNtLGuXy-39Bpg-nz_i5C9qRO3glZzI0zyGfJQPmlwU0FcIWYbIYl_eF6yj_8E7P_5avZGfdmv2T20mJm6wPQjiLMZ0b7kASk5ipzko/s1600/p-state_stress.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="352" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipJ1dGHGxoWrLJwV6xjwRxVUQGMKUzMM-P95Z4MNtLGuXy-39Bpg-nz_i5C9qRO3glZzI0zyGfJQPmlwU0FcIWYbIYl_eF6yj_8E7P_5avZGfdmv2T20mJm6wPQjiLMZ0b7kASk5ipzko/s640/p-state_stress.png" width="640" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8000001907349px;">Instances under stress c3 (i-2cb4bd86), intel_pstate c4 (i-c2b4bd68), tweaked c4 (i-0e737ba4)</span></td></tr>
</tbody></table>
<div>
<br /></div>
<h3>
Summary</h3>
<div>
After a relatively quick and dirty investigation it is clear that the intel_pstate driver while not enabled by default on Ubuntu 14.04 really should be the driver of choice.</div>
<div>
<br /></div>
</li><li>
        <span class="post-meta">Jun 22, 2015</span>
        <h3>
          <a class="post-link" href="/2015/06/22/aws-tip-terminating-instances-in-auto.html">
            AWS Tip: Terminating instances in an Auto Scaling group
          </a>
        </h3>EC2 instances launched by Auto Scaling really should not be terminated outside of Auto Scaling but if for some reason you (really, really) need to terminate a number of instances you may see some unexpected behaviour if you terminate them using the EC2 console. Instead of all the instances being replaced by Auto Scaling simultaneously they are replaced individually over a period of time. This means that it may take significantly longer than you would expect to get the ASG back to the original size. As an <a href="https://gist.github.com/watchamcb/fc686c70e8c2660ee7ef" target="_blank">example</a>&nbsp;an instance in my test ASG was replaced every 2 minutes, taking around 6 minutes to terminate and replace 3 instances.<br />
<br />
There are two ways of doing this more efficiently (using the supremely useful <a href="http://docs.aws.amazon.com/cli/latest/index.html" target="_blank">AWS CLI</a>), firstly by setting the group capacity and then resetting it:<br />
<br />
<br />
<script src="https://gist.github.com/watchamcb/f798d361a8b74fb0a707.js"></script></li><li>
        <span class="post-meta">Jan 19, 2015</span>
        <h3>
          <a class="post-link" href="/2015/01/19/aws-tip-of-day-working-around-s3-failed.html">
            AWS Tip of the day: Working around the S3 &quot;Failed to parse XML document&quot; exception
          </a>
        </h3>If you have S3 objects with Unicode characters that aren't supported by XML 1.0 you are likely to see an exception when calling <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/AmazonS3Client.html#listObjects(com.amazonaws.services.s3.model.ListObjectsRequest)" target="_blank">listObjects</a> in the AWS Java SDK:<br />
<div>
<br /></div>
Failed to parse XML document with handler class 
com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListBucketHandler
<div>
<br /></div>
<div>
The quick and simple solution to fix this is to set the <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/model/ListObjectsRequest.html#withPrefix(java.lang.String)" target="_blank">encoding type</a> to "url". Example code stolen from <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/ListingKeysUsingAPIs.html" target="_blank">here</a>:</div>
<div>
<br /></div>
<div>
<br /></div>
<div>
<script src="https://gist.github.com/watchamcb/5d1c92b3acb56a34b9ec.js"></script>
</div></li><li>
        <span class="post-meta">Oct 5, 2014</span>
        <h3>
          <a class="post-link" href="/2014/10/05/aws-tip-of-day-signing-requests-using.html">
            AWS Tip of the day: Signing requests using IAM instance roles
          </a>
        </h3>If you are averse to having the AWS SDKs conveniently manage&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html" target="_blank">IAM instance role</a>&nbsp;permissions and service requests (including&nbsp;<a href="http://docs.aws.amazon.com/general/latest/gr/signature-version-4.html" target="_blank">Signature V4</a>) then knowing that you need to include the IAM role token in the request header is quite important. This post describes the steps needed to sign an API request using an instance IAM role. It is assumed that you already have an instance launched with a role that has permission to perform the requested API action. For this example the role is going to be named ec2-ro and as the name implies it has read-only permissions on EC2 APIs.<br />
<br />
As a good starting point we will use the first GET example on&nbsp;<a href="http://docs.aws.amazon.com/general/latest/gr/sigv4-signed-request-examples.html" target="_blank">this</a>&nbsp;page as a working base and modify it to retrieve the instance role credentials and add the session token to the request as follows.<br />
<br />
<h4>
Step 1: Retrieve the instance role credentials</h4>
As per the AWS&nbsp;<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials" target="_blank">documentation</a>,&nbsp;instance credentials can be retrieved from the instance metadata by performing a GET against the following URL, where &lt;role-name&gt; is the name of the instance role containing the relevant permissions:<br />
<br />
http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;role-name&gt;<br />
<br />
In our example with the role named ec2-ro the result of the request will be similar to the result below where the body of the token has been replaced with [...] for brevity:<br />
<br />
$ curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro<br />
{<br />
&nbsp; "Code" : "Success",<br />
&nbsp; "LastUpdated" : "2014-10-05T07:25:22Z",<br />
&nbsp; "Type" : "AWS-HMAC",<br />
&nbsp; "AccessKeyId" : "ASIXXXXXXXXXXXX",<br />
&nbsp; "SecretAccessKey" : "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234",<br />
&nbsp; "Token" : "AXXXXXX//////////[...]==",<br />
&nbsp; "Expiration" : "2014-10-05T13:30:35Z"<br />
}<br />
<br />
Achieving the same in Python is pretty simple:<br />
<br />
creds = requests.get('http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-ro')<br />
access_key = creds.json()['AccessKeyId']<br />
secret_key = creds.json()['SecretAccessKey']<br />
token = creds.json()['Token']<br />
<div>
<br /></div>
Which we can then use to replace access key code in the example:<br />
<br />
access_key = os.environ.get('AWS_ACCESS_KEY_ID')<br />
secret_key = os.environ.get('AWS_SECRET_ACCESS_KEY')<br />
<br />
Unfortunately we are not finished yet as running the new code now results in a 401 response with the following message:<br />
<br />
"AWS was not able to validate the provided access credentials"<br />
<br />
The reason for the error above is that the instance credentials require a session token to be considered valid, moving on to the next step.<br />
<br />
<h4>
Step 2: Add the session token to the request headers</h4>
Fixing the invalid credential error above is relatively trivial and simply involves adding the session token to the request headers with a header name of x-amz-security-token. So replacing this line:<br />
<br />
headers = {'x-amz-date':amzdate, 'Authorization':authorization_header}<br />
<br />
With the following line:<br />
<br />
<span id="caseCorrespondence_27425114255_text">headers = {'x-amz-date':amzdate, 'Authorization':authorization_header, 'x-amz-security-token':token}</span><br />
<span><br /></span>
<span>Allows the code to execute successfully.&nbsp;</span>One thing to be aware of is that the instance credentials are rotated fairly frequently and the credentials will need to be refreshed after the date and time in the instance metadata Expiration field.</li><li>
        <span class="post-meta">Sep 14, 2014</span>
        <h3>
          <a class="post-link" href="/2014/09/14/aws-script-of-day-core-count.html">
            AWS script of the day: Core count
          </a>
        </h3>In case you are curious or just want to know how close you are to being a super computer, here is a quick script to count the number of cores an AWS account is currently running:&nbsp;<a href="https://github.com/watchamcb/aws/blob/master/core_count.py" target="_blank">core_count.py</a><br />
<br />
Make sure you have <a href="https://boto.readthedocs.org/en/latest/" target="_blank">boto</a> setup up first.</li><li>
        <span class="post-meta">Sep 13, 2014</span>
        <h3>
          <a class="post-link" href="/2014/09/13/aws-script-of-day-cascade-delete-of.html">
            AWS script of the day: Cascade delete of security groups
          </a>
        </h3>A common bug bear of AWS security groups is having to delete all references to a security group before deleting the group itself.&nbsp;<a href="https://github.com/watchamcb/aws/blob/master/sg_cascade_delete.py" target="_blank">Here</a>&nbsp;is a quick boto script to simplify this process, you will need to have configured boto as per these&nbsp;<a href="http://docs.pythonboto.org/en/latest/getting_started.html" target="_blank">instructions</a>. After which 'python sg_cascade_delete -h' will give you:<br />
<br />
usage: sg_cascade_delete.py [-h] [--region REGION] [--quick] [--force]<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [--quiet]<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; group_ids [group_ids ...]<br />
<br />
Remove all references to a security group and then delete it<br />
<br />
positional arguments:<br />
&nbsp; group_ids &nbsp; &nbsp; &nbsp; &nbsp;The ID of the security group to delete, eg. sg-xxxxxxx<br />
<br />
optional arguments:<br />
&nbsp; -h, --help &nbsp; &nbsp; &nbsp; show this help message and exit<br />
&nbsp; --region REGION &nbsp;AWS region name the security group is in, default: us-<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;east-1<br />
&nbsp; --quick &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Skip checks for whether or not the group is used by<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RDS/ElastiCache. Faster but may cause error on delete if<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the group is referenced.<br />
&nbsp; --force &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Force delete without requiring confirmation<br />
&nbsp; --quiet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Do not print references or success message<br />
<div>
<br /></div>
<div>
<br /></div>
<div>
An example of usage would be:</div>
<div>
python sg_cascade_delete --region eu-west-1 sg-1231234</div>
<div>
<br /></div>
<div>
This will find all references to the sg-1231234 security group in the region and display them before asking for confirmation to delete the group. Note that you will be prevented from deleting any groups used in ElastiCache or RDS security groups as doing so tends to break things in unexpected ways.</div>
<div>
<br /></div>
<div>
If you don't want to have to confirm the deletion (for a large number of groups for example) you can specify the --force option, this will skip the confirmation question and simply delete the groups after displaying their references. For example:</div>
<div>
python sg_cascade_delete --force --region eu-west-1 sg-1231234 sg-33221133</div>
<div>
<br /></div>
<div>
If you prefer your deletion silent then the --quiet option is for you, specifying this will prevent any messages being printed (other than the confirmation question and errors that occur). For no interaction at all use with --force to magically delete the groups without a sound. A non-zero process exit code indicates an error.</div>
<div>
<br /></div>
<div>
If you have a large number of ElastiCache clusters and RDS instances you can skip the reference checks by specifying the --quick &nbsp;option, this may result in errors (in VPC) if the group is actually referenced when trying to delete and will cause some strange behaviour in EC2 classic as you are actually able to delete the group leaving a dangling authorisation on the ElastiCache/RDS security group. As such it is advised that you use this option with care or when you are truly certain that the security group is not used anywhere but in EC2.</div>
<div>
<br /></div>
<div>
As this code is mutating (it changes your stuff) it would be wise to run it in a test environment before making changes in production. In other words: use at your own risk.</div>
</li><li>
        <span class="post-meta">Sep 3, 2014</span>
        <h3>
          <a class="post-link" href="/2014/09/03/aws-tip-upgrade-your-php-1x-sdk.html">
            AWS Tip: Upgrade your PHP 1.x SDK
          </a>
        </h3><span>If you are still using 1.6.2 of the&nbsp;<a href="https://github.com/amazonwebservices/aws-sdk-for-php" target="_blank">AWS PHP SDK</a>&nbsp;you can expect some strange issues, for example:</span><br />
<span><br /></span>
<span id="caseCorrespondence_27233513465_text">$ec2-&gt;describe_instances();</span><br />
<span><br /></span>
<span>Will not list T2 instance types. Save yourself some hassle and upgrade to the <a href="https://github.com/aws/aws-sdk-php" target="_blank">latest</a>&nbsp;version with the help of this&nbsp;<a href="http://docs.aws.amazon.com/aws-sdk-php/guide/latest/migration-guide.html" target="_blank">migration guide</a>.</span><br />
<br /></li><li>
        <span class="post-meta">Aug 30, 2014</span>
        <h3>
          <a class="post-link" href="/2014/08/30/aws-tip-elmoec2sg-preventing-security.html">
            AWS Tip: elmo.ec2sg preventing security group deletion
          </a>
        </h3><span>If you are trying to delete an EC2 security group and get an error something like:</span><br />
<span><br /></span>
<span id="caseCorrespondence_27243625145_text">sg-12345678: Group 111222333444:My SG Name is used by groups: 123412341234:elmo.ec2sg.887766</span><br />
<span><br /></span>
<span>Save yourself some time and check that your ElastiCache and RDS security groups don't reference (by name) the group you are trying to delete.&nbsp;</span>See <a href="https://forums.aws.amazon.com/thread.jspa?messageID=555154" target="_blank">this</a>&nbsp;forum thread.</li><li>
        <span class="post-meta">Jun 28, 2014</span>
        <h3>
          <a class="post-link" href="/2014/06/28/installing-aws-net-sdk-on-monolinux.html">
            Installing the AWS .NET SDK on Mono/Linux using NuGet
          </a>
        </h3>Following a previous <a href="http://www.deplication.net/2014/04/aws-net-sdk-on-monolinux.html">post</a> about compiling the AWS .NET SDK on Mono/Linux <a href="https://plus.google.com/114372976812620049955">+David Fevre</a> asked whether it was possible to use <a href="http://www.nuget.org/">NuGet</a> to install the SDK. It turns out that this is actually quite a bit simpler if you are running Mono 3.2+. Below are the steps required to get the AWS SDK working on Mono/Linux (Ubuntu 14.04)<br /><br />1. Install mono and associated tools, mozroots downloads root certificates to enable SSL via mono:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">sudo apt-get update<br />sudo apt-get install mono-complete git wget<br />mozroots --import --sync</span><br /><br />2. Create a working directory and change to it:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">mkdir mono-aws<br />cd mono-aws</span><br />3. Download the command line version of NuGet and verify that it is version 2.8+:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">wget http://nuget.org/nuget.exe<br />mono nuget.exe update -self</span><br /><br /> 4. Install the AWSSDK via NuGet:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">mono nuget.exe install AWSSDK</span><div>
<br /></div>
<div>
5. Create a symbolic link to the lib folder (note that the version number might be different from the example command):</div>
<div>
<span style="font-family: Verdana, sans-serif; font-size: x-small;">ln -s AWSSDK.2.1.6.0/lib/net35 lib</span><br /><br />6. Create a command line program to test with, for example in s3.cs:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">using System;<br />using Amazon.S3;<br />using Amazon.S3.Model;<br /><br />class Upload<br />{<br />&nbsp; public static void Main(string[] args)<br />&nbsp; {<br />&nbsp; &nbsp; // Create a client<br />&nbsp; &nbsp; AmazonS3Client client = new AmazonS3Client(Amazon.RegionEndpoint.USWest2);<br /><br />&nbsp; &nbsp; // Create a PutObject request<br />&nbsp; &nbsp; PutObjectRequest request = new PutObjectRequest<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; BucketName = "SampleBucket",<br />&nbsp; &nbsp; &nbsp; Key = "Item1",<br />&nbsp; &nbsp; &nbsp; ContentBody = "This is sample content..."<br />&nbsp; &nbsp; };<br /><br />&nbsp; &nbsp; // Put object<br />&nbsp; &nbsp; client.PutObject(request);<br />&nbsp; &nbsp; }<br />}</span><br /><br />7. Compile your program:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">mcs s3.cs -r:./lib/AWSSDK.dll</span><br /><br />8. Set the Mono path<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">export MONO_PATH=`pwd`/lib:.</span><br /><br />9. Create an application configuration (must be named to match the compiled program) for example in <span style="font-family: Verdana, sans-serif; font-size: x-small;">s3.exe.config:<br />&lt;?xml version="1.0"?&gt;<br />&lt;configuration&gt;<br />&nbsp; &lt;appSettings&gt;<br />&nbsp; &nbsp; &lt;add key="AWSAccessKey" value="AKXXXXXXXXXXXXXX"/&gt;<br />&nbsp; &nbsp; &lt;add key="AWSSecretKey" value="XXXXXXXXXXXXXXXXXXXXXXXX"/&gt;<br />&nbsp; &lt;/appSettings&gt;<br />&lt;/configuration&gt;</span><br /><br />10. Run your program and verify that the object is created in the bucket:<br /><span style="font-family: Verdana, sans-serif; font-size: x-small;">mono s3.exe</span></div>
</li><li>
        <span class="post-meta">Jun 27, 2014</span>
        <h3>
          <a class="post-link" href="/2014/06/27/code-snippet-adding-security-group.html">
            Code snippet: Adding a security group egress rule in boto
          </a>
        </h3>Quick example of adding an egress rule to an existing security group (turns out cidr_ip is actually required). Assumes you have&nbsp;<a href="https://github.com/boto/boto">boto</a>&nbsp;installed and your AWS credentials configured:<br />
<br />
import boto<br />
c = boto.connect_ec2()<br />
c.authorize_security_group_egress('sg-xxxxxxx', 'tcp', from_port=1024, to_port=1024, cidr_ip='0.0.0.0/0')<br />
<div>
<br /></div>
</li><li>
        <span class="post-meta">May 17, 2014</span>
        <h3>
          <a class="post-link" href="/2014/05/17/jboss-6x-as-and-log4j.html">
            JBoss 6.x AS and log4j
          </a>
        </h3>This post is a result of spending quite a bit of time working on trying to get a custom log4j (1.2) appender to work on JBoss 6.x. The purpose of this article is not to explain how to get log4j working in a WAR/JAR/EAR, if that is what you are looking for rather have a look <a href="http://blog.jyore.com/?p=234" target="_blank">here</a>, or&nbsp;<a href="https://community.jboss.org/thread/231438" target="_blank">here</a>. If you are looking to add a log4j appender to the default JBoss server logging then carry on reading.<br />
<br />
The first thing to be aware of is that log4j in JBoss 6.0 is&nbsp;<a href="https://issues.jboss.org/browse/JBAS-8791" target="_blank">broken</a>, as is also the <a href="https://issues.jboss.org/browse/JBAS-9441" target="_blank">case</a>&nbsp;in JBoss 6.1. The steps below are required to fix this and are based on clean JBoss 6.x AS installations.<br />
<br />
<h4>
1. Add and configure a log4j appender</h4>
This is done by editing the jboss-logging.xml file located in the server deployment directory (jboss-6.x.0.Final/server/default/deploy)<br />
<br />
First add an appender named "LOG4J" (or whatever you would like to call it):<br />
<br />
&nbsp; &nbsp;&lt;log4j-appender name="LOG4J" class="org.apache.log4j.FileAppender"&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;error-manager&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;only-once/&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;/error-manager&gt;<br />
<br />
&nbsp; &nbsp; &nbsp; &lt;properties&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;property name="file"&gt;${jboss.server.log.dir}/log4j.log&lt;/property&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;property name="append"&gt;true&lt;/property&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;/properties&gt;<br />
<br />
&nbsp; &nbsp; &nbsp; &lt;formatter&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;pattern-formatter pattern="%d %-5p [%c] (%t) %m%n"/&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;/formatter&gt;<br />
&nbsp; &nbsp;&lt;/log4j-appender&gt;<br />
<br />
This configuration is for a standard log4j file appender writing to a file named "log4j.log".<br />
<br />
Next you need to add your new appender to the root-logger section in the same file:<br />
<br />
&nbsp; &nbsp;&lt;root-logger&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;!-- Set the root logger priority via a system property, with a default value. --&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;level name="${jboss.server.log.threshold:INFO}"/&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;handlers&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;handler-ref name="CONSOLE"/&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;handler-ref name="FILE"/&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;handler-ref name="LOG4J"/&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;/handlers&gt;<br />
&nbsp; &nbsp;&lt;/root-logger&gt;<br />
<div>
<br /></div>
<div>
If you were to start JBoss now it would be reasonable to expect a new log file named "log4j.log" to have been created in the server/default/log/ directory, unfortunately this is not the case. And instead you are given no errors by JBoss 6.0 while JBoss 6.1 spews the only slightly more useful message below for each line it should be writing to the log file:</div>
<div>
<br /></div>
<div>
ERROR [STDERR] log4j:ERROR No output stream or file set for the appender named [null].</div>
<div>
<br /></div>
<h4>
2. Update log4j.jar packaged with JBoss installation</h4>
Download the latest version of the log4j 1.2 package from&nbsp;<a href="http://logging.apache.org/log4j/1.2/download.html" target="_blank">Apache log4j</a>&nbsp;and replace the JBoss version in&nbsp;jboss-6.x.0/common/lib. Using 1.2.17:<br />
<br />
cp apache-log4j-1.2.17/log4j-1.2.17.jar jboss-6.x.0.Final/common/lib/log4j.jar<br />
<br />
<h4>
3. Update the jboss-logging packages</h4>
Download the <a href="https://issues.jboss.org/secure/attachment/12340210/JBAS-8791-1.zip">patch</a>&nbsp;(zip)&nbsp;from the&nbsp;<a href="https://issues.jboss.org/browse/JBAS-8791" target="_blank">bug report</a>&nbsp;and unzip it. There is unfortunately no directory structure so you will need to manually copy the replacement JAR files as follows:<br />
<br />
cp jboss-logmanager-log4j.jar&nbsp;jboss-6.x.0.Final/common/lib<br />
cp jboss-logmanager.jar&nbsp;jboss-6.x.0.Final/lib<br />
cp logging-service-metadata.jar&nbsp;jboss-6.x.0.Final/server/default/deployers/jboss-logging.deployer<br />
<br />
<h4>
4. Start JBoss and enjoy your new logging framework</h4>
</li><li>
        <span class="post-meta">Apr 7, 2014</span>
        <h3>
          <a class="post-link" href="/2014/04/07/aws-net-sdk-on-monolinux.html">
            AWS .NET SDK on Mono/Linux
          </a>
        </h3>A quick guide to getting an AWS .NET console program running on Linux. Starting with the hard part, compiling the SDK from source.<br />
<br />
Update: NuGet can also be used if you are running Mono 3.2+, see&nbsp;<a href="http://www.deplication.net/2014/06/installing-aws-net-sdk-on-monolinux.html">this post</a><br />
<br />
1. Install mono and associated tools (on Ubuntu/Debian), mozroots downloads root certificates to enable SSL via mono:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">sudo apt-get update</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">sudo apt-get install mono-complete git</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mozroots --import --sync</span><br />
<br />
2. Create a working directory and change to it:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mkdir mono-aws</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mkdir mono-aws/lib</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cd mono-aws</span><br />
<br />
3. Retrieve the SDK source:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">git clone https://github.com/aws/aws-sdk-net.git</span><br />
<br />
4. Fix some file names (case is important to real operating systems). Update:&nbsp;this should be fixed in the next release of the SDK in which case it can be skipped:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cd aws-sdk-net/AWSSDK_DotNet35/</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mv Amazon.S3/Model/PUtACLResponse.cs Amazon.S3/Model/PutACLResponse.cs</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mv Amazon.S3/IAmazonS3.extensions.cs Amazon.S3/IAmazonS3.Extensions.cs</span><br />
<br />
5. Compile core library, the command line parameters are to default the compile to use .NET 3.5 and not warn on anything other than compile errors (still in aws-sdk-net/AWSSDK_DotNet35):<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">xbuild /p:TargetFrameworkProfile="" /p:WarningLevel=0</span><br />
<br />
6. Compile extensions (still in aws-sdk-net/AWSSDK_DotNet35):<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cd ../AWS.Extensions/</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">xbuild /p:TargetFrameworkProfile="" /p:WarningLevel=0</span><br />
<br />
7. Install libraries (from aws-sdk-net/AWS.Extentions):<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cd ../..</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cp aws-sdk-net/AWS.Extensions/SessionProvider/bin/Debug\ v3.5/AWS.SessionProvider.dll lib</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cp aws-sdk-net/AWS.Extensions/TraceListener/bin/Debug\ v3.5/AWS.TraceListener.dll lib</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">cp aws-sdk-net/AWSSDK_DotNet35/bin/Debug/AWSSDK.dll lib</span><br />
<br />
8. Create a command line program for example in s3.cs:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">using System;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">using Amazon.S3;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">using Amazon.S3.Model;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;"><br /></span>
<span style="font-family: Verdana, sans-serif; font-size: x-small;">class Upload</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">{</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; public static void Main(string[] args)</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; {</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; // Create a client</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; AmazonS3Client client = new AmazonS3Client(Amazon.RegionEndpoint.USWest2);</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;"><br /></span>
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; // Create a PutObject request</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; PutObjectRequest request = new PutObjectRequest</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; {</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; BucketName = "SampleBucket",</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; Key = "Item1",</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; ContentBody = "This is sample content..."</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; };</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;"><br /></span>
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; // Put object</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; PutObjectResponse response = client.PutObject(request);</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; }</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">}</span><br />
<br />
9. Compile your program:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mcs s3.cs -r:./lib/AWSSDK.dll -r:./lib/AWS.TraceListener.dll -r:./lib/AWS.SessionProvider.dll</span><br />
<br />
10. Set the Mono path<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">export MONO_PATH=`pwd`/lib:.</span><br />
<br />
11. Create an application configuration (must be named to match the compiled program) for example in&nbsp;s3.exe.config:<br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&lt;?xml version="1.0"?&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&lt;configuration&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &lt;appSettings&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;add key="AWSAccessKey" value="AKXXXXXXXXXXXXXX"/&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;add key="AWSSecretKey" value="XXXXXXXXXXXXXXXXXXXXXXXX"/&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &lt;/appSettings&gt;</span><br />
<span style="font-family: Verdana, sans-serif; font-size: x-small;">&lt;/configuration&gt;</span><br />
<div>
<br /></div>
<div>
12. Run your program:</div>
<div>
<span style="font-family: Verdana, sans-serif; font-size: x-small;">mono s3.exe</span></div>
<div>
<br /></div>
<div>
Of course there is also an easier approach that does not require the SDK to be compiled, you can just copy the DLLs from a Windows machine that has the SDK installed (typically into C:\Program Files (x86)\AWS SDK for .NET\bin\Net35). This allows you to skip steps 3 - 7.</div>
</li><li>
        <span class="post-meta">Mar 26, 2014</span>
        <h3>
          <a class="post-link" href="/2014/03/26/data-formatting-with-vim-regular.html">
            Data formatting with vim regular expressions
          </a>
        </h3>Using the right tool for a job can save massive amounts of time. This is a quick post to demonstrate a practical application of the power of regular expressions in vim. The problem is transforming the output from a SQL query into a wiki ready table format.<br />
<br />
Starting with the output from the query (test data for demonstration purposes):<br />
<br />
&nbsp;category_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp;grated &nbsp;mashed &nbsp;boiled<br />
&nbsp;-----------------------------------------------------------<br />
&nbsp; Artichoke &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;107 &nbsp; 67 &nbsp; &nbsp; 9 &nbsp; &nbsp;31<br />
&nbsp; Pepper &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;65 &nbsp; 38 &nbsp; &nbsp; 2 &nbsp; &nbsp;25<br />
&nbsp; Carrot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 46 &nbsp; 32 &nbsp;NULL &nbsp; &nbsp;14<br />
&nbsp; Lettuce &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;24 &nbsp; 24 &nbsp;NULL &nbsp;NULL<br />
&nbsp; Spinach &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp;8 &nbsp; &nbsp; 1 &nbsp; &nbsp; 7<br />
&nbsp; Zuchini &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;4 &nbsp;NULL &nbsp;NULL<br />
<br />
Paste this data excluding the heading line into vim (or pipe it to an output file and then edit the file). Firstly lets get rid of those ugly null values:<br />
<br />
:%s/NULL/0/g<br />
<br />
This searches for the character sequence "NULL" and replaces it with 0 globally. The data should now look like this<br />
<br />
&nbsp; Artichoke &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;107 &nbsp; 67 &nbsp; &nbsp; 9 &nbsp; &nbsp;31<br />
&nbsp; Pepper &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;65 &nbsp; 38 &nbsp; &nbsp; 2 &nbsp; &nbsp;25<br />
&nbsp; Carrot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 46 &nbsp; 32 &nbsp;0 &nbsp; &nbsp;14<br />
&nbsp; Lettuce &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;24 &nbsp; 24 &nbsp;0 &nbsp;0<br />
&nbsp; Spinach &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp;8 &nbsp; &nbsp; 1 &nbsp; &nbsp; 7<br />
&nbsp; Zuchini &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;4 &nbsp;0 &nbsp;0<br />
<div>
<br /></div>
<div>
Next lets format the lines and add separators:</div>
<div>
<br /></div>
<div>
:%s/^ /|-^M| /g</div>
<div>
<br /></div>
<div>
This one is a bit trickier, the ^M is actually a control character indicating a new line and is created by pressing Ctrl-V and the Enter. It searches for lines starting with white space (^ ) and inserts |- and a new line before prefixing the line with a |:</div>
<div>
<br /></div>
<div>
<div>
|-</div>
<div>
| Artichoke &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;107 &nbsp; 67 &nbsp; &nbsp; 9 &nbsp; &nbsp;31</div>
<div>
|-</div>
<div>
| Pepper &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;65 &nbsp; 38 &nbsp; &nbsp; 2 &nbsp; &nbsp;25</div>
<div>
|-</div>
<div>
| Carrot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 46 &nbsp; 32 &nbsp;0 &nbsp; &nbsp;14</div>
<div>
|-</div>
<div>
| Lettuce &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;24 &nbsp; 24 &nbsp;0 &nbsp;0</div>
<div>
|-</div>
<div>
| Spinach &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp;8 &nbsp; &nbsp; 1 &nbsp; &nbsp; 7</div>
<div>
|-</div>
<div>
| Zuchini &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;4 &nbsp;0 &nbsp;0</div>
</div>
<div>
<br /></div>
<div>
<br /></div>
<div>
Finally we want to split each number onto a separate line. This is where the power of regular expressions really shines:</div>
<div>
<br /></div>
<div>
:%s/ \+\(\d\+\)/^M| \1/g</div>
<div>
<br /></div>
<div>
The regex is actually quite simple, it says find all instances with one or more spaces ( \+) followed by one or more digits (\d\+) and save the digits for substitution (by putting them in brackets \( and \)). Then replace the pattern with a newline, a pipe and the saved digits (\1). And viola, columns to rows:</div>
<div>
<br /></div>
<div>
<div>
|-</div>
<div>
| Artichoke</div>
<div>
| 107</div>
<div>
| 67</div>
<div>
| 9</div>
<div>
| 31</div>
<div>
|-</div>
<div>
| Pepper</div>
<div>
| 65</div>
<div>
| 38</div>
<div>
| 2</div>
<div>
| 25</div>
<div>
|-</div>
<div>
| Carrot</div>
<div>
| 46</div>
<div>
| 32</div>
<div>
| 0</div>
<div>
| 14</div>
<div>
|-</div>
<div>
| Lettuce</div>
<div>
| 24</div>
<div>
| 24</div>
<div>
| 0</div>
<div>
| 0</div>
<div>
|-</div>
<div>
| Spinach</div>
<div>
| 16</div>
<div>
| 8</div>
<div>
| 1</div>
<div>
| 7</div>
<div>
|-</div>
<div>
| Zuchini</div>
<div>
| 4</div>
<div>
| 4</div>
<div>
| 0</div>
<div>
| 0</div>
</div>
<div>
<br /></div>
<div>
Pretty cool.</div>
<div>
<br /></div>
</li><li>
        <span class="post-meta">Feb 19, 2014</span>
        <h3>
          <a class="post-link" href="/2014/02/19/curl-with-kerberos-authentication.html">
            Curl with Kerberos authentication
          </a>
        </h3>Quick note on retrieving content using curl from Kerberos authenticated sites (so that I don't have to reread the man page every 6 months to figure it out). Firstly request a valid Kerberos ticket for forwarding:<br />
<br />
$ kinit -f<br />
<br />
You may need to enter your password to authenticate yourself. Next tell curl to retrieve the URL using GSS-Negotiate authentication (--negotiate) and no username or password (-u : ) as they are not used. Note that curl needs to have been compiled with support for this, check that you see GSS-Negotiate in the features list when doing a curl -V.<br />
<br />
$ curl "https://your-secure-url/path/query?param=1&amp;value=2" -u : --negotiate 
<br />
<br />
This will return the requested page and print it to console Doing the same thing in Python (with pycurl - 'pip install pycurl'):<br />
<br />
import pycurl<br />
<br />
curl = pycurl.Curl()<br />
curl.setopt(pycurl.HTTPAUTH, pycurl.HTTPAUTH_GSSNEGOTIATE)<br />
<div>
curl.setopt(pycurl.USERPWD, ':')</div>
<div>
curl.setopt(pycurl.URL, 'https://your-secure-url/path/query?param=1&amp;value=2')</div>
<div>
curl.perform()</div>
<div>
curl.close()</div>
<div>
<br /></div>
<div>
And finally in PHP:<br />
<br /></div>
<div>
<div>
$ch = curl_init();</div>
<div>
<br /></div>
<div>
curl_setopt($ch, CURLOPT_URL, "https://your-secure-url/path/query?param=1&amp;value=2");</div>
<div>
curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_GSSNEGOTIATE);</div>
<div>
curl_setopt($ch, CURLOPT_USERPWD, ":");</div>
<div>
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</div>
<div>
<br /></div>
<div>
$page = curl_exec($ch);</div>
<div>
curl_close($ch);</div>
</div>
<div>
<br /></div>
</li><li>
        <span class="post-meta">Jan 8, 2014</span>
        <h3>
          <a class="post-link" href="/2014/01/08/python-gotcha-bound-method.html">
            Python gotcha: bound method
          </a>
        </h3>A quick Python observation that will hopefully save somebody some time. Given the following Python code:<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">class Example:<br />&nbsp;&nbsp;&nbsp; X = 5<br /><br />&nbsp;&nbsp;&nbsp; def __init__(self, value):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.some_value = value<br /><br />&nbsp;&nbsp;&nbsp; def method(self, value):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if value &gt; Example.X:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 'Yup'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 'Nope'<br /><br />&nbsp;&nbsp;&nbsp; def another_method(self):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return self.method(self.some_value)</span><br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">e = Example(2)</span><br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">print e.some_value </span><br />
<br />
This code defines a class named Example, instantiates it and prints out one of the class member variables. In this case the code will print out the value "2" which is logical as it was used to instantiate the object.<br />
<br />
Extending this and trying to do:<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">print e.another_method</span><br />
<br />
Results in output that looks something like:<br />
<span style="font-family: Times,&quot;Times New Roman&quot;,serif;">&lt;bound method Example.another_method of &lt;__main__.Example instance at 0x7ffde0f4fd88&gt;&gt;</span><br />
<br />
This seems a bit strange until you realise that Python is doing exactly what you are telling it to do which is return the method object rather than invoke the method. There are two really simple fixes to this:<br />
<ol>
<li>Change the call to "print e.another_method()", this causes the method to be invoked and the result returned as expected (rather obvious really) </li>
<li>Add the @property decorator to the method definition. This allows you to access the method as a read-only property</li>
</ol>
Both approaches work but they are mutually exclusive. Changing the method definition to:<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; @property</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span><br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; def another_method(self):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return self.method(self.some_value)</span><br />
<br />
And then trying to call e.another_method() will result in the error:<br />
<span style="font-family: Times,&quot;Times New Roman&quot;,serif;">TypeError: 'str' object is not callable</span></li><li>
        <span class="post-meta">Dec 5, 2013</span>
        <h3>
          <a class="post-link" href="/2013/12/05/the-mweb-uncapped-adsl-myth.html">
            The MWEB uncapped ADSL myth
          </a>
        </h3>I was the unlucky recipient of an acceptable usage notification email from MWEB last night. It turns out that their 10Mbs uncapped account is actually a 125GB capped account and that R749 (my last MWEB bill) every month only actually buys a 1.5Mbps line. I can't say that I am terribly surprised, there is a trend with South African ADSL providers to start clamping down on "high usage" users, MWEB is merely notifying users via email when they have reached this lofty state.<br />
<br />
My only real gripe is that I am being lumped into the probably-a-pirate-downloading-24-7 group and as a result my (legal) video&nbsp;streaming is throttled to tetris block quality despite only using my line for a few hours a day. The current price war in the uncapped ADSL market is rather pointless if an uncapped account is actually subject to a throttling limit. As a user that is spending a fair amount of money on high speed internet access I would prefer if the ISP's kept their prices the same but increased their capacity. To put this in perspective lets do some theoretical bandwidth calculations.<br />
<br />
My ADSL line is rated as 10Mbps but in practice I only really get 8.5Mbps which is generally sufficient for streaming HD content (obviously depending on a number of other factors). For simplicity sake lets round this down to 8Mbs, please note the small b in Mb indicates megabit (transfer rate) not megabyte (storage). So:<br />
8Mb per second * 60 seconds = 480Mb per minute<br />
480Mb per minute * 60 minutes = 28,800Mb per hour<br />
28,800Mb per hour / 1000Mb per Gb = 28.8Gb per hour<br />
28.8Gb per hour * 24 hours = 691.2Gb per day<br />
691.2Gb per day * 30 days = 20,736Gb per month<br />
20,736Gb per month / 1000Gb per Tb = 20.736Tb per month<br />
<br />
And finally converting data transmission rate (small b) to data storage (big B) thanks to Google's handy&nbsp;<a href="https://www.google.com/search?q=terabit+to+terabyte+conversion">converter</a>:<br />
20.763Tb per month * 0.125 Tb to TB factor = 2.592TB per month<br />
<br />
So at 8Mbps the theoretical maximum I could download is 2.5 terabytes of data every month. This is what a truly uncapped service would look like and lets be honest, that is a massive amount of data. I am not expecting to be able to download this amount of data and my maximum usage is unlikely to exceed 500GB per month but I am definitely not going to get that at 10Mbps with MWEB. To be fair MWEB does not cap the account, they just throttle it to such an extent that it is effectively useless for streaming video content.<br />
<div>
<br /></div>
Lets see what you are actually getting with an uncapped 10Mbps MWEB account. First a few assumptions:<div>
<ol>
<li>The MWEB throttle level is 125GB on a 10Mb line (in other words 4GB per day, supported by anecdotal evidence)</li>
<li>The throttle speed will be 1.5Mbps</li>
<li>The throttle will be removed when the rolling 30 day average drops below 100GB (no evidence for this but taking 80% of the throttle level as it makes a nice round number)</li>
<li>Average daily usage of 4 hours (14.4GB at 28.8Gb/h)</li>
<li>Starting at the beginning of the month with a 0GB 30 day average</li>
</ol>
<div>
Using these assumptions you will reach the throttle level after 9 days (8.68 rounded up). From that point onwards you are throttled to 1.5Mbs resulting in a maximum download rate of 5.4Gb/h and data usage of 2.7GB per day (maintaining the 4 hours usage per day). At this rate the rolling average will reduce at 11.7GB per day (14.4GB - 2.7GB) and take just over 2 days to fall below the assumed throttle removal level. Reverting back to the non-throttled level it will then take another 3 days before the throttle is reactivated. This cycle will repeat and effectively means that you are paying for a 10Mb line but getting a 1.5Mb line 40% of the time, I don't like those odds.</div>
</div>
<div>
<br /></div>
<div>
If you drop the 4 hour daily usage assumption and try to maximise data usage the calculations are even more bleak. After two days at 86.4GB per day the account will be throttled, after that the maximum daily data transfer is limited to 16.2GB (again assuming the 1.5Mbs throttle stays constant). This means the total data capacity of the account is 626.4GB made up of 172.8GB (2 days at 86.4GB per day) +&nbsp;453.6 (28 days at 16.2GB per day). Using the line capacity calculation detailed earlier this means you can only actually get 23.58% (626GB out of 2654GB) of the "uncapped"&nbsp;capacity that you are paying for.&nbsp;</div>
<div>
<br /></div>
<div>
To summarise:</div>
<div>
<ul>
<li>The MWEB 10Mb uncapped account is actually a throttled account with a maximum 5GB daily usage limit.&nbsp;</li>
<li>The account will be throttled after 2 days of uninterrupted use at maximum capacity</li>
<li>The account only provides 24% of the capacity suggested by the "uncapped" label</li>
<li>The account will only provide full speed connectivity 60% of the time under normal usage (after the first month)</li>
<li>This account is not suited for consistent high quality video streaming</li>
<li>If you want to use your line at full speed for more than 2 hours a day this account is not for you</li>
</ul>
<div>
Needless to say I am in the process of cancelling my "uncapped" MWEB account.</div>
</div>
</li><li>
        <span class="post-meta">Nov 28, 2013</span>
        <h3>
          <a class="post-link" href="/2013/11/28/java-war-deployment-options-on-aws.html">
            Java WAR deployment options on AWS Elastic Beanstalk
          </a>
        </h3><h4>
Introduction </h4>
Elastic Beanstalk deployment is pretty cool for interpreted languages like <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_Python.html">Python</a>, <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_Ruby.html">Ruby</a>, or <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_PHP_eb.html">PHP</a> where all you need to do is a "git aws.push" to deploy the latest version of your application. The <a href="http://aws.amazon.com/eclipse">AWS Toolkit for Eclipse</a> is also great for Java deployments but what if you want to deploy a manually built WAR? This post lists a few of the options available. It assumes that you have already created an Elastic Beanstalk application using <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-reference-get-started.html">these</a> instructions. The example uses an application name of war-test and a WAR file named sample.war (kindly provided by Apache Tomcat <a href="http://tomcat.apache.org/tomcat-7.0-doc/appdev/sample/">here</a>).<br />
<br />
<h4>
Option 1 - AWS Console</h4>
Pretty simple, select your Beanstalk application and click the "Upload and Deploy" button. Select the WAR file and give it a version name, a few minutes later your new version is up and running.<br />
<br />
In the background the file is uploaded to an S3 bucket, a new application version linked to the bucket/object and a deployment triggered.<br />
<br />
<h4>
Option 2 - Command line</h4>
This is pretty much the same approach as for the AWS Console upload except that you need to manually perform each of the steps using the AWS CLI tools.<br />
<br />
<b>Step 1</b>: Find the S3 bucket to upload the file to, this can be done as follows:<br />
<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">aws elasticbeanstalk describe-application-versions --application-name war-test</span><br />
<br />
Which will print something like:<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">{<br />&nbsp;&nbsp;&nbsp; "ApplicationVersions": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ApplicationName": "war-test", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "VersionLabel": "git-db96ef73b33ba5ae515907c586d133b26b3489b6-1385637920942", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Description": "First commit", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateCreated": "2013-11-28T11:25:21.596Z", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateUpdated": "2013-11-28T11:25:21.596Z", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "SourceBundle": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S3Bucket": "elasticbeanstalk-us-east-1-XXXXXX", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S3Key": "git-db96ef73b33ba5ae515907c586d133b26b3489b6-1385637920942.zip"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ApplicationName": "war-test", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "VersionLabel": "Sample Application", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "SourceBundle": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S3Bucket": "elasticbeanstalk-us-east-1", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S3Key": "GenericSampleApplication"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateUpdated": "2013-11-28T11:25:12.781Z", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateCreated": "2013-11-28T11:25:12.781Z"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ]<br />}</span><br />
<br />
You are interested in is the "elasticbeanstalk-us-east-1-XXXXXX" bucket (where XXXXXX represents your bucket identifier), use this as the destination for your WAR file. You can probably also use your own (custom bucket) but I have not checked what permissions are needed to allow Elastic Beanstalk to access the files.<br />
<br />
<b>Step 2</b>: Copy your WAR file to the S3 bucket identified in Step 1. Using the CLI tools again:<br />
<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">aws s3 cp ./sample.war s3://elasticbeanstalk-us-east-1-XXXXXX/s3-sample.war</span><br />
<br />
<b>Step 3</b>: Create an application version:<br />
<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">aws elasticbeanstalk create-application-version --application-name war-test --version-label s3-upload --source-bundle S3Bucket=elasticbeanstalk-us-east-1-XXXXXX,S3Key=s3-sample.war</span><br />
<br />
<b>Step 4</b>:<b> </b>Identify the environment to update<br />
<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">aws elasticbeanstalk describe-environments --application-name war-test</span><br />
<br />
Which returns something like: <br />
<br />
<span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">{<br />&nbsp;&nbsp;&nbsp; "Environments": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ApplicationName": "war-test", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "EnvironmentName": "war-test-env", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "VersionLabel": "git-dd7d815e8251acae3560158b169d652d66479bc1-1385644793798", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Status": "Ready", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "EnvironmentId": "e-bwjydyebw9", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "EndpointURL": "54.204.44.36", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "SolutionStackName": "64bit Amazon Linux 2013.09 running Tomcat 7 Java 7", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "CNAME": "war-test-env-bffkznzafh.elasticbeanstalk.com", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Health": "Green", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateUpdated": "2013-11-28T13:20:51.828Z", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "DateCreated": "2013-11-28T11:25:29.308Z"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ]<br />}</span><br />
<br />
<span style="font-family: inherit;">Note the value of the</span> EnvironmentName (war-test-env<span style="font-family: inherit;"> in this example)</span><br />
<br />
<span style="font-family: inherit;"><b>Step 5</b>: Update the environment</span><br />
<br />
<span style="font-family: inherit;"><span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">aws elasticbeanstalk update-environment --environment-name war-test-env --version-label s3-upload</span></span><br />
<span style="font-family: inherit;"><span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;"><br /><span style="font-family: inherit;">Which will return something like:</span></span></span><br />
<br />
<span style="font-family: inherit;"><span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;">{<br />&nbsp;&nbsp;&nbsp; "ApplicationName": "war-test", <br />&nbsp;&nbsp;&nbsp; "EnvironmentName": "war-test-env", <br />&nbsp;&nbsp;&nbsp; "VersionLabel": "s3-upload", <br />&nbsp;&nbsp;&nbsp; "Status": "Updating", <br />&nbsp;&nbsp;&nbsp; "EnvironmentId": "e-bwjydyebw9", <br />&nbsp;&nbsp;&nbsp; "EndpointURL": "54.204.44.36", <br />&nbsp;&nbsp;&nbsp; "SolutionStackName": "64bit Amazon Linux 2013.09 running Tomcat 7 Java 7", <br />&nbsp;&nbsp;&nbsp; "CNAME": "war-test-env-bffkznzafh.elasticbeanstalk.com", <br />&nbsp;&nbsp;&nbsp; "Health": "Grey", <br />&nbsp;&nbsp;&nbsp; "DateUpdated": "2013-11-28T14:13:42.836Z", <br />&nbsp;&nbsp;&nbsp; "DateCreated": "2013-11-28T11:25:29.308Z", <br />&nbsp;&nbsp;&nbsp; "Resources": {}<br />}</span></span><br />
<span style="font-family: inherit;"><span style="font-family: &quot;Helvetica Neue&quot;,Arial,Helvetica,sans-serif;"><br /></span>Rerun step 4 until the Health reflects as "Green" which indicates your updated application has been deployed (but does not neccessarily mean it is working).</span><br />
<span style="font-family: inherit;"></span></li><li>
        <span class="post-meta">Nov 27, 2013</span>
        <h3>
          <a class="post-link" href="/2013/11/27/self-contained-jar-file-creation-using.html">
            Self-contained JAR file creation using Maven Shade Plugin
          </a>
        </h3>Trick for the day. Adding the Maven Shade Plugin (as described <a href="http://maven.apache.org/plugins/maven-shade-plugin/examples/executable-jar.html">here</a>) to your pom.xml allows you to generate a self-contained executable JAR file including all libraries and dependencies.<br />
<br />
"mvn package" to generate the JAR and then "java -jar mypackage.jar" to run. Useful for creating self-contained artifacts for offline distribution or for locking dependency versions.</li><li>
        <span class="post-meta">Nov 20, 2013</span>
        <h3>
          <a class="post-link" href="/2013/11/20/python-cxoracle-on-ubuntu-1204.html">
            Python cx_Oracle on Ubuntu 12.04
          </a>
        </h3>There are some <a href="http://maxolasersquad.blogspot.com/2011/04/cxoracle-on-ubuntu-1104-natty.html">older</a> articles on getting cx_Oracle working using RPMs and alien but it seems Oracle are now providing non-RPM downloads. Below are the (quick and dirty) steps I followed to get it installed on Ubuntu 12.04 x64.<br />
<br />
<ol>
<li>Download both the "Instant Client Package - Basic Lite" and "Instant Client Package - SDK" ZIP files from the <a href="http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html">Oracle Instant Client</a> download page (taking note of the version of Oracle you are connecting to)</li>
<li>Unzip both the files, they will create a directory correponding to the Oracle version, instantclient_11_2 for example</li>
<li>Change to the instantclient directory created in the previous step and:</li>
<ul>
<li>Create symbolic links to the version specific files:&nbsp;</li>
<ul>
<li>libclntsh.so -&gt; libclntsh.so.11.1&nbsp;</li>
<li>libocci.so -&gt; libocci.so.11.1</li>
</ul>
<li>Create a lib directory (mkdir lib)</li>
<li>Move lib* to the lib directory (mv lib* lib)</li>
<li>Move header files from ./sdk/include to . (mv ./sdk/include/*.h .)</li>
</ul>
<li>Optionally move the instantclient directory to another location </li>
<li>Sudo to root (sudo -s) and build the module:</li>
<ul>
<li>Install the python-dev package (apt-get install python-dev) </li>
<li>Export environment variables:&nbsp;</li>
<ul>
<li>export ORACLE_HOME="path/to/instantclient"</li>
<li>export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$ORACLE_HOME/lib"</li>
</ul>
<li>Install the cx_oracle module using pip (pip install cx_oracle)</li>
<li>Hopefully get a "Successfully installed cx-oracle" message</li>
</ul>
<li>Exit the root shell (Ctrl-D)</li>
<li>Add the ORACLE_HOME and LD_LIBRARY_PATH environment variables to your profile (or just manually export them)</li>
<li>Launch python and test:</li>
</ol>
&gt;&gt;&gt; import cx_Oracle<br />&gt;&gt;&gt; dsn = cx_Oracle.makedsn('host', port, 'sid')<br />&gt;&gt;&gt; connection = cx_Oracle.connect('user','password',dsn)<br />&gt;&gt;&gt; cursor = connection.cursor()<br />&gt;&gt;&gt; results = cursor.execute("select id from table where ROWNUM &lt;= 10")<br />&gt;&gt;&gt; cursor.fetchall()<br />[(705,), (718,), (719,), (721,), (725,), (726,), (727,), (737,), (748,), (769,)]<br />&gt;&gt;&gt; cursor.close()<br />&gt;&gt;&gt; connection.close()<br /><br /><ol><ul>
</ul>
</ol>
</li><li>
        <span class="post-meta">Nov 14, 2013</span>
        <h3>
          <a class="post-link" href="/2013/11/14/fixing-compile-error-for-aws-java-sample.html">
            Fixing compile error for AWS Java sample
          </a>
        </h3>If you are getting an error like:<br />
<br />
~/aws-java-sample/src/main/java/com/amazonaws/samples/S3Sample.java:[94,31] error: for-each loops are not supported in -source 1.3<br />
<br />
When trying to build the aws-java-sample from GitHub you can fix it by adding the maven compile source and target (see <a href="http://maven.apache.org/plugins/maven-compiler-plugin/examples/set-compiler-source-and-target.html">link</a>). Something like:<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;plugin&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;version&gt;3.1&lt;/version&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;configuration&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;source&gt;1.6&lt;/source&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;target&gt;1.6&lt;/target&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/configuration&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/plugin&gt;<br />
<br />
<a href="https://github.com/mvrueden/aws-java-sample/commit/5797268d9ad34ad2605ac41e8ea5cb07050e4974">Fix</a> submitted on GitHub by mvrueden.</li><li>
        <span class="post-meta">Aug 16, 2013</span>
        <h3>
          <a class="post-link" href="/2013/08/16/ruby-devkit-compilation-errors-on.html">
            Ruby DevKit compilation errors on Windows
          </a>
        </h3>Lesson for the day, when installing Ruby <a href="https://github.com/oneclick/rubyinstaller/wiki/Development-Kit">DevKit</a>&nbsp;on Windows ensure that the Ruby installation architecture matches the DevKit architecture.<br />
<br />
ruby --version<br />
ruby 2.0.0p247 (2013-06-27) [x64-mingw32]<br />
<br />
Note the [x64-mingw32], you will get some strange compilation errors trying to install gems using the 32 bit DevKit with 64 bit Ruby (and vice-versa).<br />
<br /></li><li>
        <span class="post-meta">Jun 26, 2013</span>
        <h3>
          <a class="post-link" href="/2013/06/26/yesterday-perl-script.html">
            Yesterday Perl script
          </a>
        </h3>A quick script to display yesterday's date in a specified date format:<br />
<br />
#!/bin/perl -w<br />
<br />
use strict;<br />
use POSIX qw(strftime);<br />
use Time::Local;<br />
<br />
{<br />
&nbsp; &nbsp;my $yesterday=time() - (24 * 60 * 60);<br />
&nbsp; &nbsp;print strftime("%d%m%Y", localtime($yesterday));<br />
}<br />
<div>
<br /></div>
</li><li>
        <span class="post-meta">May 9, 2013</span>
        <h3>
          <a class="post-link" href="/2013/05/09/the-dumpstack-code-monster-alive-and.html">
            The dumpStack code monster - alive and scary
          </a>
        </h3>Tracing through some critical code in a core application I stumbled across the following:<br />
<br />
<br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; <span style="color: #cc0000;">public boolean</span> process(PSEvent event) {</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; Thread.dumpStack();</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #cc0000;">return</span> process(event, <span style="color: #cc0000;">true</span>);</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><br /></span>
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; <span style="color: #cc0000;">public boolean</span> process(PSEvent event, <span style="color: #cc0000;">boolean </span>markAsProcessed) {</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #cc0000;">boolean </span>success = <span style="color: #cc0000;">false</span>;</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><br /></span>
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; try {</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.dumpStack();</span><br />
<span style="background-color: white; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #38761d;">// Do some stuff...</span></span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><br /></span>
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; } <span style="color: #cc0000;">catch </span>(Exception e) {</span><br />
<span style="background-color: white; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #38761d;">// Do some other stuff...</span></span><br />
<span style="background-color: white; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = </span><span style="color: #cc0000; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">false</span><span style="background-color: white; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">;</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><br /></span>
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #cc0000;">return </span>success;</span><br />
<span style="background-color: white; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<div>
<br /></div>
<br />
The javadoc on Thread.dumpStack() is very helpful:<br />
Prints a stack trace of the current thread to the standard error stream. This 
method is used only for debugging.<br />
<br />
But wait, it gets better. Searching the production logs for just one of the ten or so processes that use this code:<br />
<br />
<br />
$ grep -c "java.lang.Exception: Stack trace" pickme.log<br />
230722<br />
<div style="font-family: inherit;">
<br /></div>
<div style="font-family: inherit;">
Yes, that is 230,722 stack traces generated for one process in one day. Any surprise at the load averages: 19.33, 16.91, 16.55</div>
<br />
<br />
<div>
<br /></div>
</li><li>
        <span class="post-meta">Mar 26, 2013</span>
        <h3>
          <a class="post-link" href="/2013/03/26/missing-a-in-asynchronous-part-1.html">
            Missing the A in Asynchronous - Part 1
          </a>
        </h3>Few things are more irritating in software development than when people use a&nbsp;<a href="http://en.wikipedia.org/wiki/Kludge">kludge</a>&nbsp;rather than taking the time to implement a properly designed and robust solution. The peeve I am exercising today relates to the code snippet that follows:<br />
<br />
<br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; <span style="color: #e06666;">private </span>BOTransfer getTransferInefficiently(Trade trade) <span style="color: #e06666;">throws </span>RemoteException {</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span style="white-space: pre;">&nbsp;   </span><span style="color: #6aa84f;">// There is some delay between when a trade and corresponsing transfer is created</span></span><br />
<span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;"><span style="white-space: pre;">&nbsp;   </span>BOTransfer transfer = </span><span style="color: #e06666; font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">null</span><span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">    </span><span style="color: #e06666;">int </span>cnt = 0;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">        </span><span style="color: #e06666;">do </span>{</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #e06666;">try </span>{</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">                </span>Thread.sleep(500l);</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span style="color: #e06666;">catch</span> (Exception e) {</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">               </span><span style="color: #e06666;">return null</span>;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transfer = getFirstTransfer(trade);</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">        </span>} <span style="color: #e06666;">while </span>(cnt++ &lt; 10 &amp;&amp; transfer == <span style="color: #e06666;">null</span>);</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">        </span><span style="color: #e06666;">return</span> transfer;</span><br />
<span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; }</span><br />
<div>
<br /></div>
<div>
The code is pretty simple. Wait 500ms and try and load a transfer object from the trade, repeat until the transfer object is loaded or the number of load attempts reaches 10. In a single threaded or single user environment this code might be excusable. In a multi-user production trading system processing hundreds of transactions a second this implementation is totally unacceptable. Some well meaning soul has added a comment further explaining the method:</div>
<div>
<br /></div>
<div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // This implementation is fundamentally broken in many ways. The transfer creation is</span></div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // asynchronous and this logic should be triggered off the transfer creation event (instead of</span></div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // looping and sleeping). This approach prevents this engine thread from processing any other</span></div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // events and will not find the transfer in the case where the TransferEngine is under heavy</span></div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // load. useInefficientWaitForTransfer method added to the interface to allow correct</span></div>
<div>
<span style="color: #6aa84f; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; font-size: x-small;">&nbsp; &nbsp; // implementation on new classes</span></div>
</div>
<div>
<br /></div>
<div>
This person at least understood that the code was a problem and tried to mitigate the risks by extracting it into a separate method and adding the explanatory comment. Unfortunately for whatever reason (time constraints, lack of automated regression testing, indifference, ...) they only raised the visibility of the problem rather than fixing it entirely.</div>
<div>
<br /></div>
<h4>
Issues</h4>
Increased system load - the call to&nbsp;<span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">getFirstTransfer</span>&nbsp;actually does a remote call and a database query each time it is executed. This means that in the worst case (when the system is probably already overloaded) 10 database queries are executed at half a second intervals for 5 seconds (per thread), a great way to further degrade performance.<br />
<div>
<div>
<br /></div>
<div>
Poor thread pool usage - the&nbsp;<span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">getTransferInefficiently</span>&nbsp;method is run from a static sized thread pool responsible for handling all requests queued for this process (typically between a few hundred and a few thousand per second). For each thread looping in this method there are numerous other requests that could have been processed instead. In the worst case if all threads are handling requests requiring this method then for a few seconds potentially thousands of requests will be queued unnecessarily.</div>
</div>
<div>
<br /></div>
<div>
Poor transparency - under heavy load most of the invocations of the method will return null as the transfer object will not have been created and consequently can't be loaded in the timeout (despite adding significant load to the already strained system). There is also no mechanism for measuring the average time taken for the object to be created and no backoff policy to try and reduce server load.<br />
<br />
<h4>
Solution</h4>
</div>
<div>
The correct implementation to achieve the desired behaviour asynchronously is relatively simple. A separate process should register/subscribe to BOTransfer events, on successful transfer creation perform the processing currently performed on the object returned by the&nbsp;<span style="font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: x-small;">getTransferInefficiently</span>&nbsp;method.</div>
</li><li>
        <span class="post-meta">Jul 12, 2012</span>
        <h3>
          <a class="post-link" href="/2012/07/12/ignored-ejb3-column-name-attribute.html">
            Ignored EJB3 @Column name attribute
          </a>
        </h3>I am working on an EJB3 project after a few months on other work and I ran into a small issue with the EJB3 @Column name attribute. The attribute is meant to allow the mapping of a column to a different name in an entity. If your database table has an unusable (or just unfriendly) column name you can map it to a more logical field name in the entity.<br />
<br />
In my case the table is a mapping table that I am creating an object model against and I wanted to map the "sub_account_name" column to "name". My initial implementation was as follows:<br />
<br />
<br />
<span style="color: #999999;">@Entity</span><br />
<span style="color: #999999;">@Table</span>(name = "<span style="color: blue;">portfolio_subaccount</span>")<br />
<span style="color: #990000;">public class</span> Portfolio <span style="color: #990000;">implements</span> Serializable {<br />
&nbsp; &nbsp; <span style="color: #990000;">private static final long</span> <span style="color: blue;">serialVersionUID </span>= 3450488234689579105L;<br />
<br />
&nbsp; &nbsp; <span style="color: #999999;">@Id</span><br />
<span style="color: #999999;">&nbsp; &nbsp; @GeneratedValue</span><br />
&nbsp; &nbsp; <span style="color: #990000;">private long </span><span style="color: blue;">id</span>;<br />
<span style="background-color: white;">&nbsp; &nbsp; <span style="color: #990000;">private </span>String <span style="color: blue;">name</span>;</span><br />
<br />
&nbsp; &nbsp; <span style="color: #990000;">public long</span> getId() {<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #990000;">return </span><span style="color: blue;">id</span>;<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp; <span style="color: #990000;">public void</span> setId(<span style="color: #990000;">long </span>id) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #990000;">this</span>.<span style="color: blue;">id </span>= <span style="color: blue;">id</span>;<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp; <span style="color: #999999;">@Column</span>(name = "<span style="color: blue;">sub_account_name</span>", nullable = <span style="color: #990000;">true</span>)<br />
&nbsp; &nbsp; <span style="color: #990000;">public </span>String getName() {<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #990000;">return </span><span style="color: blue;">name</span>;<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp; <span style="color: #990000;">public void</span> setName(String name) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; this.<span style="color: blue;">name </span>= <span style="color: blue;">name</span>;<br />
&nbsp; &nbsp; }<br />
}<br />
<br />
<br />
The deployment does not report any errors however the test client code below causes a GenericJDBCException to be thrown.<br />
<br />
<br />
<span style="color: #990000;">public class </span>Client {<br />
<br />
&nbsp; &nbsp; <span style="color: #990000;">public static void </span>main(String[] args) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; try {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Context context = getInitialContext();<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BeanRemote remote = (BeanRemote) context.lookup("<span style="color: blue;">SomeBean/remot</span>e");<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Portfolio portfolio = remote.getPortfolio(352);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.<span style="color: blue;">out</span>.println(portfolio.getId() + <span style="color: blue;">": "</span> + portfolio.getName());<br />
&nbsp; &nbsp; &nbsp; &nbsp; } <span style="color: #990000;">catch </span>(Exception e) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e.printStackTrace();<br />
&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp; <span style="color: #990000;">private static</span> Context getInitialContext() <span style="color: #990000;">throws </span>NamingException {<br />
&nbsp; &nbsp; &nbsp; &nbsp; Properties props = new Properties();<br />
&nbsp; &nbsp; &nbsp; &nbsp; props.put(Context.<span style="color: blue;">PROVIDER_URL</span>, "<span style="color: blue;">jnp://server:1099</span>");<br />
&nbsp;&nbsp;<span style="background-color: white;">&nbsp; &nbsp; &nbsp; props.put(Context.<span style="color: blue;">URL_PKG_PREFIXES</span>, "<span style="color: blue;">org.jboss.naming:org.jnp.interfaces</span>");</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; props.put(Context.<span style="color: blue;">INITIAL_CONTEXT_FACTORY</span>, "<span style="color: blue;">org.jnp.interfaces.NamingContextFactory</span>");<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #990000;">return new</span> InitialContext(props);<br />
&nbsp; &nbsp; }<br />
<span style="background-color: white;">}</span><br />
<br />
The exception (from the server logs) indicates that the name column is not found on the table:<br />
<br />
2012-07-12 11:37:28,049 ERROR [org.hibernate.util.JDBCExceptionReporter] (WorkerThread#2[172.19.216.159:34038]) Invalid column name 'name'.<br />
<div>
<br /></div>
<div>
Which is quite interesting given the annotation indicating the column is actually called "sub_account_name". The problem is caused by the location of the annotation, it seems that Hibernate does not handle some annotations being on the variable declaration while others are on the accessor methods. Moving the @Column annotation to the variable declaration corrects the problem. The corrected class is below.</div>
<div>
<br /></div>
<div>
<span style="color: #999999;">@Entity</span><br />
<span style="color: #999999;">@Table</span>(name = "<span style="color: blue;">portfolio_subaccount</span>")<br />
<span style="color: #990000;">public class</span>&nbsp;Portfolio&nbsp;<span style="color: #990000;">implements</span>&nbsp;Serializable {<br />
&nbsp; &nbsp;&nbsp;<span style="color: #990000;">private static final long</span>&nbsp;<span style="color: blue;">serialVersionUID&nbsp;</span>= 3450488234689579105L;<br />
<br />
&nbsp; &nbsp;&nbsp;<span style="color: #999999;">@Id</span><br />
<span style="color: #999999;">&nbsp; &nbsp; @GeneratedValue</span><br />
&nbsp; &nbsp;&nbsp;<span style="color: #990000;">private long&nbsp;</span><span style="color: blue;">id</span>;<br />
<br />
&nbsp; &nbsp;&nbsp;<span style="color: #999999;">@Column</span>(name = "<span style="color: blue;">sub_account_name</span>", nullable =&nbsp;<span style="color: #990000;">true</span>)<br />
<span style="background-color: white;">&nbsp; &nbsp;&nbsp;<span style="color: #990000;">private&nbsp;</span>String&nbsp;<span style="color: blue;">name</span>;</span><br />
<br />
&nbsp; &nbsp;&nbsp;<span style="color: #990000;">public long</span>&nbsp;getId() {<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #990000;">return&nbsp;</span><span style="color: blue;">id</span>;<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp;&nbsp;<span style="color: #990000;">public void</span>&nbsp;setId(<span style="color: #990000;">long&nbsp;</span>id) {<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #990000;">this</span>.<span style="color: blue;">id&nbsp;</span>=&nbsp;<span style="color: blue;">id</span>;<br />
&nbsp; &nbsp; }<br />
<br />
<span style="background-color: white;">&nbsp; &nbsp;</span><span style="background-color: white;">&nbsp;</span><span style="background-color: white; color: #990000;">public&nbsp;</span><span style="background-color: white;">String getName() {</span><br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #990000;">return&nbsp;</span><span style="color: blue;">name</span>;<br />
&nbsp; &nbsp; }<br />
<br />
&nbsp; &nbsp;&nbsp;<span style="color: #990000;">public void</span>&nbsp;setName(String name) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; this.<span style="color: blue;">name&nbsp;</span>=&nbsp;<span style="color: blue;">name</span>;<br />
&nbsp; &nbsp; }<br />
}<br />
</div>
<br />
<br /></li><li>
        <span class="post-meta">Jun 8, 2012</span>
        <h3>
          <a class="post-link" href="/2012/06/08/getting-intranet-website-authentication.html">
            Getting intranet website authentication wrong
          </a>
        </h3>Website usability is as important for internal sites as for publicly accessible sites, yet for some reason the corporate whip-crackers are willing to accept substandard implementations when only their employees are being forced to use a service. The points below are problems in a leave management system provided by a major international company. It is unclear whether this international company or their local implementation team is responsible for the usability idiocy but here are some of the more annoying design problems:<br />
<br />
<ul>
<li><b>Authentication integration</b>. In most large corporations some form of central authentication service is typically available. There is very rarely a need to reinvent the security wheel by having internal websites with their own username and password authentication system. This is one of the worst usability failures as it is pure laziness by the implementer to use the out-of-box authentication rather than integrating to the central authentication service.</li>
<li><b>Username selection</b>. Assuming laziness wins out and the site implements its own internal authentication, try to allow logical usernames. An employee ID code is a great database key but expecting employees to memorise their employee ID is totally ridiculous, particularly for a system they are not accessing daily. If you are unable/unwilling to let the users log in with their network credentials at least allow them to use an easy to remember username, their email address at the company for example.</li>
<li><b>Password constraints</b>. Continuing with the custom authentication assumption, try to minimise user frustration with password selection criteria. Weak passwords are obviously a security concern but for internal sites where local network access is required this is less of an issue. Simplistic password constraints only serve to frustrate users. The most ridiculous (actual) example is not allowing repeating characters, thus the strong password "M@ss!veAtt4ck" is rejected yet "Idiot123" is allowed. This is not increasing security, it is needlessly annoying your users.</li>
<li><b>Reset password process</b>. Should the user need to reset their password, try to simplify the process. On the login screen there will typically be a "Forgot password" link, it is really trivial to use the username already entered on the login page to populate the reset password page. Requiring the user to re-enter the username on the reset password page is redundant, even if it is an easily remembered value. Similarly, once the password reset is complete (via email redirect for example) rather populate the username on the login screen automatically, or preferably log the user in automatically with the newly created password.</li>
</ul>
<div>
The issues above only relate to the process of logging into the website, it is not hard to imagine the (un)usability of the rest of the site.</div></li><li>
        <span class="post-meta">Jun 7, 2012</span>
        <h3>
          <a class="post-link" href="/2012/06/07/bash-script-to-extract-dependencies.html">
            Bash script to extract dependencies from Java WebStart
          </a>
        </h3>A quick script to retrieve all the WebStart artifacts from a JNLP file and generate a corresponding classpath:<br />
<br />
<br />
<span style="color: blue; font-family: 'Courier New', Courier, monospace;">#!/bin/bash</span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><br /></span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><span style="color: cyan;">SERVER</span>=http://server:<span style="color: red;">8082</span>/e-calypso/</span><br />
<span style="font-family: 'Courier New', Courier, monospace;">wget <span style="color: magenta;">-Nrq -nd $SERVER</span>/html/jaws/calypso.jnlp</span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><span style="color: cyan;">CP</span>=<span style="color: orange;">""</span></span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><span style="color: orange;">for</span> jar <span style="color: orange;">in</span> <span style="color: magenta;">`cat calypso.jnlp</span> <span style="color: orange;">| grep</span> jar <span style="color: orange;">|</span> <span style="color: magenta;">cut -d</span><span style="color: orange;">"</span><span style="color: magenta;">\"</span><span style="color: orange;">"</span> <span style="color: magenta;">-f</span> <span style="color: red;">2</span><span style="color: magenta;">`</span></span><br />
<span style="color: orange; font-family: 'Courier New', Courier, monospace;">do</span><br />
<span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: cyan;">CP</span>=<span style="color: orange;">"</span><span style="color: magenta;">$CP</span><span style="color: red;">:./lib/</span><span style="color: orange;">"</span><span style="color: magenta;">`echo $jar</span> <span style="color: orange;">|</span> <span style="color: magenta;">cut -d</span>"<span style="color: magenta;">/</span>" <span style="color: magenta;">-f</span> <span style="color: red;">3</span><span style="color: magenta;">`</span></span><br />
<span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; wget -Nrq -nd <span style="color: magenta;">$SERVER$jar</span></span><br />
<span style="color: red; font-family: 'Courier New', Courier, monospace;">done</span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><span style="color: orange;">echo </span><span style="color: magenta;">$CP</span> <span style="color: orange;">&gt;</span> classpath</span><br />
<div>
<br /></div>
<div>
<br /></div>
<div>
The function of the script is pretty simple, it retrieves the JNLP file from the server and then extracts all jar references in the file to retrieve the corresponding JAR files. As the JAR files are being retrieved they are added (in the correct order) to a variable to be used as the classpath.&nbsp;</div>
<div>
<br /></div>
<div>
The need for this script arose from a requirement to have a client application launch using the correct dependencies and classpath ordering as used by the WebStart application. An alternative approach would have been to create a new WebStart JNLP with the new application as the entry point, unfortunately this was not practical given the organisational constraints (no access to deploy the change and 6+ week lead time for deployment via the approved process).</div>
<div>
<br /></div>
<div>
Some useful side effects of this approach:</div>
<div>
<ul>
<li>It can be used to launch the application in the JNLP without requiring a WebStart launcher</li>
<li>The application can be launched with additional JVM arguments not supported by WebStart</li>
</ul>
<div>
A few notes on the script (as always):</div>
</div>
<div>
<ol>
<li>The -Nrq command line option to wget uses time stamps (-N) to ensure only new files are downloaded. The existing files are overwritten (-r) with the latest version, rather than having a number appended to the file name as is the default behaviour for wget. The output from wget is suppressed by the -q option so as not to print out unnecessary information.</li>
<li>The -nd command line option prevents wget from creating directory structures when retrieving the files, this simplifies the classpath creation.</li>
<li>The generation of the classpath could be improved with a regular expression rather than expecting a specific format in the JNLP file.</li>
</ol>
</div></li><li>
        <span class="post-meta">Apr 12, 2012</span>
        <h3>
          <a class="post-link" href="/2012/04/12/calypso-v12-api-changes-disconnecting.html">
            Calypso v12 API changes - Disconnecting a client from the DataServer
          </a>
        </h3>In previous versions of Calypso the following code would have worked as expected:<div><br />
</div><div><div>DSConnection ds = ConnectionUtil.connect(username, password, appName, environmentName);</div><div>// Do some stuff ...</div><div>ds.disconnect();</div><div><br />
</div><div>In the v12 API (SP5) the disconnect() method has been deprecated and unfortunately the JavaDocs were not updated to specify that the DSConnection.logout() method must be used instead. This is also not mentioned in the developer guide, nor is the fact that the client application will not be able to complete cleanly (at least without a call to System.exit()) before the logout() method is called.</div><div><br />
</div><div>A more logical deprecation implementation would have been to call DSConnection.logout() from the disconnect() method.</div><div><br />
</div></div></li><li>
        <span class="post-meta">Jan 31, 2012</span>
        <h3>
          <a class="post-link" href="/2012/01/31/spot-defect-xml-string-manipulation.html">
            Spot the defect - XML string manipulation
          </a>
        </h3>So I have been a bit lazy about posting recently, time to look at a defect found in some production code:<br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String details = XPathReader.getValueAt(detailPath, xml);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (details != null &amp;&amp; details.length() &gt; 0) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String mappedDetails = getFormattedDetails(details, accId, pay);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger.info("Details [" + details + "] replaced with [" + mappedDetails + "]");<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xml = xml.replace("Details=\"" + details + "\"", "Details=\"" + mappedDetails + "\"");<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return xml;<br />
<br />
At first glance there is nothing particularly wrong with this code, the XPathReader class extracts a value from a specific path in the XML, some mapping is done on the value and the original value us replaced with the updated details. Unfortunately there is a sneaky defect in this code. The log message printed for the problematic input is:<br />
<br />
INFO &nbsp;[MappingSessionBean] Details [Book##VALUE&amp;DEV] replaced with [Book VALUE 111111111]<br />
<br />
Take a moment to see if you are able to spot the problem... Not yet apparent? The input XML (with some details replaced):<br />
<br />
<br />
&lt;RequestXML xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;Header Sending_System="SOURCE" Message_Identifier="Update"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Message_Status="New" Message_Name="Nostro Update" /&gt;<br />
&nbsp; &nbsp; &nbsp; &lt;AccountingInfo BICCode="XXXXXXXX" CurrencyCode="USD"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TradingArea="Book" Amount="12345.67/NEW/11111111/444444.44"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ValueDate="2011-11-11+0200" Details="Book##VALUE&amp;amp;DEV"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionReference="111111111" AccountType="PRINCIPAL" /&gt;<br />
&lt;/RequestXML&gt;<br />
<br />
<div><br />
</div><div>Still not clear? Notice the difference between the input XML Details field and the log message?</div><div><br />
</div><div>Details="Book##VALUE&amp;amp;DEV"&nbsp;</div><div>Details [Book##VALUE&amp;DEV]</div><div><br />
</div><div><div>The Details value in the XML has the ampersand escaped as "&amp;amp;" while the call to XPathReader.getValueAt() returns the attribute value without the escaping. The getFormattedDetails method merrily goes about its job enriching the details string to be "Book VALUE 111111111" but then the code fails when trying to do the replace call:</div><div><br />
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; xml = xml.replace("Details=\"" + details + "\"", "Details=\"" + mappedDetails + "\"");</div><div><br />
</div><div>The contents of the details variable are now "Book##VALUE&amp;DEV" instead of the original "Book##VALUE&amp;amp;DEV" so no replacement is performed. Given that this code is due to be replaced shortly the quick and easy fix is to use the Apache commons-lang StringEscapeUtils.escapeXml() method. Thus the replace call becomes:</div><div><br />
</div><div>&nbsp; &nbsp; &nbsp; &nbsp; xml = xml.replace("Details=\"" + StringEscapeUtils.escapeXml(details) + "\"", "Details=\""</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + StringEscapeUtils.escapeXml(mappedDetails) + "\"");</div><div><br />
</div><div>The alternative (and more correct solution) would be to convert the XML to an object using your favourite XML library and then perform the data manipulation on the object before converting back to XML.</div></div></li><li>
        <span class="post-meta">Sep 27, 2011</span>
        <h3>
          <a class="post-link" href="/2011/09/27/bash-script-to-extract-range-of.html">
            Bash script to extract a range of revision diffs
          </a>
        </h3>A quick Bash script hack to extract all CVS/SVN diffs from a range of revisions:<br />
<br />
for start_ver in {1..25};<br />
do end_ver=`echo "$start_ver + 1" | bc`;<br />
cvs diff -kk -c -r 1.$start_ver -r 1.$end_ver source.file &gt;&gt; diff_output.txt;<br />
done;<br />
<br />
This script will incrementally extract all differences between version 1.1 and 1.26 and write them to the diff_output.txt file. Incremental in this context means changes between each revision, so the output will contain the diff between version 1.1 and 1.2 followed by the diff between 1.2 and 1.3, then 1.3 and 1.4 etc.<br />
<br />
A few notes (as always):<br />
<br />
<ul><li>The script should be run in the directory containing the file the diff is being run for (source.file in the example)</li>
<li>The physical revision numbers can be replaced with tags (assuming sequential numerical naming of the tags)</li>
<li>The diff options (-kk -c) can be changed for the required diff output format</li>
<li>This was a quick hack and can almost certainly be improved</li>
</ul></li><li>
        <span class="post-meta">Sep 8, 2011</span>
        <h3>
          <a class="post-link" href="/2011/09/08/generating-sql-insert-commands-using.html">
            Generating SQL insert commands using SELECT
          </a>
        </h3>A quick hack for generating a list of SQL insert commands from an existing data set. Useful for copying specific data between databases/tables.<br />
<br />
select 'insert into DestTable values(''' + Value1 + ''',''' + Value2 + ''')' from SourceTable<br />
<br />
This query will return a result set in the format:<br />
insert into DestTable values('a','b')<br />
insert into DestTable values('x','y')<br />
<br />
A few notes:<br />
<ul><li>The '+' might need to be replaced with a concat function on certain databases.</li>
<li>A convert or cast operation may be required for non-character values</li>
<li>The result set can be limited by adding a where class to the select query</li>
</ul></li><li>
        <span class="post-meta">Jul 20, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/20/forcing-xstream-to-use-reflection-for.html">
            Forcing XStream to use reflection for serialization
          </a>
        </h3><a href="http://xstream.codehaus.org/">XStream</a> is a fantastic library for serialising objects to XML, this (very short) post explains how to force reflection on classes implementing the Externalizable interface. The code below is the typical usage of XStream to serialise an object<br />
<br />
<blockquote>XStream xstream = new XStream();<br />
System.out.println(xstream.toXML(someObject);</blockquote><br />
Unfortunately if someObject implements Externalizable then the output XML looks something like:<br />
<blockquote>&lt;com.blogspot.deplication.SomeObject&gt;<br />
&nbsp; &nbsp; &lt;boolean&gt;true&lt;/boolean&gt;<br />
&nbsp; &nbsp; &lt;int&gt;1234213&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;int&gt;20163&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;int&gt;0&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;int&gt;4211&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;int&gt;32321981&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;int&gt;1233&lt;/int&gt;<br />
&nbsp; &nbsp; &lt;boolean&gt;true&lt;/boolean&gt;<br />
&lt;/com.blogspot.deplication.SomeObject&gt;</blockquote><br />
To fix this, the priority of the ReflectionConverter needs to be increased as by default it is the last converter called when trying to serialise the object.<br />
<blockquote>XStream xstream = new XStream();<br />
ReflectionConverter reflectionConverter = new ReflectionConverter(<br />
&nbsp; &nbsp; new CachingMapper(xstream.getMapper()), xstream.getReflectionProvider());<br />
xstream.registerConverter(reflectionConverter, XStream.PRIORITY_LOW);<br />
System.out.println(xstream.toXML(someObject);</blockquote><br />
This code results in the more friendly XML output:<br />
<br />
<blockquote>&lt;com.blogspot.deplication.SomeObject&gt;<br />
&nbsp; &nbsp; &lt;__id&gt;1234213&lt;/__id&gt;<br />
&nbsp; &nbsp; &lt;__tradeId&gt;20163&lt;/__tradeId&gt;<br />
&nbsp; &nbsp; &lt;__linkedTradeId&gt;0&lt;/__linkedTradeId&gt;<br />
&nbsp; &nbsp; &lt;__bookId&gt;4211&lt;/__bookId&gt;<br />
&nbsp; &nbsp; &lt;__productId&gt;32321981&lt;/__productId&gt;<br />
&nbsp; &nbsp; &lt;__eventConfigId&gt;1233&lt;/__eventConfigId&gt;<br />
&lt;/com.blogspot.deplication.SomeObject&gt;</blockquote></li><li>
        <span class="post-meta">Jul 18, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/18/java-application-patch-deployment.html">
            Java application patch deployment
          </a>
        </h3>This post explains a few mechanisms for deploying patches to production Java applications whilst trying to minimise downtime and user impact.<br />
<br />
<b>Class path update</b><br />
The simplest deployment is to create a new JAR file with the patched classes in the correct package structure and add it to the front of the class path used to start the application. So for example if your application was started with the following command:<br />
<blockquote>java -cp application.jar:somelib.jar com.blogspot.deplication.MainClass</blockquote>&nbsp;You could modify it as below to use the patched versions of your classes in the patch.jar file:<br />
<blockquote>java -cp patch.jar:application.jar:somelib.jar com.blogspot.deplication.MainClass</blockquote>This is the basic class path functionality inherent to Java and enables the loading of the patch classes from the patch.jar before the application.jar because patch.jar occurs first in the class path. This is the simplest deployment and requires the application to be restarted with the new class path for the patch to take effect.<br />
<br />
As the application needs to be restarted for this change to take effect, there is not much of a case for this approach over a full deployment. This approach does however allow you to override classes in one of the other JAR files, which may be useful for deploying a version of a class with additional logging (for example) without the need for a full deployment. Once the log data has been generated the patch file can be removed and the application restarted as its original deployment.<br />
<br />
<b>Class file deployment</b><br />
The second option is to deploy compiled class files to a directory specified in the class path. This approach is almost identical to the class path update method but does not require the command line or class path environment variable to be updated with the new patch JAR file name. So for example, starting the application with the following command:<br />
<blockquote>java -cp .:application.jar:somelib.jar com.blogspot.deplication.MainClass</blockquote>Would allow new classes to be copied to the correct package structure in the working directory and after restart the patch class would be used. In this case, copying a new MainClass to ./com/blogspot/deplication/ would result in the class in the directory being used instead of the version in the application.jar.&nbsp;Once again, this approach requires a restart to take effect and has the added complexity of keeping track of the individual class files rather than just the patch JAR file.<br />
<br />
<b>Dynamic class reloading</b><br />
The third option is the implementation of a custom class loader to enable<br />
<a href="http://tutorials.jenkov.com/java-reflection/dynamic-class-loading-reloading.html">dynamic class reloading</a>. Unfortunately this option requires code changes and imposes various restrictions where the classes being loaded either need to extend a super class or implement an interface.<br />
<br />
<b>Interesting points</b><br />
<br />
<ul><li>The class path and class file deployment can be quite useful on distributed systems where only a single VM requires the patched files and the nodes can be stopped and restarted independently.</li>
<li>Remember to cleanup the deployed classes/JARs when doing a full deployment to prevent them from overriding the new code</li>
<li>Solaris (and apparently AIX) may use memory mapped JAR files, expect very strange behaviour if you replace the JAR files in a running VM on these platforms</li>
<li>For configurable applications that use reflection to load classes it is possible to deploy a patched class with a new (unique) name and configure the application to use the new class, thus avoiding the need for a restart</li>
<li>Client applications launched via Java Web Start can be updated by adding the patch jar at the top of the resources section, the main="true" attribute must be excluded for the order of the resources to be used in Java 1.6</li>
<li>Overriding classes using the class path is far from ideal and should be avoided where possible</li>
</ul><div>As always there are almost certainly different approaches, feel free to add comments with what has worked for you.</div></li><li>
        <span class="post-meta">Jul 16, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/16/bash-script-to-automate-report-checking.html">
            Bash script to automate report checking
          </a>
        </h3>The script below is a convenient hack to automate manual report checking. It requires uuencode and mailx (or equivalents) to be installed and uses the regular expression provided on the command line to check if the occurrences are greater than the specified number. This allows for a number of convenient checks:<br />
<br />
<ul><li>Using "$" as the regex and a count of 1 prevents empty reports from being sent. The count can be changed to 2 if the report has a header line even when it has no results.</li>
<li>A specific condition can be matched, for example using a regex of "Match this text" to email the report only if the text appears in the report.</li>
</ul><br />
As always, there are multiple ways of solving the problem. This was a quick an convenient script to allow multiple reports to be checked and mailed to different recipients under different conditions.<br />
<br />
<blockquote>#!/bin/bash<br />
# Shell script for checking a named (text) report for a number of occurrences of a <br />
# search if the search string is found at least the number of times specified then <br />
# the report is mailed to the specified email list<br />
#<br />
# Usage example:<br />
# This command will check the report.csv report for any entries ($REPORT_DIR needs <br />
# to be set):<br />
# ./check_report.sh report.csv "$" 1 my.email@address "Email Subject"<br />
<br />
cd $REPORT_DIR<br />
<br />
if [ -e $1 ]; then<br />
&nbsp; &nbsp; COUNT=`grep -c "$2" "$1"`<br />
&nbsp; &nbsp; if [ $COUNT -gt $3 ]; then<br />
&nbsp; &nbsp; &nbsp; &nbsp; uuencode "$1" "$1" | mailx -s "Check Report $5" "$4" &gt; /dev/null<br />
&nbsp; &nbsp; fi<br />
fi</blockquote></li><li>
        <span class="post-meta">Jul 13, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/13/importance-of-choosing-right-data.html">
            The importance of choosing the right data structure
          </a>
        </h3>A data structure is used for storing and organising data in system. Selecting the correct data structure for a particular problem is an important part of software design and will influence efficiency and maintainability of the code. This post&nbsp;demonstrates the importance of data structure selection&nbsp;with a contrived problem posed in a technical interview and a real world application.<br />
<br />
<blockquote>The problem posed is as follows. Imagine you have a list of unsorted positive integers greater than zero. The list can be of arbitrary size but your algorithm must cater for extremely large lists (think millions or hundreds of millions of items). The list consists of items such that the number of occurrences of any particular integer is always even. One (and only one) integer in the list has an odd number of occurrences, how would you find that integer?<br />
<br />
So for example, the list consisting of the following integers<br />
<br />
5, 73, 8, 24, 24, 5, 73, 1, 24, 24, 5, 1, 8<br />
<br />
has 5 as the number occurring an odd number of times (3 in this case but could be any odd number).</blockquote><br />
This is a great interview question as it allows the interviewer to get a feel for how an applicant approaches a problem and opens up various other branches of investigation. For example the applicants knowledge of algorithm efficiency (<a href="http://en.wikipedia.org/wiki/Big_O_notation">Big O notation</a>) and sorting algorithms can be explored.<br />
<br />
The key point in solving the problem revolves around how many times each of the items needs to be accessed to find a solution:<br />
<ul><li>Every item needs to be visited at least once, no conclusion can be drawn until the last number is known.</li>
<li>There is no benefit to sorting the items, after sorting the problem is not solved and it will have incurred the additional cost of sorting</li>
<li>Using a map is not efficient for extremely large inputs and still requires an additional step for iterating over each of the unique values to check oddness</li>
</ul><br />
The ideal data structure to solve the problem is actually a Set. For each item add it to the set if it is not already present, if it is present the remove it, after processing all the items the set will contain the integer occurring an odd number of times. Ironically (for a post about data structures) there is an even simpler algebraic solution to the problem, performing a bitwise XOR (the ^ operator in Java) on all the input numbers results in the same solution without the use of a data structure.&nbsp;As stated above this example is contrived specifically for use in technical interviews, a real world application of data structure selection is as follows.<br />
<br />
A functional requirement for a critical component of the system is that no two threads try and update an object (with a unique identifier) simultaneously. The system is multi-threaded and event driven, with certain events triggering the object updates. Simultaneous updates would result in a version exception and require manual intervention to correct. An initial (optimistic) solution is to add the synchronized keyword to the method responsible for performing the update, thus ensuring sequential execution of updates. While this approach should work as desired it incurs the cost of class level locking and prevents any kind of concurrency, even for update requests to distinct objects which could actually be executed in parallel. This raises the non-functional requirement of the component namely performance.<br />
<br />
The component is responsible for cash movements in the system and at peak times can have thousands of events generated every second. While there is no real-time requirement, the delay introduced by the synchronized method could lead to the last events being processed minutes after they were received, a situation that was not acceptable to the business. After closer investigation it was identified that in the worst case only a fraction of the updates would ever attempt simultaneous updates. To restate the problem, how can duplicate requests be blocked while allowing distinct requests to process concurrently?<br />
<br />
<pre class="brush: java">public class LockTest {
  protected static Set&lt;Integer&gt; ID_LOCK = Collections.synchronizedSet(new TreeSet&lt;Integer&gt;()); </li><li>
        <span class="post-meta">Jul 12, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/12/handling-raw-type-and-type-safety.html">
            Handling raw type and type safety warnings when using legacy code
          </a>
        </h3>The addition of generics to Java 5 enabled type checking at compile time. This assists in preventing a ClassCastException at runtime but to maintain backward compatibility generics also came with <a href="http://download.oracle.com/javase/tutorial/java/generics/erasure.html%22">Type Erasure</a>:<br />
<blockquote>Type erasure exists so that new code may continue to interface with legacy code. Using a raw type for any other reason is considered bad programming practice and should be avoided whenever possible.<br />
<br />
When mixing legacy code with generic code, you may encounter warning messages similar to the following:<br />
<br />
Note: WarningDemo.java uses unchecked or unsafe operations.<br />
Note: Recompile with -Xlint:unchecked for details.</blockquote><br />
Unfortunately for projects with large legacy code bases or dependencies on legacy third party libraries the raw type warnings can be a major irritation if you prefer not to have false-positive warnings. The solution is to add the @SuppressWarnings("rawtypes") annotation which works as expected, telling the compiler to ignore the raw type issue. The problem with this approach (as <a href="http://stackoverflow.com/questions/1130433/how-to-avoid-unchecked-conversion-warning-in-java-if-you-use-legacy-libraries">discussed</a> elsewhere) is that your code ends up having an annotation for each call to the legacy code which in turn reduces readability. Adding @SuppressWarnings({ "unchecked", "rawtypes" }) at the class level will also suppress all the warnings but may unintentionally mask instances that should be flagged as warnings. An alternative approach is provided below.<br />
<br />
Lets assume that you have a legacy code method (which you are not able to change) as defined below:<br />
<pre class="brush: java">/**
     * Retrieve the list of values
     * @return A vector of string values
     */
    public static Vector getValues();
</pre><br />
In your code you would like to use generics to process the returned vector as below:<br />
<pre class="brush: java">public static void main(String[] args) {
        Vector&lt;String&gt; safeVector = getValues();
        for (String value : safeVector) {
            System.out.println(value);
        }
    }
</pre><br />
Compiling your code gives the "uses unchecked or unsafe operations" warning. Rather than adding the suppress warnings to every line where getValues() is being called you can instead define a wrapper method returning the typed vector as below:<br />
<pre class="brush: java">@SuppressWarnings({ "unchecked", "rawtypes" })
    public static &lt;T&gt; Vector&lt;T&gt; castType(Vector v) {
        return (Vector&lt;T&gt;) v;        
    }
</pre><br />
This means your code is changed as follows:<br />
<pre class="brush: java">public static void main(String[] args) {
        Vector&lt;String&gt; safeVector = castType(getValues());
        for (String value : safeVector) {
            System.out.println(value);
        }
    }
</pre><br />
The warning messages are no longer a problem and the code functions as expected. A few notes on the implementation:<br />
<br />
<ul><li>The type T is inferred from the Vector&lt;String&gt; declaration, the castType method would work equally well for an integer vector (Vector&lt;Integer&gt;) .</li>
<li>The warning is merely being suppressed, the castType method is not actually checking the type of the vector elements. A runtime exception will occur when accessing an element if the vector passed to the method is not actually of the declared type.</li>
<li>The castType method should only be used when you are certain of the type of elements contained in the vector (restating the above point).</li>
<li>The castType implementation is using vectors to demonstrate the concept but can be extended to other types (or even generalised to use the Collection interface)</li>
<li>An argument can be made against the overhead of castType method call instead of a class level @SuppressWarnings annotation, this implementation merely provides an alternative.</li>
</ul><br />
For completeness the generalised method would look as follows:<br />
<pre class="brush: java">@SuppressWarnings({ "unchecked", "rawtypes" })
    public static &lt;T&gt; Collection&lt;T&gt; castType(Collection v) {
        return (Collection&lt;T&gt;) v;        
    }
</pre></li><li>
        <span class="post-meta">Jul 10, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/10/using-ejb3-timer-service-instead-of.html">
            Using the EJB3 timer service instead of Thread.sleep()
          </a>
        </h3>As with most software development a large amount of effort is spent testing, be it functional or regression. The effort required to coordinate testing increases significantly when integration with external systems is required, particularly if those systems are not part of the same division or organisation. I recently volunteered to assist with reducing this overhead for an interface to our payment gateway, this post uses this implementation to demonstrate the use of the EJB 3 timer service for delaying processing.<br /></li><li>
        <span class="post-meta">Jul 10, 2011</span>
        <h3>
          <a class="post-link" href="/2011/07/10/first-post.html">
            First post
          </a>
        </h3>The purpose of this blog is to share information I have found to be useful. Some of the information may be available elsewhere on the net but possibly not in the context it is presented here. The idea for this blog was realised (UK spelling) when considering the focus on consuming and sharing existing information rather than producing potentially original content.<br />
<br />
Given my focus on technology, and more specifically software development, a lot of the posts are likely to have technical content. There is no shortage of arbitrary sharing of inane daily information on the net and while this can be amusing, for the most part it is merely narcissistic and transient. As with all things, I expect the nature of this blog to change over time, hopefully improving as it changes.</li></ul>

    </div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
                11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
                13.806c0-1.21.983-2.195 2.194-2.195zM10.606
                16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
              />
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Simpler is better.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
